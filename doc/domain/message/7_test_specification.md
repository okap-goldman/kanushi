# ダイレクトメッセージ機能のテスト仕様

このドキュメントでは、ダイレクトメッセージ機能のテスト仕様を定義します。ユニットテスト、統合テスト、UIテストのそれぞれについて詳細に記述します。

## 1. ユニットテスト

### 1.1 リポジトリテスト

#### 1.1.1 MessageRepositoryImplのテスト

| テストケース名 | 内容 | 期待される結果 |
|-------------|-----|--------------|
| `getMessages_オンライン_成功` | オンライン状態でメッセージを取得 | 正しいメッセージリストが返される |
| `getMessages_オフライン_キャッシュあり` | オフライン状態でキャッシュから取得 | キャッシュされたメッセージリストが返される |
| `getMessages_オフライン_キャッシュなし` | オフライン状態でキャッシュなし | CacheFailureが返される |
| `getMessages_サーバーエラー` | サーバーがエラーを返す | ServerFailureが返される |
| `sendMessage_オンライン_成功` | オンライン状態でメッセージを送信 | 送信されたメッセージEntityが返される |
| `sendMessage_オフライン` | オフライン状態でメッセージを送信 | NetworkFailureが返される |
| `sendMessage_サーバーエラー` | サーバーがエラーを返す | ServerFailureが返される |
| `editMessage_オンライン_成功` | オンライン状態でメッセージを編集 | 編集されたメッセージEntityが返される |
| `editMessage_権限なし` | 他人のメッセージを編集 | PermissionFailureが返される |
| `deleteMessage_オンライン_成功` | オンライン状態でメッセージを削除 | 成功を示すbooleanが返される |
| `markAsRead_オンライン_成功` | オンライン状態で既読マーク | 既読状態が返される |
| `addReaction_オンライン_成功` | オンライン状態でリアクション追加 | リアクションEntityが返される |
| `removeReaction_オンライン_成功` | オンライン状態でリアクション削除 | 成功を示すbooleanが返される |

#### 1.1.2 ConversationRepositoryImplのテスト

| テストケース名 | 内容 | 期待される結果 |
|-------------|-----|--------------|
| `getConversations_オンライン_成功` | オンライン状態で会話リスト取得 | 正しい会話リストが返される |
| `getConversations_オフライン_キャッシュあり` | オフライン状態でキャッシュから取得 | キャッシュされた会話リストが返される |
| `getConversationById_オンライン_成功` | オンライン状態で特定の会話を取得 | 正しい会話Entityが返される |
| `getConversationById_存在しない` | 存在しない会話IDを指定 | NotFoundFailureが返される |
| `createConversation_オンライン_成功` | オンライン状態で会話を作成 | 作成された会話Entityが返される |
| `createConversation_無効なパラメータ` | 無効なパラメータで会話作成 | ValidationFailureが返される |
| `updateConversationStatus_オンライン_成功` | オンライン状態でステータス更新 | 更新された会話Entityが返される |
| `deleteConversation_オンライン_成功` | オンライン状態で会話を削除 | 成功を示すbooleanが返される |

#### 1.1.3 MediaRepositoryImplのテスト

| テストケース名 | 内容 | 期待される結果 |
|-------------|-----|--------------|
| `uploadMedia_オンライン_成功` | オンライン状態でメディアをアップロード | メディア添付Entityが返される |
| `uploadMedia_オフライン` | オフライン状態でメディアをアップロード | NetworkFailureが返される |
| `uploadMedia_ファイル容量超過` | 大きすぎるファイルをアップロード | ValidationFailureが返される |
| `uploadMedia_不正なファイル形式` | サポートされていない形式 | ValidationFailureが返される |

### 1.2 ユースケーステスト

#### 1.2.1 GetMessagesUseCaseのテスト

| テストケース名 | 内容 | 期待される結果 |
|-------------|-----|--------------|
| `call_正常系` | 通常のパラメータでユースケースを呼び出す | リポジトリの結果が正しく返される |
| `call_異常系` | リポジトリがFailureを返す場合 | 同じFailureが返される |

#### 1.2.2 SendMessageUseCaseのテスト

| テストケース名 | 内容 | 期待される結果 |
|-------------|-----|--------------|
| `call_テキストのみ` | テキストのみのメッセージを送信 | リポジトリの結果が正しく返される |
| `call_メディア添付あり` | メディア添付ありのメッセージを送信 | リポジトリの結果が正しく返される |
| `call_引用返信あり` | 引用返信ありのメッセージを送信 | リポジトリの結果が正しく返される |
| `call_空のコンテンツ` | 空のコンテンツで送信 | ValidationFailureが返される |

#### 1.2.3 CreateConversationUseCaseのテスト

| テストケース名 | 内容 | 期待される結果 |
|-------------|-----|--------------|
| `call_1対1の会話` | 1対1の会話を作成 | リポジトリの結果が正しく返される |
| `call_グループ会話` | グループ会話を作成 | リポジトリの結果が正しく返される |
| `call_参加者不足` | 参加者が不足している場合 | ValidationFailureが返される |

### 1.3 ビューモデルテスト

#### 1.3.1 MessageViewModelのテスト

| テストケース名 | 内容 | 期待される結果 |
|-------------|-----|--------------|
| `getMessages_初回読み込み` | 初回のメッセージ読み込み | メッセージリストが更新され、ロード状態が適切に変化 |
| `getMessages_追加読み込み` | 追加のメッセージ読み込み | 既存リストに追加され、状態が適切に変化 |
| `getMessages_エラー` | エラーが発生した場合 | エラー状態が適切に設定される |
| `sendMessage_成功` | メッセージの送信が成功 | 送信状態が適切に変化 |
| `sendMessage_失敗` | メッセージの送信が失敗 | エラー状態が適切に設定される |
| `editMessage_成功` | メッセージの編集が成功 | 該当メッセージが更新される |
| `deleteMessage_成功` | メッセージの削除が成功 | 該当メッセージが削除される |
| `addReaction_成功` | リアクション追加が成功 | 該当メッセージのリアクションが更新される |
| `removeReaction_成功` | リアクション削除が成功 | 該当メッセージのリアクションが更新される |

#### 1.3.2 ConversationViewModelのテスト

| テストケース名 | 内容 | 期待される結果 |
|-------------|-----|--------------|
| `getConversations_初回読み込み` | 初回の会話リスト読み込み | 会話リストが更新され、ロード状態が適切に変化 |
| `getConversations_追加読み込み` | 追加の会話読み込み | 既存リストに追加され、状態が適切に変化 |
| `getConversations_エラー` | エラーが発生した場合 | エラー状態が適切に設定される |
| `createConversation_成功` | 会話作成が成功 | 会話リストが更新される |
| `updateConversationStatus_成功` | ステータス更新が成功 | 該当会話が更新される |
| `deleteConversation_成功` | 会話削除が成功 | 該当会話が削除される |

### 1.4 モデルテスト

#### 1.4.1 MessageModelのテスト

| テストケース名 | 内容 | 期待される結果 |
|-------------|-----|--------------|
| `fromJson_標準的なJSON` | 標準的なJSONからのデコード | 正しいMessageModelインスタンスが生成される |
| `fromJson_最小限のJSON` | 最小限のフィールドのJSONからのデコード | デフォルト値が適切に設定されたインスタンスが生成される |
| `fromJson_すべてのフィールド含むJSON` | すべてのフィールドを含むJSONからのデコード | すべての値が正しく設定されたインスタンスが生成される |
| `toJson_変換` | MessageModelからJSONへの変換 | 正しいJSON形式のMapが返される |
| `toEntity_変換` | MessageModelからEntityへの変換 | 正しいEntityインスタンスが返される |

#### 1.4.2 ConversationModelのテスト

| テストケース名 | 内容 | 期待される結果 |
|-------------|-----|--------------|
| `fromJson_1対1の会話` | 1対1の会話JSONからのデコード | タイプがDIRECTに設定されたインスタンスが生成される |
| `fromJson_グループ会話` | グループ会話JSONからのデコード | タイプがGROUPに設定されたインスタンスが生成される |
| `toJson_変換` | ConversationModelからJSONへの変換 | 正しいJSON形式のMapが返される |
| `toEntity_変換` | ConversationModelからEntityへの変換 | 正しいEntityインスタンスが返される |

## 2. 統合テスト

### 2.1 APIとの統合テスト

#### 2.1.1 MessageRemoteDataSourceImpl統合テスト

| テストケース名 | 内容 | 期待される結果 |
|-------------|-----|--------------|
| `getMessages_有効なレスポンス` | APIが有効な応答を返す場合 | 正しいMessageModelリストが返される |
| `getMessages_エラーレスポンス` | APIがエラー応答を返す場合 | ServerExceptionがスローされる |
| `sendMessage_有効なレスポンス` | APIが有効な応答を返す場合 | 正しいMessageModelが返される |
| `sendMessage_エラーレスポンス` | APIがエラー応答を返す場合 | ServerExceptionがスローされる |

#### 2.1.2 ConversationRemoteDataSourceImpl統合テスト

| テストケース名 | 内容 | 期待される結果 |
|-------------|-----|--------------|
| `getConversations_有効なレスポンス` | APIが有効な応答を返す場合 | 正しいConversationModelリストが返される |
| `getConversations_エラーレスポンス` | APIがエラー応答を返す場合 | ServerExceptionがスローされる |
| `createConversation_有効なレスポンス` | APIが有効な応答を返す場合 | 正しいConversationModelが返される |
| `createConversation_エラーレスポンス` | APIがエラー応答を返す場合 | ServerExceptionがスローされる |

### 2.2 リアルタイムデータベースとの統合テスト

| テストケース名 | 内容 | 期待される結果 |
|-------------|-----|--------------|
| `listenToNewMessages_受信` | 新しいメッセージイベントを受信 | 正しいMessageModelがストリームに流れる |
| `listenToMessageUpdates_受信` | メッセージ更新イベントを受信 | 更新されたMessageModelがストリームに流れる |
| `listenToMessageDeletions_受信` | メッセージ削除イベントを受信 | 削除されたメッセージIDがストリームに流れる |
| `listenToReactionChanges_受信` | リアクション変更イベントを受信 | 追加/削除されたReactionModelがストリームに流れる |
| `listenToConversationChanges_受信` | 会話変更イベントを受信 | 追加/更新されたConversationModelがストリームに流れる |

### 2.3 ローカルストレージとの統合テスト

| テストケース名 | 内容 | 期待される結果 |
|-------------|-----|--------------|
| `cacheMessages_取得` | メッセージをキャッシュして取得 | キャッシュに保存された通りのメッセージが取得できる |
| `cacheConversations_取得` | 会話をキャッシュして取得 | キャッシュに保存された通りの会話が取得できる |
| `saveMessage_更新_取得` | メッセージを保存、更新、取得 | 最新の状態が取得できる |
| `deleteMessage_取得` | メッセージを削除して取得 | 該当メッセージが取得できない |

## 3. UIテスト

### 3.1 MessageListScreenのテスト

| テストケース名 | 内容 | 期待される結果 |
|-------------|-----|--------------|
| `画面表示_会話リスト` | 画面が初期表示されたとき | 会話リストが表示され、各アイテムが正しく表示される |
| `会話をタップ_遷移` | 会話アイテムをタップ | 対応する会話詳細画面に遷移する |
| `新規メッセージボタンをタップ_遷移` | 新規メッセージボタンをタップ | 新規メッセージ作成画面に遷移する |
| `会話を左スワイプ_アーカイブ` | 会話を左にスワイプしてアーカイブ | 会話がアーカイブされ、リストから消える |
| `プルダウン_更新` | 画面を下にプルダウン | 会話リストが更新される |
| `スクロール_追加読み込み` | リストの最下部までスクロール | 追加の会話が読み込まれる |
| `検索キーワード入力_フィルタリング` | 検索ボックスにキーワードを入力 | 該当する会話のみが表示される |
| `アーカイブされた会話を表示` | アーカイブタブに切り替え | アーカイブされた会話のみが表示される |

### 3.2 ConversationDetailScreenのテスト

| テストケース名 | 内容 | 期待される結果 |
|-------------|-----|--------------|
| `画面表示_メッセージリスト` | 画面が初期表示されたとき | メッセージリストが表示され、各メッセージが正しく表示される |
| `テキスト入力_送信` | テキストを入力して送信 | メッセージが送信され、リストに追加される |
| `メディア選択_送信` | メディアを選択して送信 | メディアが添付されたメッセージが送信される |
| `メッセージを長押し_リアクションメニュー` | メッセージを長押し | リアクションメニューが表示される |
| `リアクション選択_表示` | リアクションを選択 | 選択したリアクションが表示される |
| `メッセージを長押し_コンテキストメニュー` | 自分のメッセージを長押し | 編集・削除などのコンテキストメニューが表示される |
| `メッセージをタップ_引用返信` | メッセージを引用返信として選択 | 引用表示され、返信として送信される |
| `スクロール_過去メッセージ読み込み` | リストの最上部までスクロール | 過去のメッセージが読み込まれる |
| `アプリ起動_既読状態更新` | アプリが起動状態で画面表示 | 表示されたメッセージが既読になる |

### 3.3 NewConversationScreenのテスト

| テストケース名 | 内容 | 期待される結果 |
|-------------|-----|--------------|
| `画面表示_ユーザーリスト` | 画面が初期表示されたとき | ユーザーリストが表示される |
| `ユーザー検索_フィルタリング` | 検索ボックスにキーワードを入力 | 該当するユーザーのみが表示される |
| `ユーザー選択_メッセージ入力` | ユーザーを選択 | メッセージ入力画面が表示される |
| `メッセージ入力_送信` | メッセージを入力して送信 | 会話が作成され、会話詳細画面に遷移する |
| `メディア選択_送信` | メディアを選択して送信 | メディアが添付された状態で会話が作成される |
| `複数ユーザー選択_グループ作成` | 複数のユーザーを選択 | グループ名入力画面が表示される |
| `グループ名入力_作成` | グループ名を入力して作成 | グループ会話が作成され、会話詳細画面に遷移する |

## 4. パフォーマンステスト

| テストケース名 | 内容 | 期待される結果 |
|-------------|-----|--------------|
| `メッセージ送信_レイテンシ` | メッセージ送信のレイテンシ測定 | 1秒未満であること |
| `リアルタイム更新_レイテンシ` | メッセージ受信のレイテンシ測定 | 2秒未満であること |
| `過去メッセージ読み込み_レイテンシ` | 過去メッセージ読み込みのレイテンシ測定 | 1ページ（50件）あたり0.5秒未満であること |
| `会話一覧読み込み_レイテンシ` | 会話一覧読み込みのレイテンシ測定 | 0.5秒未満であること |
| `メディアアップロード_レイテンシ` | 画像（1MB）アップロードのレイテンシ測定 | 3秒未満であること |
| `多量メッセージ_スクロールパフォーマンス` | 1000件以上のメッセージがある会話でのスクロール | 滑らかにスクロールできること |
| `多量会話_スクロールパフォーマンス` | 100件以上の会話がある状態でのスクロール | 滑らかにスクロールできること |
| `バックグラウンド同期_通知遅延` | アプリがバックグラウンドの状態での通知遅延 | 5秒未満であること |

## 5. オフラインテスト

| テストケース名 | 内容 | 期待される結果 |
|-------------|-----|--------------|
| `オフライン状態_会話一覧表示` | ネットワーク接続なしで会話一覧を表示 | キャッシュされた会話が表示される |
| `オフライン状態_メッセージ表示` | ネットワーク接続なしでメッセージを表示 | キャッシュされたメッセージが表示される |
| `オフライン状態_メッセージ送信` | ネットワーク接続なしでメッセージを送信 | メッセージが一時保存され、送信待ちの状態が表示される |
| `オフライン→オンライン_メッセージ同期` | オフラインで作成したメッセージの同期 | 接続回復後にメッセージが送信される |
| `オフライン→オンライン_既読状態同期` | オフラインで閲覧したメッセージの既読状態 | 接続回復後に既読状態が同期される |
| `接続不安定_メッセージ送受信` | 接続が不安定な状態での送受信 | メッセージの送受信が正常に行われる |
| `長期オフライン_データ保持` | 72時間以上オフラインの状態 | キャッシュされたメッセージが表示可能である |

## 6. セキュリティテスト

| テストケース名 | 内容 | 期待される結果 |
|-------------|-----|--------------|
| `認証なし_APIアクセス拒否` | 認証なしでAPIにアクセス | アクセスが拒否される |
| `他ユーザーの会話_アクセス拒否` | 他ユーザーの会話にアクセス | アクセスが拒否される |
| `他ユーザーのメッセージ_編集拒否` | 他ユーザーのメッセージを編集 | 編集が拒否される |
| `メッセージ編集期限切れ_編集拒否` | 期限切れのメッセージを編集 | 編集が拒否される |
| `ブロック済みユーザー_メッセージ拒否` | ブロック済みユーザーにメッセージ送信 | 送信が拒否される |
| `データ転送_暗号化確認` | データ転送時の暗号化状態 | 適切に暗号化されている |
| `XSSインジェクション_防止` | メッセージ内にスクリプトを含める | スクリプトが無害化されて表示される |
| `SQLインジェクション_防止` | 不正なSQLを含むクエリを試行 | 適切に処理され、インジェクションが防止される |