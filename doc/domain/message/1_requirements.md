# ダイレクトメッセージ機能要件定義

## 1. 機能概要

ダイレクトメッセージ機能は、Kanushiアプリケーション内でユーザー間のプライベートなコミュニケーションを可能にする機能です。この機能により、ユーザーは特定の個人やグループとタイムライン投稿とは別に非公開のメッセージをやり取りすることができます。また、「覚醒」というアプリのコンセプトに沿って、深い意味のある対話や気づきを促進するための機能も含まれます。

## 2. 主要要件

### 2.1 基本機能
- ユーザー間の1対1のプライベートメッセージ送受信
- メッセージの既読/未読ステータス表示
- テキストメッセージの送信
- 画像、音声、動画などのメディア添付
- 会話の検索機能
- 会話のアーカイブと削除機能

### 2.2 高度な機能
- メッセージのリアクション機能
- メッセージの編集と削除
- 引用返信機能
- メンション機能（@ユーザー名）
- URLのプレビュー表示
- スレッド形式の返信
- 共有コンテンツ（投稿、プロダクト）の埋め込み表示

### 2.3 グループメッセージ機能（フェーズ2）
- 複数ユーザーによるグループ会話
- グループの作成、編集、削除
- グループメンバーの管理（追加、削除）
- グループ情報（名前、アイコン）の設定

### 2.4 プライバシーとセキュリティ
- エンドツーエンド暗号化（フェーズ2）
- メッセージ転送の制限オプション
- スクリーンショット検出と通知
- ブロックされたユーザーからのメッセージ防止
- スパムと不適切なコンテンツの自動検出

### 2.5 通知
- 新着メッセージの通知
- メンション時の特別通知
- 通知設定のカスタマイズ
- ミュート機能

## 3. ユーザーストーリー

1. ユーザーAはユーザーBのプロフィールからメッセージを送信できる
2. ユーザーAはメッセージ一覧画面から過去の会話を閲覧できる
3. ユーザーAはメッセージにリアクションを付けることができる
4. ユーザーAは自分の送信したメッセージを編集または削除できる
5. ユーザーAはメディア（画像、音声、動画）をメッセージに添付できる
6. ユーザーAは他の投稿やコンテンツをメッセージ内で共有できる
7. ユーザーAはメッセージ内のキーワードで過去の会話を検索できる
8. ユーザーAは特定の会話をアーカイブまたは削除できる
9. ユーザーAは通知設定を調整して、メッセージ通知の頻度を制御できる
10. ユーザーAは覚醒レベルに基づいた特別なメッセージフォーマットを使用できる

## 4. ユーザーインターフェース要件

### 4.1 メッセージ一覧画面
- 最近の会話一覧（日時順）
- 未読メッセージのインジケーター
- 最新メッセージのプレビュー表示
- アーカイブ済み会話の区分け表示
- 検索機能

### 4.2 会話詳細画面
- メッセージのバブル表示（送信者と受信者を区別）
- タイムスタンプの表示
- 既読ステータスの表示
- メディア添付のプレビュー
- メッセージ入力エリア
- メディア添付ボタン
- 送信ボタン
- スクロールで過去のメッセージ読み込み

### 4.3 新規メッセージ作成画面
- 受信者選択（検索可能）
- メッセージ作成エリア
- メディア添付オプション
- プレビュー機能
- 送信ボタン

## 5. 技術要件

### 5.1 バックエンド
- リアルタイムメッセージング（Supabaseのリアルタイムデータベース https://supabase.com/docs/guides/realtime）
- メッセージの永続化ストレージ
- プッシュ通知インフラストラクチャ
- スケーラブルなメッセージング処理
- メディアファイルのストレージとCDN配信（Backblaze B2 + Cloudflare CDN）

### 5.2 フロントエンド
- リアルタイム更新UI
- メディアファイルのプレビューとアップロード
- メッセージの状態管理（送信中、送信済み、既読）
- オフライン対応（メッセージのキューイング）
- 効率的なリスト表示（大量のメッセージを扱う場合）

### 5.3 セキュリティ
- データの暗号化（保存時と転送時）
- ユーザー認証と認可
- コンテンツのモデレーション
- レート制限と乱用防止

## 6. データモデル（概要）

### 6.1 会話（Conversation）
- ID
- 参加者リスト
- 作成日時
- 最終更新日時
- タイトル（グループの場合）
- タイプ（1対1またはグループ）
- ステータス（アクティブ、アーカイブ済み）

### 6.2 メッセージ（Message）
- ID
- 会話ID
- 送信者ID
- 内容
- メディア添付（オプション）
- 送信日時
- 更新日時
- ステータス（送信中、送信済み、既読）
- リアクション
- 引用メッセージID（オプション）

### 6.3 既読状態（ReadStatus）
- メッセージID
- ユーザーID
- 既読日時

### 6.4 メディア添付（MediaAttachment）
- ID
- メッセージID
- タイプ（画像、動画、音声、ファイル）
- URL
- サムネイルURL（該当する場合）
- サイズ
- メタデータ

## 7. APIエンドポイント（概要）

### 7.1 会話管理
- 会話一覧の取得
- 会話詳細の取得
- 新規会話の作成
- 会話のアーカイブ/アクティブ化
- 会話の削除

### 7.2 メッセージ管理
- メッセージ一覧の取得（ページネーション）
- メッセージの送信
- メッセージの編集
- メッセージの削除
- メッセージの既読状態の更新
- メッセージへのリアクション追加/削除

### 7.3 メディア管理
- メディアのアップロード
- メディアのダウンロード

### 7.4 検索
- メッセージ内容の検索
- 会話の検索

## 8. 実装フェーズ

### フェーズ1（MVP）
- 1対1のテキストメッセージ
- 基本的なメディア添付（画像のみ）
- 会話一覧と詳細表示
- 基本的な通知

### フェーズ2
- 高度なメディア添付（音声、動画）
- メッセージのリアクション
- 引用返信
- URLプレビュー
- 検索機能の強化

### フェーズ3
- グループメッセージ
- エンドツーエンド暗号化
- メッセージの自動削除機能
- 高度なコンテンツ共有

## 9. パフォーマンス要件

- メッセージ送信のレイテンシ：1秒未満
- リアルタイム更新のレイテンシ：2秒未満
- 過去のメッセージ読み込み：1ページあたり0.5秒未満
- オフライン機能：最低72時間分のメッセージをローカルにキャッシュ

## 10. テスト要件

- ユニットテスト（リポジトリ、ユースケース）
- 統合テスト（APIエンドポイント）
- UIテスト（ユーザーフロー）
- パフォーマンステスト（同時接続数、メッセージ処理速度）
- セキュリティテスト（暗号化、認証）