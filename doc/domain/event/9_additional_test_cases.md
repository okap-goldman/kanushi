# イベントドメイン追加テストケース

以下に、より堅牢なテスト体系を構築するための追加テストケースを示します。これらは前述のレビューで特定された課題と改善点に対応しています。

## 1. 構造的欠陥への対応テスト

### 1.1 日時処理の安定性テスト

| テストID | テスト名 | テスト内容 | 入力パラメータ | 期待される結果 |
|---------|---------|----------|--------------|--------------|
| DT-001 | 固定時刻での開始状態テスト | 時刻提供クラスをモックし固定時刻でhasStartedをテスト | currentTime=2023-01-02T12:00:00Z, event.startsAt=2023-01-02T10:00:00Z | hasStarted=true |
| DT-002 | 固定時刻での未開始状態テスト | 時刻提供クラスをモックし固定時刻でhasStartedをテスト | currentTime=2023-01-02T08:00:00Z, event.startsAt=2023-01-02T10:00:00Z | hasStarted=false |
| DT-003 | 固定時刻での終了状態テスト | 時刻提供クラスをモックし固定時刻でhasEndedをテスト | currentTime=2023-01-02T14:00:00Z, event.endsAt=2023-01-02T12:00:00Z | hasEnded=true |
| DT-004 | 固定時刻での未終了状態テスト | 時刻提供クラスをモックし固定時刻でhasEndedをテスト | currentTime=2023-01-02T10:00:00Z, event.endsAt=2023-01-02T12:00:00Z | hasEnded=false |
| DT-005 | 固定時刻での進行中状態テスト | 時刻提供クラスをモックし固定時刻でisOngoingをテスト | currentTime=2023-01-02T11:00:00Z, event.startsAt=2023-01-02T10:00:00Z, event.endsAt=2023-01-02T12:00:00Z | isOngoing=true |
| DT-006 | タイムゾーン考慮テスト | 異なるタイムゾーンでのイベント表示テスト | event.startsAt=2023-01-02T10:00:00Z, userTimezone=UTC+9 | 現地時間「19:00」と表示される |

### 1.2 複雑なJSONシリアライズテスト

| テストID | テスト名 | テスト内容 | 入力パラメータ | 期待される結果 |
|---------|---------|----------|--------------|--------------|
| JS-001 | 複雑なメタデータシリアライズ | ネストされたメタデータのシリアライズ | metadata={"details": {"sections": [{"title": "セクション1", "capacity": 50}]}} | 正確にシリアライズされたJSON |
| JS-002 | 複雑なメタデータデシリアライズ | ネストされたメタデータのデシリアライズ | JSONに複雑なmetadataオブジェクト | 正確にデシリアライズされたオブジェクト |
| JS-003 | 特殊文字を含むテキストシリアライズ | 特殊文字を含むテキストフィールドのシリアライズ | description="改行\nタブ\t特殊文字：\u3042\u3044\u3046" | エスケープされた文字を含む正確なJSON |
| JS-004 | 巨大テキストシリアライズ | 非常に長いテキストフィールドのシリアライズ | description=10000文字の文字列 | 切り詰めなしで正確にシリアライズ |
| JS-005 | nullフィールド処理 | nullを含む様々なフィールドのシリアライズ | location=null, fee=null | nullが適切に処理されたJSON |

### 1.3 同時操作の整合性テスト

| テストID | テスト名 | テスト内容 | 入力パラメータ | 期待される結果 |
|---------|---------|----------|--------------|--------------|
| CC-001 | 同時イベント更新テスト | 同じイベントを2つのクライアントが同時に更新 | client1.version=1, client2.version=1, 両方がname更新 | 後発の更新はバージョンチェックで拒否される |
| CC-002 | 同時参加登録テスト | 定員ぎりぎりのイベントに複数ユーザーが同時参加 | 定員残り1、3人が同時参加リクエスト | 1人のみ成功、他は「定員超過」エラー |
| CC-003 | 楽観的ロック成功テスト | バージョン指定での更新 | currentVersion=2, 更新リクエストのversion=2 | 更新成功、version=3に更新 |
| CC-004 | 楽観的ロック失敗テスト | 古いバージョンでの更新 | currentVersion=3, 更新リクエストのversion=2 | 「バージョン不一致」エラー |

### 1.4 キャッシュ無効化戦略テスト

| テストID | テスト名 | テスト内容 | 入力パラメータ | 期待される結果 |
|---------|---------|----------|--------------|--------------|
| CH-001 | イベント更新後のキャッシュ無効化 | イベント更新後にキャッシュが無効化されるか | イベント更新後に再取得 | 更新内容が反映されたデータ取得 |
| CH-002 | 関連エンティティ更新によるキャッシュ無効化 | 参加者追加後にイベントキャッシュが更新されるか | 参加者追加後にイベント再取得 | 参加者数が増加したデータ取得 |
| CH-003 | キャッシュ有効期限テスト | キャッシュ期限経過後の自動更新 | キャッシュ期限(30分)経過後に取得 | リモートデータソースから再取得 |
| CH-004 | 強制キャッシュ更新テスト | forceRefreshフラグでのキャッシュ無視 | forceRefresh=true | キャッシュが有効でもリモートから取得 |

## 2. ビジネスロジック検証の追加テスト

### 2.1 イベントキャンセルポリシーテスト

| テストID | テスト名 | テスト内容 | 入力パラメータ | 期待される結果 |
|---------|---------|----------|--------------|--------------|
| CP-001 | 早期キャンセル全額返金テスト | イベント7日前のキャンセル処理 | event.startsAt=7日後, キャンセル要求 | 参加取消し+100%返金処理 |
| CP-002 | 中期キャンセル一部返金テスト | イベント3日前のキャンセル処理 | event.startsAt=3日後, キャンセル要求 | 参加取消し+50%返金処理 |
| CP-003 | 直前キャンセル返金なしテスト | イベント前日のキャンセル処理 | event.startsAt=1日後, キャンセル要求 | 参加取消し+返金なし |
| CP-004 | 開始後キャンセル禁止テスト | 開始済みイベントのキャンセル | event.hasStarted=true, キャンセル要求 | 「開始後のキャンセル不可」エラー |
| CP-005 | カスタムポリシーテスト | イベント独自のキャンセルポリシー適用 | refundPolicy="5日前までは全額、3日前までは50%" | ポリシーに従った返金処理 |

### 2.2 定員管理テスト

| テストID | テスト名 | テスト内容 | 入力パラメータ | 期待される結果 |
|---------|---------|----------|--------------|--------------|
| CM-001 | 定員内参加テスト | 定員に余裕があるイベントへの参加 | event.capacity=100, currentParticipants=90, 参加要求 | 参加成功 |
| CM-002 | 定員ちょうど参加テスト | 定員ぎりぎりの参加処理 | event.capacity=100, currentParticipants=99, 参加要求 | 参加成功+「残り0名」表示 |
| CM-003 | 定員超過参加テスト | 定員超過時の参加処理 | event.capacity=100, currentParticipants=100, 参加要求 | 「定員超過」エラー |
| CM-004 | 待機リスト登録テスト | 定員超過時の待機リスト登録 | 定員超過状態, waitingList=true | 待機リスト登録成功 |
| CM-005 | 待機リスト繰り上がりテスト | キャンセル発生時の待機者繰り上がり | キャンセル発生, 待機者あり | 待機者への通知+参加者登録 |
| CM-006 | 定員なしイベントテスト | 定員制限のないイベント処理 | event.capacity=null, 参加要求 | 制限なしで参加可能 |

### 2.3 料金階層テスト

| テストID | テスト名 | テスト内容 | 入力パラメータ | 期待される結果 |
|---------|---------|----------|--------------|--------------|
| PT-001 | 早期割引適用テスト | 早期予約割引の適用確認 | イベント開始30日以上前の参加登録 | 通常料金の80%で計算 |
| PT-002 | 会員割引適用テスト | 会員ステータスによる割引適用 | user.membershipLevel="premium" | 通常料金の90%で計算 |
| PT-003 | 複数割引併用テスト | 複数の割引条件が重なる場合 | 早期予約+会員 | 最も有利な割引が適用 |
| PT-004 | グループ割引テスト | 5名以上のグループ参加割引 | 同時に5名分の参加登録 | 1人あたり通常料金の85%で計算 |
| PT-005 | 料金区分選択テスト | 複数料金区分からの選択 | "一般"/"学生"/"シニア"から選択 | 選択した区分の料金が適用 |
| PT-006 | プロモーションコードテスト | 割引コード適用 | promoCode="EVENT2023" | コードに応じた割引適用 |

## 3. 異常系テスト強化

### 3.1 部分的失敗の回復テスト

| テストID | テスト名 | テスト内容 | 入力パラメータ | 期待される結果 |
|---------|---------|----------|--------------|--------------|
| PF-001 | 参加登録成功・決済失敗テスト | 参加登録後の決済処理失敗 | 参加登録成功、決済失敗 | 参加ステータス="仮登録"+再決済オプション |
| PF-002 | 決済成功・参加更新失敗テスト | 決済成功後の参加ステータス更新失敗 | 決済成功、DB更新失敗 | 管理者通知+自動復旧処理 |
| PF-003 | 部分キャンセルテスト | 参加キャンセル成功・返金処理失敗 | キャンセル成功、返金処理失敗 | エラーログ+管理者通知+手動返金フラグ |
| PF-004 | トランザクション全体失敗テスト | 複数操作の全体トランザクション失敗 | トランザクション内の複数操作 | 全ての操作がロールバック |
| PF-005 | 処理再開テスト | 中断した処理の再開機能 | 中断状態から処理再開 | 中断したポイントから処理再開 |

### 3.2 エラー分類と処理テスト

| テストID | テスト名 | テスト内容 | 入力パラメータ | 期待される結果 |
|---------|---------|----------|--------------|--------------|
| ET-001 | 一時的ネットワークエラー処理 | 一時的なネットワーク断からの回復 | ネットワーク一時切断→復帰 | 自動リトライで処理完了 |
| ET-002 | 永続的ネットワークエラー処理 | 長時間のネットワーク断 | ネットワーク切断5分以上 | エラー表示+手動リトライオプション |
| ET-003 | 認証エラー処理 | 認証切れ時の処理 | 認証トークン期限切れ | 再認証要求+処理再開 |
| ET-004 | サーバーエラー処理 | サーバー側500エラー時の処理 | サーバー500エラー応答 | エラー表示+リトライポリシー適用 |
| ET-005 | バリデーションエラー詳細表示 | 複数のバリデーションエラー時の表示 | 3つのフィールドでバリデーションエラー | 全エラーを明示的に表示 |
| ET-006 | オフライン操作の遅延処理 | オフライン時の操作と同期 | オフライン状態で参加登録→オンライン復帰 | オンライン復帰時に自動同期 |

### 3.3 権限管理詳細テスト

| テストID | テスト名 | テスト内容 | 入力パラメータ | 期待される結果 |
|---------|---------|----------|--------------|--------------|
| AM-001 | 作成者フル権限テスト | イベント作成者の全権限確認 | user.id=event.creatorUserId | 全操作（編集/削除/キャンセル処理など）可能 |
| AM-002 | 共同ホスト編集権限テスト | 共同ホストの編集権限確認 | user.id=coHost.userId | 編集可能/削除不可 |
| AM-003 | 一般参加者制限テスト | 一般参加者の制限確認 | user=一般参加者 | 閲覧のみ可能/編集不可 |
| AM-004 | 権限昇格拒否テスト | 不正な権限昇格試行 | 一般ユーザーによる管理操作API直接呼出し | 403エラー応答 |
| AM-005 | 管理者権限テスト | 管理者の全権限確認 | user.role="admin" | 全イベントに対する管理権限 |
| AM-006 | 非公開イベントアクセス制限テスト | 非公開イベントへのアクセス制御 | event.isPublic=false, user=未招待ユーザー | アクセス拒否 |

### 3.4 決済情報保護テスト

| テストID | テスト名 | テスト内容 | 入力パラメータ | 期待される結果 |
|---------|---------|----------|--------------|--------------|
| SP-001 | カード情報非保存テスト | カード情報が保存されないことを確認 | カード番号入力→決済処理 | DBにカード番号が保存されない |
| SP-002 | カード情報トークン化テスト | カード情報がトークン化されることを確認 | カード番号入力→決済処理 | トークンのみがサーバーに送信される |
| SP-003 | カード情報表示マスクテスト | カード情報表示の一部マスク | 保存済みカード表示 | 下4桁のみ表示、他はマスク |
| SP-004 | 決済情報暗号化テスト | 保存される決済情報の暗号化 | 決済処理完了→DB保存 | 関連情報が暗号化されて保存 |
| SP-005 | 決済失敗時の情報取扱テスト | 失敗した決済の情報取扱い | 決済失敗時 | センシティブ情報がログに記録されない |

## 4. プラットフォーム特有のテスト

### 4.1 アプリライフサイクルテスト

| テストID | テスト名 | テスト内容 | 入力パラメータ | 期待される結果 |
|---------|---------|----------|--------------|--------------|
| AL-001 | バックグラウンド移行テスト | アプリがバックグラウンドに移行した時の状態保存 | アプリのバックグラウンド移行 | 状態が保存される |
| AL-002 | フォアグラウンド復帰テスト | バックグラウンドからの復帰時の状態復元 | バックグラウンドからの復帰 | 状態が正確に復元される |
| AL-003 | 長時間バックグラウンドテスト | 長時間バックグラウンド後の復帰 | 30分以上バックグラウンド→復帰 | 状態復元+データ再検証 |
| AL-004 | アプリ強制終了からの復帰テスト | アプリが強制終了された場合の復帰 | アプリ強制終了→再起動 | 最後の状態を可能な限り復元 |
| AL-005 | バックグラウンド処理テスト | バックグラウンドでの処理継続 | バックグラウンド中の通知受信 | 適切に処理される |

### 4.2 リソース制約テスト

| テストID | テスト名 | テスト内容 | 入力パラメータ | 期待される結果 |
|---------|---------|----------|--------------|--------------|
| RC-001 | 低メモリ環境テスト | メモリ制約環境での動作 | メモリ警告発生時 | 非重要リソースの解放+動作継続 |
| RC-002 | ストレージ制約テスト | ストレージ残量少時の動作 | ストレージ残量警告時 | キャッシュ削減+必須操作の継続 |
| RC-003 | 低バッテリーモードテスト | 低バッテリーモードでの動作 | バッテリー残量20%以下 | バックグラウンド処理削減+節電対応 |
| RC-004 | 低速ネットワークテスト | 低速ネットワーク環境での動作 | 2G/低速接続環境 | 軽量モード切替+必須機能維持 |
| RC-005 | オフラインモード切替テスト | オンライン→オフライン→オンラインの遷移 | ネットワーク切断→復帰 | 適切なモード切替+データ同期 |

### 4.3 デバイス連携テスト

#### 4.3.1 カレンダー統合テスト

| テストID | テスト名 | テスト内容 | 入力パラメータ | 期待される結果 |
|---------|---------|----------|--------------|--------------|
| CL-001 | カレンダーイベント作成テスト | イベント参加時のカレンダー登録 | イベント参加+カレンダー連携許可 | デバイスカレンダーに登録される |
| CL-002 | カレンダーイベント更新テスト | イベント詳細変更時のカレンダー更新 | イベント詳細変更 | カレンダーイベントも更新される |
| CL-003 | カレンダーイベント削除テスト | イベントキャンセル時のカレンダー削除 | イベント参加キャンセル | カレンダーイベントも削除される |
| CL-004 | カレンダー権限拒否時テスト | カレンダー権限が拒否された場合 | カレンダー権限=拒否 | エラー表示+手動追加手順提示 |
| CL-005 | 複数カレンダー選択テスト | 複数カレンダー存在時の選択 | 複数カレンダー構成 | カレンダー選択UIが表示される |

#### 4.3.2 位置情報サービステスト

| テストID | テスト名 | テスト内容 | 入力パラメータ | 期待される結果 |
|---------|---------|----------|--------------|--------------|
| LC-001 | 地図表示テスト | イベント場所の地図表示 | event.location=有効な住所 | 正確な位置を地図表示 |
| LC-002 | 経路表示テスト | 現在地からイベント場所への経路表示 | 現在地+イベント場所 | 経路と所要時間表示 |
| LC-003 | 位置ベース検索テスト | 現在位置周辺のイベント検索 | 現在地+半径5km | 範囲内のイベント表示 |
| LC-004 | 位置情報権限拒否テスト | 位置情報アクセス権限が拒否された場合 | 位置情報権限=拒否 | 手動住所入力オプション提供 |
| LC-005 | 位置情報精度テスト | 異なる精度設定での位置表示 | 高精度/低精度/省電力モード | 各モードで適切に表示 |

## 5. 拡張性テスト

### 5.1 大規模データテスト

| テストID | テスト名 | テスト内容 | 入力パラメータ | 期待される結果 |
|---------|---------|----------|--------------|--------------|
| LD-001 | 大量イベント表示テスト | 1000件以上のイベントデータ表示 | 1000件のイベントデータ | ページング/仮想スクロールで円滑表示 |
| LD-002 | 大量イベントフィルタリングテスト | 1000件以上のデータからのフィルタリング | 日付/カテゴリでのフィルタリング | 500ms以内に結果表示 |
| LD-003 | 大量参加者表示テスト | 1000人以上の参加者リスト表示 | 1000人の参加者データ | 遅延読み込みで円滑表示 |
| LD-004 | 長期間イベント一覧テスト | 数年分のイベントデータ表示 | 3年分のイベントデータ | 効率的なナビゲーション提供 |
| LD-005 | 大量データキャッシュ管理テスト | 大量データのキャッシュ管理 | 5000件以上のイベントデータ | 効率的なキャッシュ使用とメモリ管理 |

### 5.2 同時アクセステスト

| テストID | テスト名 | テスト内容 | 入力パラメータ | 期待される結果 |
|---------|---------|----------|--------------|--------------|
| CC-001 | 高負荷同時参加テスト | 人気イベント発売時の同時参加処理 | 100人同時参加リクエスト | 正確な残席管理と整合性維持 |
| CC-002 | サーバー負荷耐性テスト | サーバー高負荷時のアプリ動作 | サーバー応答遅延500ms-1s | タイムアウト適切設定+リトライ機能 |
| CC-003 | スロットリング機能テスト | API呼び出し制限時の動作 | API制限到達時 | 適切なエラー表示+段階的リトライ |
| CC-004 | 大規模プッシュ通知テスト | 多数の同時プッシュ通知処理 | 100件の同時通知 | 正確な処理+パフォーマンス維持 |
| CC-005 | バックグラウンド同期競合テスト | 複数の同期処理の競合 | 複数同期処理同時実行 | 適切な順序管理と競合解決 |

## 6. 国際化とアクセシビリティテスト

### 6.1 国際化テスト

| テストID | テスト名 | テスト内容 | 入力パラメータ | 期待される結果 |
|---------|---------|----------|--------------|--------------|
| I18N-001 | 多言語テキスト表示テスト | 異なる言語設定での画面表示 | 言語設定=英語/日本語/他 | 適切に翻訳されたUIテキスト |
| I18N-002 | 日付形式テスト | 異なる地域での日付表示 | 地域設定=米国/日本/欧州 | 地域に応じた日付形式表示 |
| I18N-003 | 時刻形式テスト | 異なる地域での時刻表示 | 地域設定=米国/日本/欧州 | 地域に応じた時刻形式表示 |
| I18N-004 | 通貨表示テスト | 異なる地域での金額表示 | 地域設定=米国/日本/欧州 | 地域に応じた通貨記号と形式 |
| I18N-005 | 言語切替テスト | アプリ内での言語切替 | 言語設定変更 | UI即時更新+設定保存 |

### 6.2 アクセシビリティテスト

| テストID | テスト名 | テスト内容 | 入力パラメータ | 期待される結果 |
|---------|---------|----------|--------------|--------------|
| A11Y-001 | スクリーンリーダー対応テスト | スクリーンリーダーでの操作 | スクリーンリーダー有効 | 全画面要素が適切に読み上げられる |
| A11Y-002 | キーボードナビゲーションテスト | キーボードのみでの操作 | キーボード操作のみ | 全機能にアクセス可能 |
| A11Y-003 | 高コントラストモードテスト | 高コントラスト表示設定 | 高コントラスト設定有効 | 十分なコントラストで全テキスト可読 |
| A11Y-004 | 文字サイズ変更テスト | システム文字サイズ変更 | 大きい文字サイズ設定 | レイアウト崩れなく表示調整 |
| A11Y-005 | 音声入力対応テスト | 音声コマンドでの操作 | 音声入力によるコマンド | 適切にコマンドが認識・実行される |

## 7. セキュリティ強化テスト

### 7.1 データ保護テスト

| テストID | テスト名 | テスト内容 | 入力パラメータ | 期待される結果 |
|---------|---------|----------|--------------|--------------|
| SEC-001 | 保存データ暗号化テスト | ローカル保存データの暗号化 | ローカルDB保存データ | 暗号化された形式で保存される |
| SEC-002 | ネットワーク通信暗号化テスト | API通信の暗号化 | ネットワークトラフィック監視 | 全通信がHTTPS/TLSで暗号化 |
| SEC-003 | セッショントークン保護テスト | 認証トークンの安全な保存 | アプリ再起動+セッション継続 | 安全な方法でトークン保存・使用 |
| SEC-004 | プライベートデータ表示制限テスト | 機密データの表示制限 | 住所/電話番号などの表示 | 部分的なマスキング+アクセス制限 |
| SEC-005 | アプリロック機能テスト | アプリロック機能の動作 | アプリロック有効化 | 起動時にパスコード/生体認証要求 |

### 7.2 入力検証テスト

| テストID | テスト名 | テスト内容 | 入力パラメータ | 期待される結果 |
|---------|---------|----------|--------------|--------------|
| INV-001 | SQLインジェクション防御テスト | SQLインジェクション攻撃シミュレーション | 悪意あるSQL文字列入力 | エスケープ処理+攻撃防御 |
| INV-002 | XSS防御テスト | クロスサイトスクリプティングシミュレーション | JavaScript含む入力 | サニタイズ処理+攻撃防御 |
| INV-003 | 大量入力テスト | 極端に長い入力値 | 100MB以上のテキスト入力 | 適切な制限+エラーハンドリング |
| INV-004 | 特殊文字入力テスト | 制御文字や特殊文字を含む入力 | 制御文字/改行/特殊文字入力 | 適切に処理またはサニタイズ |
| INV-005 | APIパラメータ検証テスト | 不正なAPIパラメータ送信 | 範囲外/無効な値のパラメータ | サーバー側で適切に検証・拒否 |

これらの追加テストケースを実装することで、イベントドメインの品質と堅牢性を大幅に向上させることができます。特に日時処理の安定性、同時操作の整合性、エラー回復性、国際化対応などの重要な側面をカバーします。