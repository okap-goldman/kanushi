# 検索・AIドメインテスト仕様書

## 1. 概要

検索・AIドメインのテストは、以下の主要コンポーネントを対象に実施します。

1. **検索機能** (SEARCH)
   - ユーザー検索、投稿検索、検索結果のフィルタリング等
   
2. **AIチャット機能** (CHAT)
   - AIとの対話型チャット、チャットセッションの管理等
   
3. **チャットメッセージ** (CHAT_MESSAGE)
   - メッセージの送受信、履歴の管理等
   
4. **検索履歴** (SEARCH_HISTORY)
   - 履歴の記録、表示、削除等

これらのコンポーネントについて、単体テスト、統合テスト、UIテストを実施し、機能の正確性、性能、使いやすさを検証します。

## 2. テスト環境

### 2.1 テスト環境設定

- **開発環境**: Flutter 3.x以上
- **テストフレームワーク**: Flutter Test, Mockito
- **テスト端末**: iPhone (iOS 15以上), Android (API 29以上)
- **ネットワーク環境**: オンライン、オフライン、低速接続の各環境でテスト

### 2.2 前提条件

- テスト実行前にモックサーバーが起動していること
- テストデータが初期状態にリセットされていること
- テスト用アカウントが作成済みであること

## 3. テスト対象コンポーネント

### 3.1 検索機能

#### エンティティ

- `SearchQueryEntity`
- `SearchResultEntity`
- `SearchSuggestionEntity`

#### リポジトリ

- `ISearchRepository`
  - `search()`
  - `getSuggestions()`

#### ユースケース

- `SearchUseCase`
- `GetSearchSuggestionsUseCase`

#### ビューモデル

- `SearchViewModel`
  - 検索クエリ処理
  - 検索結果の状態管理
  - フィルタリング処理

### 3.2 AIチャット機能

#### エンティティ

- `ChatSessionEntity`
- `ChatMessageEntity`

#### リポジトリ

- `IChatRepository`
  - `createSession()`
  - `getSessions()`
  - `getMessages()`
  - `sendMessage()`
  - `deleteSession()`

#### ユースケース

- `CreateChatSessionUseCase`
- `SendChatMessageUseCase`
- `GetChatSessionsUseCase`
- `GetChatMessagesUseCase`
- `DeleteChatSessionUseCase`

#### ビューモデル

- `AIChatViewModel`
  - チャットセッション管理
  - メッセージ送受信処理
  - チャット状態の管理

### 3.3 検索履歴機能

#### エンティティ

- `SearchHistoryEntity`

#### リポジトリ

- `ISearchHistoryRepository`
  - `getSearchHistory()`
  - `deleteSearchHistory()`
  - `clearAllSearchHistory()`

#### ユースケース

- `GetSearchHistoryUseCase`
- `DeleteSearchHistoryUseCase`

#### ビューモデル

- `SearchHistoryViewModel`
  - 履歴表示制御
  - 履歴削除処理

## 4. テスト種別

### 4.1 単体テスト

1. **モデルテスト**
   - 各モデルのJSON変換処理の正確性
   - バリデーションロジックの動作確認

2. **リポジトリテスト**
   - データ取得ロジックの正確性
   - エラーハンドリングの動作確認
   - オフライン対応の動作確認

3. **ユースケーステスト**
   - ビジネスロジックの正確性
   - 例外処理の動作確認

4. **ビューモデルテスト**
   - 状態遷移の正確性
   - イベント処理の動作確認
   - エラー状態の正確な反映

### 4.2 統合テスト

1. **データフローテスト**
   - データソース → リポジトリ → ユースケース → ビューモデルの連携
   - 完全なデータフローにおけるエラー伝播

2. **機能テスト**
   - 検索機能の一連の動作
   - チャット機能の一連の動作
   - 検索履歴管理の一連の動作

### 4.3 UIテスト

1. **画面表示テスト**
   - 各画面の正確な表示
   - 状態に応じたUI要素の表示/非表示

2. **インタラクションテスト**
   - ユーザー操作に対する応答
   - エラー状態からの回復
   - ページネーションやスクロール処理

## 5. テストケース詳細

### 5.1 検索機能テスト

#### 5.1.1 検索クエリ処理テスト

| No | テスト内容 | 入力条件 | 期待される結果 |
|----|------------|----------|----------------|
| S-01 | 基本的なテキスト検索 | クエリ: "目醒め", タイプ: all | 「目醒め」を含む投稿とユーザーが返される |
| S-02 | ユーザー限定検索 | クエリ: "田中", タイプ: user | 「田中」を含むユーザー名のユーザーのみ返される |
| S-03 | 投稿限定検索 | クエリ: "瞑想", タイプ: post | 「瞑想」を含む投稿のみ返される |
| S-04 | 空のクエリ検索 | クエリ: "", タイプ: all | 検索履歴が表示される |
| S-05 | フィルター付き検索 | クエリ: "体験", タイプ: post, フィルター: {date: "last_week"} | 過去1週間の「体験」を含む投稿のみ返される |
| S-06 | ページネーション | クエリ: "瞑想", タイプ: post, limit: 10, offset: 10 | 2ページ目の結果（11-20件目）が返される |
| S-07 | 特殊文字を含む検索 | クエリ: "目醒め!", タイプ: all | 「目醒め!」を含むコンテンツが返される |
| S-08 | 長いクエリの検索 | クエリ: "これは50文字以上の非常に長い検索クエリです..." | 長いクエリでも適切に処理される |
| S-09 | 複数キーワード検索 | クエリ: "瞑想 目醒め", タイプ: all | 「瞑想」と「目醒め」の両方を含むコンテンツが返される |
| S-10 | クエリのサニタイズ | クエリ: "<script>alert('XSS')</script>", タイプ: all | サニタイズされたクエリが処理され、安全に結果が返される |

#### 5.1.2 検索サジェスト機能テスト

| No | テスト内容 | 入力条件 | 期待される結果 |
|----|------------|----------|----------------|
| SS-01 | 基本サジェスト | クエリ: "目" | 「目醒め」などのサジェストが表示される |
| SS-02 | 空クエリのサジェスト | クエリ: "" | 最近の検索履歴がサジェストとして表示される |
| SS-03 | 該当なしのサジェスト | クエリ: "存在しないであろうクエリ" | 空のサジェスト配列が返される |
| SS-04 | サジェスト制限数 | クエリ: "目", limit: 3 | 最大3つのサジェストが返される |
| SS-05 | トレンドサジェスト | クエリ: "瞑" | 「瞑想」などの人気サジェストが上位に表示される |

#### 5.1.3 検索エラー処理テスト

| No | テスト内容 | 入力条件 | 期待される結果 |
|----|------------|----------|----------------|
| SE-01 | ネットワークエラー | オフライン状態で検索 | ネットワークエラーが適切に処理され、エラーメッセージが表示される |
| SE-02 | サーバーエラー | 500エラーをモック | サーバーエラーが適切に処理され、エラーメッセージが表示される |
| SE-03 | 検索上限エラー | 検索上限(5回/日)を超えた検索 | 上限超過エラーが表示され、代替手段が提案される |
| SE-04 | 無効なクエリエラー | 無効なクエリパラメータでの検索 | バリデーションエラーが適切に処理される |

### 5.2 AIチャット機能テスト

#### 5.2.1 チャットセッション管理テスト

| No | テスト内容 | 入力条件 | 期待される結果 |
|----|------------|----------|----------------|
| C-01 | 新規セッション作成 | タイトル: "目醒めについて" | 新しいセッションが作成され、ID、タイトルが正しく設定される |
| C-02 | セッション一覧取得 | ユーザーに複数のセッションがある状態 | すべてのセッションが日時順に取得される |
| C-03 | セッション削除 | 既存のセッションID | セッションとそれに関連するメッセージが削除される |
| C-04 | セッションタイトル更新 | セッションID、新タイトル: "目醒めと瞑想" | セッションのタイトルが更新される |
| C-05 | オフライン時のセッション取得 | オフライン状態でのセッション一覧取得 | ローカルに保存されたセッションが表示される |

#### 5.2.2 チャットメッセージ管理テスト

| No | テスト内容 | 入力条件 | 期待される結果 |
|----|------------|----------|----------------|
| CM-01 | メッセージ送信 | セッションID、内容: "目醒めとは何ですか？" | ユーザーメッセージが送信され、AIの応答が受信される |
| CM-02 | メッセージ一覧取得 | セッションID | セッション内のすべてのメッセージが時系列で取得される |
| CM-03 | 長文メッセージ送信 | セッションID、1000文字以上の内容 | 長文メッセージが適切に送信・表示される |
| CM-04 | オフライン時のメッセージ表示 | オフライン状態でのメッセージ取得 | ローカルに保存されたメッセージが表示される |
| CM-05 | 特殊文字を含むメッセージ | セッションID、HTML/特殊文字を含む内容 | メッセージが適切にエスケープされて表示される |

#### 5.2.3 AIレスポンステスト

| No | テスト内容 | 入力条件 | 期待される結果 |
|----|------------|----------|----------------|
| AR-01 | 基本的な質問応答 | "目醒めとは何ですか？" | 目醒めに関する適切な説明がAIから返される |
| AR-02 | コンテキスト継続質問 | 前メッセージ後の "それを深めるにはどうすればいいですか？" | 前のコンテキスト（目醒め）を考慮した回答が返される |
| AR-03 | AIエラー処理 | AIサービス障害状態での質問 | AIエラーが適切に処理され、エラーメッセージが表示される |
| AR-04 | 応答タイミング表示 | 質問送信時 | 応答中の状態（タイピングインジケーター等）が適切に表示される |
| AR-05 | コンテンツフィルタリング | 不適切な内容の質問 | コンテンツポリシーに基づいた適切な応答が返される |

### 5.3 検索履歴機能テスト

#### 5.3.1 検索履歴管理テスト

| No | テスト内容 | 入力条件 | 期待される結果 |
|----|------------|----------|----------------|
| SH-01 | 検索履歴保存 | 新規検索クエリの実行 | 検索履歴が正しく保存される |
| SH-02 | 検索履歴取得 | 履歴取得リクエスト | 最新の検索履歴が日時順に取得される |
| SH-03 | 検索履歴削除 | 特定の履歴ID | 指定された履歴項目のみが削除される |
| SH-04 | 全履歴削除 | 全履歴削除リクエスト | すべての検索履歴が削除される |
| SH-05 | 履歴上限管理 | 100件以上の履歴がある状態で新規検索 | 最も古い履歴が削除され、新しい履歴が保存される |

## 6. テストパラメーター一覧

### 6.1 検索機能パラメーター

#### 6.1.1 検索クエリパラメーター

| パラメーター | 説明 | テスト値 |
|--------------|------|----------|
| query | 検索キーワード | 空文字, "目醒め", "瞑想", "体験", "田中", "!@#$%" |
| type | 検索対象タイプ | "all", "user", "post" |
| filters | 検索フィルター | {}, {date: "last_day"}, {date: "last_week"}, {date: "last_month"} |
| limit | 結果の制限数 | 10, 20, 50, 100 |
| offset | ページネーション用オフセット | 0, 10, 20, 50 |

#### 6.1.2 検索サジェストパラメーター

| パラメーター | 説明 | テスト値 |
|--------------|------|----------|
| query | サジェスト取得用キーワード | 空文字, "目", "瞑", "体", "存在しないであろうクエリ" |
| limit | サジェスト数の上限 | 3, 5, 10 |

### 6.2 AIチャット機能パラメーター

#### 6.2.1 チャットセッションパラメーター

| パラメーター | 説明 | テスト値 |
|--------------|------|----------|
| title | セッションタイトル | "目醒めについて", "瞑想の効果", "自己探求", 空文字 |
| sessionId | セッションID | 有効なUUID, 無効なUUID |

#### 6.2.2 チャットメッセージパラメーター

| パラメーター | 説明 | テスト値 |
|--------------|------|----------|
| content | メッセージ内容 | "目醒めとは何ですか？", "それを深めるにはどうすればいいですか？", "<script>alert('XSS')</script>", 長文(1000文字以上) |
| sessionId | セッションID | 有効なUUID, 無効なUUID |
| limit | メッセージ取得数の上限 | 20, 50, 100 |
| cursor | ページネーション用カーソル | 有効なカーソル値, null |

### 6.3 検索履歴機能パラメーター

| パラメーター | 説明 | テスト値 |
|--------------|------|----------|
| historyId | 検索履歴ID | 有効なUUID, 無効なUUID |
| limit | 履歴取得数の上限 | 10, 20, 50 |
| cursor | ページネーション用カーソル | 有効なカーソル値, null |

## 7. 期待される結果のペア一覧

### 7.1 検索機能の期待結果

#### 7.1.1 検索クエリと期待結果

| クエリ設定 | 期待される結果 |
|------------|----------------|
| query: "目醒め", type: "all" | 「目醒め」を含む投稿とユーザーが返される。結果データには各アイテムのtype属性に"post"または"user"が設定されている。 |
| query: "田中", type: "user" | 「田中」を含むユーザー名のユーザーのみ返される。すべての結果のtype属性は"user"。 |
| query: "瞑想", type: "post" | 「瞑想」を含む投稿のみ返される。すべての結果のtype属性は"post"。 |
| query: "", type: "all" | 検索履歴が表示される。結果は空ではなく、直近の検索履歴項目がリストされる。 |
| query: "体験", type: "post", filters: {date: "last_week"} | 過去1週間の「体験」を含む投稿のみ返される。結果の全投稿は1週間以内に作成されている。 |
| query: "瞑想", limit: 10, offset: 10 | 2ページ目の結果（11-20件目）が返される。totalCountは全件数を示し、hasMoreフラグは追加データの有無を示す。 |
| query: "!@#$%", type: "all" | 特殊文字が適切に処理され、検索結果が返される（該当データがない場合は空配列）。エラーは発生しない。 |

#### 7.1.2 検索サジェストと期待結果

| サジェスト設定 | 期待される結果 |
|----------------|----------------|
| query: "目" | 「目醒め」などのサジェストが配列で返される。各サジェストにはquery、type、countの属性がある。 |
| query: "" | 最近の検索履歴がサジェストとして返される。type属性が"history"のサジェスト項目が含まれる。 |
| query: "存在しないであろうクエリ" | 空の配列が返される。エラーは発生しない。 |
| query: "瞑", limit: 3 | 最大3つのサジェストが返される。配列の長さは3以下。 |

### 7.2 AIチャット機能の期待結果

#### 7.2.1 チャットセッション操作と期待結果

| 操作設定 | 期待される結果 |
|----------|----------------|
| 新規セッション作成: title: "目醒めについて" | セッションが作成され、レスポンスにはid、title、createdAtが含まれる。AIの最初の応答もレスポンスに含まれる。 |
| セッション一覧取得 | セッションの配列が返される。各セッションにはid、title、lastMessage、messageCount、createdAt、updatedAtが含まれる。 |
| セッション削除: 有効なsessionId | 操作が成功し、{success: true}が返される。該当セッションに関連するメッセージも削除される。 |
| オフライン時のセッション取得 | ローカルに保存されたセッションの配列が返される。ネットワークエラーは発生しない。 |

#### 7.2.2 チャットメッセージ操作と期待結果

| 操作設定 | 期待される結果 |
|----------|----------------|
| メッセージ送信: content: "目醒めとは何ですか？" | 送信したメッセージとAIの応答が返される。userMessageとbotResponseの両方の属性がレスポンスに含まれる。 |
| メッセージ一覧取得: 有効なsessionId | メッセージの配列が返される。各メッセージにはid、role("user"または"assistant")、content、createdAtが含まれる。 |
| オフライン時のメッセージ取得 | ローカルに保存されたメッセージの配列が返される。ネットワークエラーは発生しない。 |
| 特殊文字を含むメッセージ送信 | メッセージが正しくエスケープされて保存・表示される。XSS攻撃などの脆弱性は発生しない。 |

### 7.3 検索履歴機能の期待結果

| 操作設定 | 期待される結果 |
|----------|----------------|
| 履歴取得: limit: 10 | 最新10件の検索履歴が返される。各履歴項目にはid、query、searchedAt、resultsCountが含まれる。 |
| 特定履歴削除: 有効なhistoryId | 操作が成功し、{success: true}が返される。該当の履歴項目のみが削除される。 |
| 全履歴削除 | 操作が成功し、{success: true, deletedCount: X}が返される。Xは削除された履歴数を示す。 |
| 履歴上限テスト | 101件目の履歴が保存されると、最も古い履歴が自動的に削除される。履歴総数は100件を超えない。 |

## 8. 非機能テスト

### 8.1 パフォーマンステスト

1. **応答時間テスト**
   - 検索応答時間: 500ms以内
   - AIチャット応答時間: 5秒以内（タイピングインジケーターあり）
   - 検索サジェスト表示: 200ms以内

2. **同時アクセステスト**
   - 複数チャットセッションの同時操作
   - 連続検索リクエストの処理

### 8.2 セキュリティテスト

1. **入力検証**
   - XSS攻撃パターン
   - SQLインジェクションパターン
   - 不正なJSONデータ

2. **認証・認可**
   - 未認証状態でのAPI呼び出し
   - 他ユーザーのデータアクセス試行

### 8.3 互換性テスト

1. **デバイス互換性**
   - 異なる画面サイズ（スマートフォン、タブレット）
   - 異なるOS（iOS, Android）

2. **ネットワーク耐性**
   - 低速接続環境
   - 接続断続環境
   - オフライン → オンライン復帰時の同期

## 9. テスト実行手順

### 9.1 単体テスト実行

```bash
# 全単体テストの実行
cd app && flutter test test/domain/entities test/data/models test/data/repositories test/domain/usecases

# 特定コンポーネントのテスト実行
cd app && flutter test test/domain/usecases/search_usecase_test.dart
```

### 9.2 統合テスト実行

```bash
# 統合テストの実行
cd app && flutter test integration_test/search_integration_test.dart
cd app && flutter test integration_test/chat_integration_test.dart
```

### 9.3 UIテスト実行

```bash
# UIテストの実行
cd app && flutter test test/presentation/screens/search_screen_test.dart
cd app && flutter test test/presentation/screens/ai_chat_screen_test.dart
```

## 10. テスト成功基準

1. **全機能カバレッジ**
   - 検索・AIドメインの全ユースケースがテストでカバーされていること
   - ハッピーパス、エラーパスの双方がテストされていること

2. **パフォーマンス基準**
   - 検索応答: 500ms以内
   - AIチャット応答: 5秒以内
   - アプリのレスポンス: ユーザー操作から200ms以内の反応

3. **安定性基準**
   - テスト成功率: 95%以上
   - 連続実行での安定性確保

## 11. バグ報告・追跡手順

1. **バグ報告フォーマット**
   - バグ概要
   - 再現手順
   - 期待される結果
   - 実際の結果
   - 環境情報

2. **バグ深刻度レベル**
   - Critical: 主要機能が使用不可
   - Major: 機能は動作するが、重大な問題あり
   - Minor: 軽微な問題だが修正が必要
   - Trivial: 見た目や小さな問題

3. **バグ追跡プロセス**
   - 報告 → 確認 → 修正 → 再テスト → クローズ

## 12. テスト自動化戦略

1. **CI/CD連携**
   - Pull Request時の自動テスト実行
   - ナイトリービルド時の全テスト実行

2. **テスト優先度設定**
   - P0: 必ず通過すべき重要テスト
   - P1: 主要機能の動作確認テスト
   - P2: エッジケースと詳細機能テスト