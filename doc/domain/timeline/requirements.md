# タイムラインドメイン要件定義

## 概要
タイムラインドメインは、アプリケーション内でユーザーが作成した投稿を時系列で表示する機能を提供します。「ファミリー」と「ウォッチ」の2種類の表示形式をサポートし、ユーザーの閲覧体験を最適化します。このドメインは投稿ドメインで定義された投稿エンティティに依存します。

## タイムライン表示 (TIMELINE)

### 要素
- **enum timeline_type** - タイムラインの種類（family | watch）
- **array posts** - 表示される投稿の配列
- **string cursor** - ページネーション用カーソル
- **int limit** - 一度に取得する投稿数

### 機能
- 混在縦スクロール表示
- タイムライン種類の切替（ファミリー ↔ ウォッチ）
- 多様なメディア形式の統合表示
- カーソルベースのページネーション
- 投稿内容のプレビュー表示

### 要件
- デフォルトのタイムライン種類は「ファミリー」
- 「ウォッチ」タイムラインへの切替時はモーダル確認を表示
- テキスト投稿のプレビューは最大280文字まで表示
- リンクは青文字で表示
- 動画、画像、音声、テキストの混在表示に対応
- 投稿にはいいね数、コメント数、ハイライト数を表示

## タイムライン設定 (TIMELINE_SETTINGS)

### 要素
- **UUID user_id** - タイムライン表示対象ユーザーID
- **enum type** - タイムラインタイプ（family | watch | all）
- **jsonb settings** - ユーザー固有のタイムライン設定

### 機能
- タイムラインの取得と表示
- タイムラインタイプによるフィルタリング
- タイムラインの更新とリフレッシュ
- タイムライン設定のカスタマイズ

### 要件
- フォロー関係に基づいた投稿を表示
- タイムラインは3種類ある：
  - family: ファミリータイプでフォローしているユーザーの投稿
  - watch: ウォッチタイプでフォローしているユーザーの投稿
  - all: すべてのタイプの投稿を統合
- 投稿は時系列順に表示される
- ハイライトされた投稿は優先表示される
- 環境設定により表示件数や取得期間を調整可能
- タイムラインのスクロールに応じた無限ローディング
- ユーザーの閲覧履歴を考慮した表示（既読管理）
- ユーザーの興味に基づいた投稿順序の最適化

## タイムライン閲覧履歴 (TIMELINE_VIEW_HISTORY)

### 要素
- **UUID id** - 閲覧履歴ID
- **UUID user_id** - ユーザーID
- **UUID post_id** - 閲覧した投稿ID
- **datetime viewed_at** - 閲覧日時
- **integer view_duration** - 閲覧時間（秒）
- **boolean completed** - 完全に閲覧したかどうか

### 機能
- 閲覧履歴の記録
- 閲覧履歴に基づくタイムライン最適化
- 閲覧統計の分析

### 要件
- ユーザーの閲覧履歴をプライバシーに配慮して記録
- デバイス間で閲覧状態を同期
- 閲覧時間や完了状態に基づくコンテンツ優先順位付け
- 一定期間後の履歴自動削除オプション

## フィルター設定 (FILTER_SETTINGS)

### 要素
- **UUID user_id** - ユーザーID
- **jsonb content_filters** - コンテンツフィルター設定
- **array blocked_terms** - ブロックするキーワード
- **array blocked_users** - ブロックするユーザーID
- **array content_preferences** - コンテンツ選好性

### 機能
- タイムラインフィルター設定の管理
- コンテンツタイプによるフィルタリング
- ブロック設定の管理
- コンテンツ選好性の設定

### 要件
- ユーザーごとのカスタマイズ可能なフィルター設定
- 特定のコンテンツタイプ（テキスト、画像、動画、音声）の表示/非表示
- 特定のキーワードを含む投稿のフィルタリング
- ブロックしたユーザーの投稿を非表示
- コンテンツの選好性に基づく表示優先度調整
- 設定の即時反映

## おすすめ (RECOMMENDATION)

### 要素
- **UUID user_id** - 推薦コンテンツ表示対象ユーザーID
- **enum type** - 推薦タイプ（post | event | user）
- **jsonb settings** - 推薦アルゴリズム設定

### 機能
- ユーザーに適した推薦コンテンツ生成
- タイプ別の推薦コンテンツフィルタリング
- 推薦コンテンツの更新とリフレッシュ
- 推薦アルゴリズムのパーソナライズ

### 要件
- ユーザーの興味や行動履歴に基づいた推薦
- 推薦コンテンツは3タイプある：
  - post: よく見た投稿や興味に合う投稿
  - event: 地域や興味に基づくイベント
  - user: フォローすると良さそうなユーザー
- アルゴリズムはユーザーの行動とともに学習し、推薦精度を向上
- ユーザーは推薦のフィードバックを提供可能
- 定期的に新しいおすすめコンテンツを提供
- 地域情報に基づいたローカルコンテンツの優先表示

## 非機能要件

### セキュリティ
- 非公開投稿の適切なアクセス制御
- ブロック設定の厳密な適用
- タイムラインデータの暗号化保存
- クロスサイトスクリプティング対策

### パフォーマンス
- タイムライン応答時間: 2秒以内
- スクロール中のパフォーマンス低下を最小限に抑える
- 画像・動画は最適化されたサイズで表示
- スクロール時の追加コンテンツ取得: 1秒以内
- 同時接続時のレスポンス維持: 1000同時接続でも劣化なし
- メモリ効率の高いページネーション処理

### 拡張性
- タイムラインフィルターやソート機能の追加に対応可能な構造
- 投稿エンゲージメント指標の拡張性を確保
- 数百万投稿のタイムライン生成に対応
- 高頻度の投稿更新に対応するキャッシュ戦略
- ユーザー数の増加に応じたタイムライン生成の分散処理
- リージョンごとのコンテンツCDN配置

### 可用性
- タイムライン機能の稼働率: 99.9%以上
- フォールバック機能: APIエラー時にキャッシュから表示
- 段階的な劣化戦略: 一部機能が利用できなくても基本機能は維持

### ユーザビリティ
- スムーズなスクロール体験の提供
- タイムライン種類切替の直感的な操作
- 投稿内容の可読性を確保
- メディアコンテンツの適切なプレビュー表示