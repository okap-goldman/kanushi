# タイムラインドメイン テスト仕様書

## 1. テスト概要

このテスト仕様書は、Kanushiアプリケーションのタイムラインドメインに対する包括的なテストケース定義を提供します。タイムラインドメインはアプリの中核機能であり、他のユーザーの投稿を時系列で表示し、「ファミリー」や「ウォッチ」といった異なるタイプのフォロー関係に基づいて投稿をフィルタリングする機能を提供します。

## 2. テスト対象コンポーネント

### ドメイン層
- TimelineEntity
- TimelinePostEntity
- TimelineFilterEntity
- ITimelineRepository
- ITimelineFilterRepository
- ITimelineViewHistoryRepository
- IRecommendationRepository
- GetTimelineUseCase
- GetWatchTimelineUseCase
- UpdateTimelineFilterUseCase
- RefreshTimelineUseCase
- GetMoreTimelinePostsUseCase
- RecordViewHistoryUseCase
- GetRecommendationsUseCase

### データ層
- TimelineRepository
- TimelineFilterRepository
- TimelineViewHistoryRepository
- RecommendationRepository
- TimelineRemoteDataSource
- TimelineLocalDataSource
- TimelineFilterLocalDataSource
- TimelineViewHistoryLocalDataSource
- RecommendationRemoteDataSource
- TimelineModel
- TimelinePostModel
- TimelineFilterModel
- TimelineViewHistoryModel
- RecommendationModel

### プレゼンテーション層
- TimelineViewModel
- WatchTimelineViewModel
- TimelineFilterViewModel
- TimelineScreen
- WatchTimelineScreen
- TimelineFilterScreen

## 3. テストケース

### 3.1 リポジトリレイヤーテスト

#### 3.1.1 TimelineRepository テスト

##### テストケース: タイムライン取得（オンライン）
- **説明**: オンライン状態でタイムラインデータを正常に取得できることをテスト
- **前提条件**:
  - データソースがオンライン状態
  - 正常なレスポンスが返される
- **テスト手順**:
  1. `TimelineType.family`でタイムラインを取得
  2. 制限を20件、カーソルを未指定で取得
- **期待結果**:
  - 取得したデータが正しく返される
  - 取得したデータがローカルにキャッシュされる

##### テストケース: タイムライン取得（オフライン、キャッシュあり）
- **説明**: オフライン状態で、キャッシュからタイムラインデータを取得できることをテスト
- **前提条件**:
  - データソースがオフライン状態
  - ローカルキャッシュにデータが存在する
- **テスト手順**:
  1. `TimelineType.family`でタイムラインを取得
- **期待結果**:
  - キャッシュからのデータが正しく返される

##### テストケース: タイムライン取得（オフライン、キャッシュなし）
- **説明**: オフライン状態で、キャッシュも存在しない場合のエラーハンドリングをテスト
- **前提条件**:
  - データソースがオフライン状態
  - ローカルキャッシュにデータが存在しない
- **テスト手順**:
  1. `TimelineType.family`でタイムラインを取得
- **期待結果**:
  - 適切なエラーが返される

##### テストケース: タイムラインリフレッシュ
- **説明**: タイムラインデータが正常にリフレッシュできることをテスト
- **前提条件**:
  - データソースがオンライン状態
- **テスト手順**:
  1. `TimelineType.family`でタイムラインをリフレッシュ
- **期待結果**:
  - 最新のデータが取得される
  - 取得したデータがローカルにキャッシュされる

##### テストケース: 投稿IDリストからタイムライン投稿の取得
- **説明**: 投稿IDリストから投稿詳細を正常に取得できることをテスト
- **前提条件**:
  - 有効な投稿IDリストが存在する
- **テスト手順**:
  1. 複数の投稿IDを含むリストで`getTimelinePostsByIds`を呼び出す
- **期待結果**:
  - 指定されたIDに対応する投稿リストが返される

#### 3.1.2 TimelineFilterRepository テスト

##### テストケース: フィルター設定の取得
- **説明**: ユーザーのフィルター設定を正常に取得できることをテスト
- **前提条件**:
  - ローカルストレージにフィルター設定が存在する
- **テスト手順**:
  1. `getFilter`メソッドを呼び出す
- **期待結果**:
  - 保存されているフィルター設定が返される

##### テストケース: フィルター設定のデフォルト値
- **説明**: フィルター設定が存在しない場合、デフォルト値が返されることをテスト
- **前提条件**:
  - ローカルストレージにフィルター設定が存在しない
- **テスト手順**:
  1. `getFilter`メソッドを呼び出す
- **期待結果**:
  - デフォルトのフィルター設定が返される

##### テストケース: フィルター設定の更新
- **説明**: フィルター設定が正常に更新されることをテスト
- **前提条件**:
  - 更新可能なストレージにアクセスできる
- **テスト手順**:
  1. 新しいフィルター設定で`updateFilter`を呼び出す
- **期待結果**:
  - 更新されたフィルター設定が返される
  - フィルター設定がローカルに保存される

#### 3.1.3 TimelineViewHistoryRepository テスト

##### テストケース: 閲覧履歴の記録（オンライン）
- **説明**: オンライン状態で閲覧履歴が正常に記録されることをテスト
- **前提条件**:
  - データソースがオンライン状態
- **テスト手順**:
  1. 有効なパラメータで`recordViewHistory`を呼び出す
- **期待結果**:
  - 履歴がローカルに保存される
  - 履歴がサーバーに同期される

##### テストケース: 閲覧履歴の記録（オフライン）
- **説明**: オフライン状態で閲覧履歴が正常に記録され、後でサーバーに同期されないことをテスト
- **前提条件**:
  - データソースがオフライン状態
- **テスト手順**:
  1. 有効なパラメータで`recordViewHistory`を呼び出す
- **期待結果**:
  - 履歴がローカルに保存される
  - サーバー同期が行われない

##### テストケース: 閲覧履歴の取得
- **説明**: ユーザーの閲覧履歴が正常に取得できることをテスト
- **前提条件**:
  - ユーザーに閲覧履歴が存在する
- **テスト手順**:
  1. 有効なユーザーIDで`getViewHistory`を呼び出す
- **期待結果**:
  - ユーザーの閲覧履歴が返される

### 3.2 ユースケースレイヤーテスト

#### 3.2.1 GetTimelineUseCase テスト

##### テストケース: 正常なタイムライン取得
- **説明**: タイムラインが正常に取得できることをテスト
- **前提条件**:
  - リポジトリが正常にデータを返す
- **テスト手順**:
  1. `GetTimelineUseCase`を実行
- **期待結果**:
  - リポジトリから正しいデータが返される

##### テストケース: エラー発生時のハンドリング
- **説明**: リポジトリでエラーが発生した場合の処理をテスト
- **前提条件**:
  - リポジトリがエラーを返す
- **テスト手順**:
  1. `GetTimelineUseCase`を実行
- **期待結果**:
  - エラーが適切に伝播される

#### 3.2.2 RefreshTimelineUseCase テスト

##### テストケース: 正常なタイムラインリフレッシュ
- **説明**: タイムラインが正常にリフレッシュできることをテスト
- **前提条件**:
  - リポジトリが正常にデータを返す
- **テスト手順**:
  1. `RefreshTimelineUseCase`を実行
- **期待結果**:
  - リポジトリから最新のデータが返される

##### テストケース: リフレッシュエラーのハンドリング
- **説明**: リフレッシュ中にエラーが発生した場合の処理をテスト
- **前提条件**:
  - リポジトリがエラーを返す
- **テスト手順**:
  1. `RefreshTimelineUseCase`を実行
- **期待結果**:
  - エラーが適切に伝播される

#### 3.2.3 UpdateTimelineFilterUseCase テスト

##### テストケース: フィルター更新
- **説明**: タイムラインフィルターが正常に更新できることをテスト
- **前提条件**:
  - リポジトリが正常に動作する
- **テスト手順**:
  1. 新しいフィルター設定で`UpdateTimelineFilterUseCase`を実行
- **期待結果**:
  - 更新されたフィルター設定が返される

#### 3.2.4 RecordViewHistoryUseCase テスト

##### テストケース: 閲覧履歴記録
- **説明**: 投稿の閲覧履歴が正常に記録できることをテスト
- **前提条件**:
  - リポジトリが正常に動作する
- **テスト手順**:
  1. 有効なパラメータで`RecordViewHistoryUseCase`を実行
- **期待結果**:
  - 記録された閲覧履歴が返される

### 3.3 ビューモデルレイヤーテスト

#### 3.3.1 TimelineViewModel テスト

##### テストケース: 初期状態
- **説明**: ビューモデルの初期状態が正しいことをテスト
- **前提条件**:
  - ビューモデルを初期化
- **テスト手順**:
  1. `TimelineViewModel`のインスタンスを作成
- **期待結果**:
  - 状態が`TimelineInitial`である
  - 現在のタイプが`TimelineType.family`である

##### テストケース: タイムライン初回読み込み
- **説明**: タイムラインの初回読み込みが正常に行われることをテスト
- **前提条件**:
  - ユースケースが正常にデータを返す
- **テスト手順**:
  1. `getTimeline`メソッドを呼び出す
- **期待結果**:
  - 状態が`TimelineLoading`から`TimelineLoaded`に変わる
  - 読み込まれたデータが状態に格納される

##### テストケース: タイムラインタイプ切り替え
- **説明**: タイムラインタイプが正常に切り替わることをテスト
- **前提条件**:
  - 既にタイムラインが読み込まれている
- **テスト手順**:
  1. `switchTimelineType`メソッドを`TimelineType.watch`で呼び出す
- **期待結果**:
  - 現在のタイプが`TimelineType.watch`に変わる
  - 新しいタイプのタイムラインが読み込まれる

##### テストケース: タイムラインフィルター更新
- **説明**: タイムラインフィルターが正常に更新されることをテスト
- **前提条件**:
  - ユースケースが正常にフィルターを更新する
- **テスト手順**:
  1. 新しいフィルター設定で`updateFilter`メソッドを呼び出す
- **期待結果**:
  - フィルターが更新される
  - 更新されたフィルターでタイムラインが再読み込みされる

##### テストケース: タイムライン追加読み込み
- **説明**: タイムラインの続きが正常に読み込まれることをテスト
- **前提条件**:
  - 既にタイムラインが読み込まれている
  - 続きのデータが存在する
- **テスト手順**:
  1. `loadMore`メソッドを呼び出す
- **期待結果**:
  - 状態が`TimelineLoadingMore`から`TimelineLoaded`に変わる
  - 既存のデータに新しいデータが追加される

##### テストケース: タイムラインリフレッシュ
- **説明**: タイムラインが正常にリフレッシュされることをテスト
- **前提条件**:
  - 既にタイムラインが読み込まれている
- **テスト手順**:
  1. `refresh`メソッドを呼び出す
- **期待結果**:
  - 状態が`TimelineLoading`から`TimelineLoaded`に変わる
  - 最新のデータが読み込まれる

##### テストケース: エラーハンドリング
- **説明**: タイムライン読み込み中のエラーが適切に処理されることをテスト
- **前提条件**:
  - ユースケースがエラーを返す
- **テスト手順**:
  1. `getTimeline`メソッドを呼び出す
- **期待結果**:
  - 状態が`TimelineLoading`から`TimelineError`に変わる
  - エラーメッセージが状態に格納される

#### 3.3.2 WatchTimelineViewModel テスト

##### テストケース: 初期状態
- **説明**: ビューモデルの初期状態が正しいことをテスト
- **前提条件**:
  - ビューモデルを初期化
- **テスト手順**:
  1. `WatchTimelineViewModel`のインスタンスを作成
- **期待結果**:
  - 状態が`WatchTimelineInitial`である
  - 現在のインデックスが0である

##### テストケース: ウォッチタイムライン読み込み
- **説明**: ウォッチタイムラインが正常に読み込まれることをテスト
- **前提条件**:
  - ユースケースが正常にデータを返す
- **テスト手順**:
  1. `getWatchTimeline`メソッドを呼び出す
- **期待結果**:
  - 状態が`WatchTimelineLoading`から`WatchTimelineLoaded`に変わる
  - 読み込まれたデータが状態に格納される

##### テストケース: 次の投稿への移動
- **説明**: 次の投稿に正常に移動できることをテスト
- **前提条件**:
  - 既にタイムラインが読み込まれている
  - 現在のインデックスが最後でない
- **テスト手順**:
  1. `nextPost`メソッドを呼び出す
- **期待結果**:
  - 現在のインデックスが1増加する
  - 状態が更新される

##### テストケース: 最後の投稿から次へ（追加読み込み）
- **説明**: 最後の投稿から次へ移動すると追加読み込みが行われることをテスト
- **前提条件**:
  - 既にタイムラインが読み込まれている
  - 現在のインデックスが最後である
  - 続きのデータが存在する
- **テスト手順**:
  1. `nextPost`メソッドを呼び出す
- **期待結果**:
  - 追加データが読み込まれる
  - 状態が更新される

##### テストケース: 前の投稿への移動
- **説明**: 前の投稿に正常に移動できることをテスト
- **前提条件**:
  - 既にタイムラインが読み込まれている
  - 現在のインデックスが0より大きい
- **テスト手順**:
  1. `previousPost`メソッドを呼び出す
- **期待結果**:
  - 現在のインデックスが1減少する
  - 状態が更新される

##### テストケース: 最初の投稿から前へ（変化なし）
- **説明**: 最初の投稿から前へ移動しても変化がないことをテスト
- **前提条件**:
  - 既にタイムラインが読み込まれている
  - 現在のインデックスが0である
- **テスト手順**:
  1. `previousPost`メソッドを呼び出す
- **期待結果**:
  - 現在のインデックスが変化しない
  - 状態が変化しない

##### テストケース: 現在の投稿の閲覧記録
- **説明**: 現在の投稿の閲覧記録が正常に行われることをテスト
- **前提条件**:
  - 既にタイムラインが読み込まれている
  - 有効なユーザーが存在する
- **テスト手順**:
  1. `recordCurrentPostView`メソッドを有効なパラメータで呼び出す
- **期待結果**:
  - ユースケースが適切なパラメータで呼び出される

### 3.4 UI層テスト

#### 3.4.1 TimelineScreen テスト

##### テストケース: 画面初期表示
- **説明**: タイムライン画面が初期表示で正しく表示されることをテスト
- **前提条件**:
  - ビューモデルが`TimelineInitial`状態
- **テスト手順**:
  1. `TimelineScreen`をレンダリング
- **期待結果**:
  - 初期ローディング表示が見える

##### テストケース: タイムライン読み込み後の表示
- **説明**: タイムライン読み込み後に投稿リストが正しく表示されることをテスト
- **前提条件**:
  - ビューモデルが`TimelineLoaded`状態
  - 投稿データが存在する
- **テスト手順**:
  1. `TimelineScreen`をレンダリング
- **期待結果**:
  - 投稿リストが表示される
  - 各投稿の内容が正しく表示される

##### テストケース: タイムラインタイプ切替
- **説明**: ユーザーがタイムラインタイプを切り替えられることをテスト
- **前提条件**:
  - ビューモデルが`TimelineLoaded`状態
- **テスト手順**:
  1. `TimelineScreen`をレンダリング
  2. ウォッチタイムラインボタンをタップ
- **期待結果**:
  - ビューモデルの`switchTimelineType`メソッドが呼び出される
  - UI表示が切り替わる

##### テストケース: プルダウンリフレッシュ
- **説明**: プルダウンリフレッシュが機能することをテスト
- **前提条件**:
  - ビューモデルが`TimelineLoaded`状態
- **テスト手順**:
  1. `TimelineScreen`をレンダリング
  2. 画面を上から下へスワイプ
- **期待結果**:
  - ビューモデルの`refresh`メソッドが呼び出される
  - リフレッシュインジケーターが表示される

##### テストケース: 無限スクロール
- **説明**: 画面下部までスクロールすると追加データが読み込まれることをテスト
- **前提条件**:
  - ビューモデルが`TimelineLoaded`状態
  - 続きのデータが存在する
- **テスト手順**:
  1. `TimelineScreen`をレンダリング
  2. リストの最下部までスクロール
- **期待結果**:
  - ビューモデルの`loadMore`メソッドが呼び出される
  - ローディングインジケーターが表示される

##### テストケース: エラー表示と再試行
- **説明**: エラー発生時の表示と再試行機能をテスト
- **前提条件**:
  - ビューモデルが`TimelineError`状態
- **テスト手順**:
  1. `TimelineScreen`をレンダリング
  2. 再試行ボタンをタップ
- **期待結果**:
  - エラーメッセージと再試行ボタンが表示される
  - 再試行ボタンタップでビューモデルの`getTimeline`メソッドが呼び出される

#### 3.4.2 WatchTimelineScreen テスト

##### テストケース: 画面初期表示
- **説明**: ウォッチタイムライン画面が初期表示で正しく表示されることをテスト
- **前提条件**:
  - ビューモデルが`WatchTimelineInitial`状態
- **テスト手順**:
  1. `WatchTimelineScreen`をレンダリング
- **期待結果**:
  - 初期ローディング表示が見える

##### テストケース: 投稿表示
- **説明**: ウォッチタイムラインで投稿が正しく表示されることをテスト
- **前提条件**:
  - ビューモデルが`WatchTimelineLoaded`状態
  - 投稿データが存在する
- **テスト手順**:
  1. `WatchTimelineScreen`をレンダリング
- **期待結果**:
  - 現在の投稿が全画面で表示される
  - メディアコントロールが表示される（動画/音声の場合）

##### テストケース: 次の投稿へスワイプ
- **説明**: ユーザーが次の投稿へスワイプできることをテスト
- **前提条件**:
  - ビューモデルが`WatchTimelineLoaded`状態
  - 次の投稿が存在する
- **テスト手順**:
  1. `WatchTimelineScreen`をレンダリング
  2. 画面を上にスワイプ
- **期待結果**:
  - ビューモデルの`nextPost`メソッドが呼び出される
  - 次の投稿が表示される

##### テストケース: 前の投稿へスワイプ
- **説明**: ユーザーが前の投稿へスワイプできることをテスト
- **前提条件**:
  - ビューモデルが`WatchTimelineLoaded`状態
  - 前の投稿が存在する（現在のインデックスが0より大きい）
- **テスト手順**:
  1. `WatchTimelineScreen`をレンダリング
  2. 画面を下にスワイプ
- **期待結果**:
  - ビューモデルの`previousPost`メソッドが呼び出される
  - 前の投稿が表示される

##### テストケース: 閲覧履歴の記録
- **説明**: 投稿閲覧時に履歴が記録されることをテスト
- **前提条件**:
  - ビューモデルが`WatchTimelineLoaded`状態
- **テスト手順**:
  1. `WatchTimelineScreen`をレンダリング
  2. 5秒間待機
  3. 次の投稿へスワイプ
- **期待結果**:
  - ビューモデルの`recordCurrentPostView`メソッドが呼び出される

## 4. モックとスタブ

テスト実行にあたって、以下のモックとスタブを用意します：

1. **Mockito**を使用したモック：
   - ITimelineRepository
   - ITimelineFilterRepository
   - ITimelineViewHistoryRepository
   - IRecommendationRepository
   - TimelineRemoteDataSource
   - TimelineLocalDataSource
   - 各種ユースケース

2. **テストデータ**：
   - タイムラインのモックデータ
   - 投稿のモックデータ
   - フィルター設定のモックデータ
   - 閲覧履歴のモックデータ

## 5. テスト実施環境

- **単体テスト**：Flutter Test フレームワーク
- **ウィジェットテスト**：Flutter Widget Test フレームワーク
- **APIモック**：Mockito
- **テスト実行**：VS Code および CI/CD パイプライン（GitHub Actions）

## 6. テスト前提条件と事後条件

### 前提条件
- テスト用のモックデータが用意されている
- テスト環境が適切に設定されている
- 必要なモックオブジェクトが初期化されている

### 事後条件
- テスト後はすべてのリソースを適切に解放する
- テスト用のデータは消去する
- テスト結果を適切に記録する

## 7. テストの優先順位

1. **高優先度**：
   - リポジトリとデータソースの基本機能
   - ユースケースの基本機能
   - ビューモデルの状態管理
   - 主要UI機能（タイムライン表示、タイプ切替）

2. **中優先度**：
   - エラーハンドリング
   - オフライン機能
   - フィルタリング機能
   - ページネーション

3. **低優先度**：
   - UI細部の調整
   - アニメーション
   - パフォーマンス最適化