# 通知ドメイン追加テストケース

以下のテストケースはレビューによって特定された不足部分を補完するための追加テストです。

## 1. モデルテスト追加ケース

### NotificationModelテスト - 異常系強化

| テストケース | 入力パラメータ | 期待結果 |
|------------|--------------|---------|
| 不正なJSON形式 | ```{"id": "1", "user_id": "user1", "notification_type": "invalid_type", "created_at": "2023-01-01T12:00:00Z"}``` | FormatExceptionまたはArgumentErrorが発生すること |
| 必須フィールド欠落 | ```{"id": "1", "user_id": "user1", "title": "Test", "body": "Test Body"}``` | createdAtフィールドが必須のためExceptionが発生すること |
| 無効な日付フォーマット | ```{"id": "1", "user_id": "user1", "title": "Test", "body": "Test Body", "notification_type": "comment", "created_at": "invalid-date"}``` | FormatExceptionが発生すること |
| JSONからのnull値 | ```{"id": null, "user_id": null, "title": null, "body": null, "data": null, "read": null, "notification_type": null, "created_at": "2023-01-01T12:00:00Z"}``` | 適切なデフォルト値が適用されるか適切なエラー処理がされること |

### timeAgoゲッター - 境界値テスト

| テストケース | 入力パラメータ | 期待結果 |
|------------|--------------|---------|
| 59秒前 | NotificationModel(createdAt=現在時刻から59秒前) | "たった今" |
| 1分前 | NotificationModel(createdAt=現在時刻から1分前) | "1分前" |
| 59分前 | NotificationModel(createdAt=現在時刻から59分前) | "59分前" |
| 1時間前 | NotificationModel(createdAt=現在時刻から1時間前) | "1時間前" |
| 23時間前 | NotificationModel(createdAt=現在時刻から23時間前) | "23時間前" |
| 1日前 | NotificationModel(createdAt=現在時刻から1日前) | "1日前" |
| 6日前 | NotificationModel(createdAt=現在時刻から6日前) | "6日前" |
| 7日前 | NotificationModel(createdAt=現在時刻から7日前) | "7日前" |
| 8日前 | NotificationModel(createdAt=現在時刻から8日前) | DateFormat('yyyy/MM/dd').format(8日前の日付) |
| 未来の日付 | NotificationModel(createdAt=現在時刻から-1時間前) | 適切なエラー処理またはデフォルト表示がされること |

### NotificationSettingsModelテスト - 追加ケース

| テストケース | 入力パラメータ | 期待結果 |
|------------|--------------|---------|
| すべて無効の設定 | ```{"id": "1", "user_id": "user1", "comments_enabled": false, "highlights_enabled": false, "followers_enabled": false, "follow_reasons_enabled": false, "system_enabled": false, "updated_at": "2023-01-01T12:00:00Z"}``` | すべての通知タイプが無効化された設定オブジェクトが生成されること |
| フィールド名誤り | ```{"id": "1", "user_id": "user1", "comment_enabled": true, "highlight_enabled": true, "updated_at": "2023-01-01T12:00:00Z"}``` | デフォルト値が適用されること（誤った名前のフィールドは無視される） |
| copyWithで値の消去 | copyWith(commentsEnabled: null) | 元の値が維持されること |

## 2. リポジトリテスト追加ケース

### NotificationRepositoryテスト - 複合フィルター

| テストケース | 入力パラメータ | モック設定 | 期待結果 |
|------------|--------------|---------|---------|
| 複合フィルター:ユーザー+既読状態 | userId="user1", read=false | モックリモートデータソース: "user1"の未読通知のみ返す | 返された通知がすべて"user1"のものかつread=falseであること |
| 複合フィルター:ユーザー+タイプ | userId="user1", type=NotificationType.comment | モックリモートデータソース: "user1"のコメント通知のみ返す | 返された通知がすべて"user1"のものかつNotificationType.commentであること |
| 複合フィルター:既読状態+タイプ | read=false, type=NotificationType.follower | モックリモートデータソース: 未読のフォロワー通知のみ返す | 返された通知がすべてread=falseかつNotificationType.followerであること |
| 全条件フィルター | userId="user1", read=true, type=NotificationType.highlight | モックリモートデータソース: "user1"の既読ハイライト通知のみ返す | 返された通知がすべて条件に合致すること |

### 同時実行・リカバリーケース

| テストケース | 入力パラメータ | モック設定 | 期待結果 |
|------------|--------------|---------|---------|
| 既読→削除の連続操作 | 1) markAsRead("1") 2) deleteNotification("1") | モックリモートデータソース: 両方成功 | 両方の操作が正常に処理されること |
| リモート失敗→ローカル成功 | getNotifications() | モックリモートデータソース: エラー, モックローカルデータソース: 成功 | ローカルキャッシュからのデータが返されること |
| リモート・ローカル両方失敗 | getNotifications() | モックリモートデータソース: エラー, モックローカルデータソース: エラー | Left(Failure)が返されること |
| オフライン→オンライン復帰 | 1) getNotifications() 2) 接続復帰後getNotifications() | 1回目:isOffline=true, 2回目:isOffline=false | 1回目:キャッシュデータ, 2回目:リモートデータが返されること |
| トランザクション整合性 | updateNotificationSettings() が途中で失敗 | モックリモートデータソース: 成功後にエラー | 全体が失敗し、設定が更新前の状態に戻ること |

### リソース管理・長期実行テスト

| テストケース | 入力パラメータ | モック設定 | 期待結果 |
|------------|--------------|---------|---------|
| 大量データテスト | getNotifications(limit=1000) | モックリモートデータソース: 1000件の通知データ | メモリ使用量が許容範囲内であること |
| 長時間キャッシュ保持 | 1) getNotifications() 2) 長時間経過後getNotifications(オフライン) | isOffline=true, キャッシュ有効期限設定 | キャッシュポリシーに従って適切に動作すること |
| 接続タイムアウト | getNotifications() | モックリモートデータソース: タイムアウトエラー | Left(NetworkFailure)が返されること |
| リトライメカニズム | getNotifications() | モックリモートデータソース: 1回目失敗、2回目成功 | リトライ後に成功すること |

## 3. ユースケーステスト追加ケース

### 入力バリデーション

| テストケース | 入力パラメータ | モック設定 | 期待結果 |
|------------|--------------|---------|---------|
| 空のユーザーID | GetNotificationsUseCase(userId="") | - | 適切なValidationFailureが返されること |
| 無効な通知ID | MarkNotificationAsReadUseCase(notificationId="") | - | 適切なValidationFailureが返されること |
| nullパラメータ | GetNotificationsUseCase(userId=null) | - | 適切なNullParameterFailureが返されること |
| バリデーション後のリポジトリ呼び出し検証 | GetNotificationsUseCase(正当なパラメータ) | モックリポジトリ: 呼び出しを検証 | バリデーション後にリポジトリメソッドが呼ばれること |

### ビジネスルール・エラーハンドリング

| テストケース | 入力パラメータ | モック設定 | 期待結果 |
|------------|--------------|---------|---------|
| 通知設定に基づくフィルタリング | GetNotificationsUseCase(userId="user1") | モックリポジトリ: ユーザーの通知設定に基づいて通知フィルタリング | 無効化された通知タイプは含まれないこと |
| 接続エラーハンドリング | RegisterDeviceTokenUseCase(パラメータ) | モックリポジトリ: 一時的なネットワークエラー | 適切に処理されてTemporaryFailureが返されること |
| リトライロジック | GetNotificationsUseCase(パラメータ) | モックリポジトリ: 一度失敗後に成功 | リトライ後に成功結果が返されること |
| 自動トークンリフレッシュ | GetNotificationsUseCase(パラメータ) | モックリポジトリ: トークン期限切れエラー→リフレッシュ→成功 | トークンが自動更新され、最終的に成功結果が返されること |

### 同時実行・依存性テスト

| テストケース | 入力パラメータ | モック設定 | 期待結果 |
|------------|--------------|---------|---------|
| 依存ユースケース連携 | UpdateNotificationSettingsUseCase() | モックリポジトリ: 設定更新が他のユースケースに影響 | 関連するユースケースが正しく動作すること |
| 並行実行 | 複数のユースケースを同時実行 | モックリポジトリ: 競合条件をシミュレート | すべてのユースケースが適切に処理されること |
| 破壊的操作順序 | 1) DeleteNotificationUseCase() 2) MarkNotificationAsReadUseCase() | モックリポジトリ: 1が成功、2が存在しないエラー | 適切にエラー処理されること |

## 4. ビューモデルテスト追加ケース

### 状態遷移連鎖

| テストケース | 入力パラメータ | モック設定 | 期待結果 |
|------------|--------------|---------|---------|
| ローディング→エラー→再試行→成功 | 1) loadNotifications() 2) 失敗 3) 再試行 | 1) - 2) ユースケースがエラー 3) ユースケースが成功 | 最終的に NotificationListLoaded 状態になること |
| 通知設定変更→フィルタリング→表示更新 | 1) 設定更新 2) 通知リスト再取得 | 両方のユースケースが成功 | 設定に基づいてフィルタリングされた通知が表示されること |
| マルチユーザー切替 | 1) ユーザーA通知取得 2) ユーザーB通知取得 | 両方のユースケースが成功 | 適切にユーザー間でコンテキストが切り替わること |

### リソース管理・メモリリーク防止

| テストケース | 入力パラメータ | モック設定 | 期待結果 |
|------------|--------------|---------|---------|
| リスナー解放テスト | ビューモデル廃棄時 | - | すべてのリスナーが適切に解放されること |
| 大量データ処理 | loadNotifications(1000件) | モックユースケース: 1000件のデータ返却 | メモリ使用量が許容範囲内であること |
| ページング処理のメモリ使用量 | 複数回のloadNotifications() | モック: 各呼び出しで追加データ | 使用メモリが線形に増加しないこと |
| バックグラウンド処理の停止 | アプリがバックグラウンドに移行 | - | 不要な処理が停止されること |

### エラー回復・ロバストネス

| テストケース | 入力パラメータ | モック設定 | 期待結果 |
|------------|--------------|---------|---------|
| エラー状態からの回復 | 1) エラー状態 2) 再試行 | 2回目は成功 | 正常な状態に戻ること |
| 部分的失敗 | markAllAsRead() で一部失敗 | モックユースケース: 一部成功・一部失敗 | 成功した部分が反映され、エラーが報告されること |
| オフライン復帰後の同期 | 1) オフライン操作 2) オンライン復帰 | モックユースケース: オフライン保存→オンライン同期 | オフライン操作が同期されること |
| 無効なパラメータの処理 | 無効なID等を渡す | - | 適切にバリデーションエラーを処理し、UIに反映すること |

## 5. UIテスト追加ケース

### アクセシビリティテスト

| テストケース | 入力状態 | 操作 | 期待結果 |
|------------|---------|------|---------|
| スクリーンリーダー対応 | NotificationListLoaded(通知リスト) | アクセシビリティ検査 | すべての要素がスクリーンリーダーで正しく読み上げられること |
| コントラスト比 | テーマ設定 | 既読/未読通知のコントラスト比検査 | WCAG AAレベルを満たすこと (4.5:1以上) |
| キーボードアクセス | 通知一覧 | キーボードのみで操作 | すべての機能にキーボードでアクセスできること |
| フォントサイズ変更 | システムフォントサイズ変更 | 大きいフォント設定 | テキストが適切にスケーリングされ、レイアウトが崩れないこと |

### 異なる画面サイズ対応

| テストケース | 入力状態 | 操作 | 期待結果 |
|------------|---------|------|---------|
| スマートフォン表示 | 通知一覧 | 小画面サイズでのレンダリング | レイアウトが適切に調整されること |
| タブレット表示 | 通知一覧 | 中画面サイズでのレンダリング | 追加の情報が適切に表示されること |
| 横向き/縦向き切替 | 通知一覧 | デバイス回転 | コンテンツが適切に再レイアウトされること |
| 分割表示 | 通知一覧 | 画面の一部のみ使用 | UI要素が適切に配置されること |

### 複雑なユーザーフロー

| テストケース | 入力状態 | 操作 | 期待結果 |
|------------|---------|------|---------|
| 通知タップ→詳細表示→戻る | 通知一覧 | 1) 通知タップ 2) 詳細画面操作 3) 戻る | 全フローが正常に動作し、戻った後の状態が正しいこと |
| 通知設定変更→通知発生→フィルター適用 | 1) 設定画面 2) 通知一覧 | 1) 設定変更 2) 新通知到着 3) 一覧表示 | 変更された設定に従って通知が表示/非表示されること |
| 通知クリア→全通知表示→フィルター切替 | 通知一覧 | 1) すべて既読 2) フィルター切替 | 既読/未読フィルターが適切に動作すること |
| プッシュ通知タップ→該当画面表示 | バックグラウンド | プッシュ通知タップ | 正しい詳細画面に直接遷移すること |

### パフォーマンステスト

| テストケース | 入力状態 | 操作 | 期待結果 |
|------------|---------|------|---------|
| 大量通知レンダリング | 1000件の通知 | 画面表示とスクロール | フレームレートが60FPSを維持すること |
| 画像読み込み性能 | 画像付き通知多数 | 画面表示 | 画像読み込みによるUIブロッキングがないこと |
| バックグラウンド処理中のUI応答性 | 通知取得処理中 | UI操作 | メイン画面がブロックされないこと |
| 低スペックデバイス | 低リソース環境 | 画面表示と操作 | 許容可能なパフォーマンスであること |

## 6. 環境依存テスト

### ネットワーク状況テスト

| テストケース | 環境条件 | 操作 | 期待結果 |
|------------|---------|------|---------|
| 低速ネットワーク | 2G/3G接続 | 通知一覧取得 | 適切なローディング表示があり、最終的に表示されること |
| 不安定ネットワーク | 間欠的な接続 | 通知一覧取得/操作 | 適切にリトライし、エラー表示と回復機能があること |
| データセーバーモード | データセーバー有効 | 通知一覧取得 | 省データモードで適切に動作すること |
| オフライン→オンライン | 機内モード切替 | 操作試行→接続復帰 | オフラインキャッシュと再接続後の同期が機能すること |

### デバイス状態テスト

| テストケース | 環境条件 | 操作 | 期待結果 |
|------------|---------|------|---------|
| バッテリー消費 | 低バッテリーモード | バックグラウンド通知受信 | バッテリー消費が最小限に抑えられること |
| メモリ負荷 | 複数アプリ起動中 | 通知一覧表示 | メモリ使用量が許容範囲内であること |
| バックグラウンド制限 | バックグラウンド制限モード | 通知受信 | プッシュ通知が適切に配信されること |
| 長時間未使用後の起動 | 長時間経過後に起動 | アプリ起動 | 適切にトークン更新と通知同期が行われること |

## 7. セキュリティテスト

### データ保護テスト

| テストケース | 環境条件 | 操作 | 期待結果 |
|------------|---------|------|---------|
| 機密情報保護 | 通知内容に注意 | 通知表示 | 通知内容に機密情報が含まれないこと |
| ストレージ暗号化 | デバイスストレージ | キャッシュデータ検査 | 保存されたデータが適切に暗号化されていること |
| ログ出力セキュリティ | ログ出力設定 | エラー発生時の出力 | 機密情報がログに出力されないこと |
| スクリーンショット対策 | セキュアモード | スクリーンショット試行 | 必要に応じてスクリーンショット制限が機能すること |

### 認証・認可テスト

| テストケース | 環境条件 | 操作 | 期待結果 |
|------------|---------|------|---------|
| 認証切れ | アクセストークン期限切れ | 通知一覧取得 | 自動的にトークンリフレッシュし、操作が継続すること |
| 不正アクセス防止 | 他ユーザー通知へのアクセス試行 | APIリクエスト | 適切に拒否されること |
| ログアウト後アクセス | ログアウト状態 | キャッシュ通知へのアクセス試行 | 適切にブロックされること |
| トークン保存安全性 | セキュアストレージ | FCMトークン保存 | SecureStorageに適切に保存されること |

## 8. 実機・実環境テスト

### デバイス間差異テスト

| テストケース | 環境条件 | 操作 | 期待結果 |
|------------|---------|------|---------|
| iOS/Android差異 | 両プラットフォーム | 通知取得・表示 | 両方で一貫した体験が提供されること |
| 古いOSバージョン | 最小サポートOS | アプリ機能テスト | すべての機能が適切に動作すること |
| デバイス固有問題 | 特定メーカー端末 | 通知受信・表示 | メーカー固有の制限に適切に対応すること |
| プッシュ通知検証 | 実機での受信テスト | アプリバックグラウンド時 | 通知が適切に受信・表示・処理されること |

### 長期安定性テスト

| テストケース | 環境条件 | 操作 | 期待結果 |
|------------|---------|------|---------|
| 長期使用安定性 | 数日間の利用 | 定期的な通知操作 | メモリリークやクラッシュが発生しないこと |
| 日付変更対応 | 日付が変わる瞬間 | タイムスタンプ処理 | 日付切り替わり時も正常に機能すること |
| 設定変更耐性 | システム設定変更 | 通知許可設定変更など | 設定変更に適切に対応し、UIに反映されること |
| 双方向同期 | 複数デバイス同期 | 片方で既読処理 | 他デバイスにも状態が同期されること |