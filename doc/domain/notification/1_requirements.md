# 通知ドメイン要件定義

## 概要
通知ドメインは、アプリケーション内のイベントをユーザーに通知するための機能を提供します。ユーザーに関連する重要なアクティビティ（コメント、ハイライト、フォローなど）の通知管理とプッシュ通知の配信を担当します。

## 通知 (NOTIFICATION)

### 要素
- **UUID id** - 通知固有ID
- **UUID user_id** - 通知の受信者ID（プロフィール参照）
- **string title** - 通知タイトル
- **string body** - 通知本文
- **jsonb data** - 通知に関連する追加データ
- **boolean read** - 既読/未読ステータス
- **datetime created_at** - 通知作成日時

### 機能
- 通知の作成と送信
- 通知一覧の取得と表示
- 通知の既読/未読ステータス管理
- 通知設定の管理（通知タイプごとのオン/オフ切替）
- プッシュ通知の配信

### 要件
- 以下のイベントで通知を生成する：
  - コメント受信時
  - ハイライト受信時
  - 新規フォロワー（ファミリー）追加時
- 通知には既読/未読のステータスを持つ
- ユーザーは通知タイプごとに通知のオン/オフを設定できる
- 通知には関連するコンテンツへのナビゲーション情報を含む
- フォロー通知にはフォロー理由を表示

## プッシュ通知システム

### 要素
- **FCM/APNs トークン** - デバイス固有のプッシュ通知トークン
- **Expo Push Service** - プッシュ通知配信サービス
- **Edge Function** - 通知トリガー処理

### 機能
- FCM/APNsトークンの登録と更新
- DB変更に基づくプッシュ通知トリガー
- 通知ペイロードの生成と送信
- デバイスへのプッシュ通知配信

### 要件
- プッシュ通知のみでアプリ内通知は提供しない
- 通知の粒度はInstagramと同等レベル
- Expo Push Service（FCM/APNs）を利用した通知配信
- DB WebhookとEdge Functionの組み合わせによる実装
- プロフィールテーブルにFCMトークンを保存

## 非機能要件

### セキュリティ
- 通知には機密情報を含めない
- FCMトークンはセキュアに管理
- 通知データへのアクセスは認証済みユーザーのみに制限

### パフォーマンス
- 通知一覧の取得は200ms以内
- プッシュ通知の配信は遅延を最小限に抑える（目標：5秒以内）
- 通知処理はバックグラウンドで非同期に実行

### 拡張性
- 将来的な通知タイプの追加に対応可能な設計
- 通知フィルタリングやグループ化機能の拡張性を考慮
- 通知頻度や重要度に基づく最適化の余地を残す