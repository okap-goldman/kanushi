# 設定ドメインテスト仕様書

## 1. テスト概要

設定ドメインでは、ユーザーアプリケーションの利用体験をカスタマイズするための各種設定機能をテストします。テストは以下の主要カテゴリに分けて実施します：

1. 通知設定
2. アカウント設定
3. プライバシー設定
4. 表示設定
5. ブロックユーザー管理
6. ヘルプ・サポート機能

## 2. テスト対象コンポーネント

### データ層
- SettingsRepository
- BlockedUserRepository
- HelpRepository
- SettingsRemoteDataSource
- SettingsLocalDataSource
- BlockedUserRemoteDataSource
- HelpRemoteDataSource

### ドメイン層
- NotificationSettingsEntity
- AccountSettingsEntity
- PrivacySettingsEntity
- DisplaySettingsEntity
- BlockedUserEntity
- FAQCategoryEntity
- FAQEntity
- 各UseCase

### プレゼンテーション層
- SettingsViewModel
- NotificationSettingsViewModel
- AccountSettingsViewModel
- PrivacySettingsViewModel
- DisplaySettingsViewModel
- BlockedUsersViewModel
- 各画面とウィジェット

## 3. テスト範囲

### 単体テスト
- 各モデルのシリアライズ/デシリアライズ
- リポジトリの各メソッド
- ユースケースの機能検証
- ビューモデルの状態管理

### 統合テスト
- リポジトリとデータソースの連携
- ユースケースとリポジトリの連携
- ビューモデルとユースケースの連携
- 設定値の永続化と同期

### UI/E2Eテスト
- 設定画面の表示と操作
- 設定変更のリアルタイム反映
- デバイス設定との連携
- アクセシビリティコンプライアンス

## 4. テストケース定義

### 4.1 通知設定テスト

#### TC-NS-001: 通知設定の取得
**概要**: ユーザーの通知設定が正常に取得できることを確認する

**前提条件**:
- ユーザーが認証済み
- 通知設定がDBに保存されている

**テスト手順**:
1. 通知設定取得APIを呼び出す
2. レスポンスを検証する

**期待結果**:
- ステータスコード200が返却される
- 通知設定のJSONが正しいフォーマットで返却される
- コメント通知、ハイライト通知などの各設定値が正確である

#### TC-NS-002: 通知設定の更新
**概要**: 通知設定の更新が正常に処理されることを確認する

**前提条件**:
- ユーザーが認証済み
- 通知設定がDBに保存されている

**テスト手順**:
1. 通知設定更新APIを呼び出し、設定値を変更する
2. レスポンスを検証する
3. 再度設定を取得して変更が反映されていることを確認する

**期待結果**:
- ステータスコード200が返却される
- 成功メッセージが返却される
- 変更した設定値がDBに保存されている

#### TC-NS-003: 静かな時間の設定
**概要**: 通知の「静かな時間」設定が正常に処理されることを確認する

**前提条件**:
- ユーザーが認証済み

**テスト手順**:
1. 「静かな時間」を有効にし、開始/終了時間を設定する
2. レスポンスを検証する
3. 設定時間内と時間外で通知が適切に制御されることを確認する

**期待結果**:
- 「静かな時間」設定が正しく保存される
- 設定時間内は通常通知が抑制される
- 重要な通知（セキュリティ関連等）は「静かな時間」でも配信される

### 4.2 アカウント設定テスト

#### TC-AS-001: 言語設定の変更
**概要**: アプリの言語設定が正常に変更できることを確認する

**前提条件**:
- ユーザーが認証済み

**テスト手順**:
1. 言語設定を「日本語」から「英語」に変更する
2. アプリを再表示する

**期待結果**:
- 言語設定が保存される
- アプリのUIが英語表示に切り替わる
- 言語変更後もデータが正しく表示される

#### TC-AS-002: テーマ設定の変更
**概要**: アプリのテーマ設定が正常に変更できることを確認する

**前提条件**:
- ユーザーが認証済み

**テスト手順**:
1. テーマ設定を「ライト」から「ダーク」に変更する
2. UIの表示を確認する

**期待結果**:
- テーマ設定が保存される
- アプリのUIがダークモードに切り替わる
- すべてのUIコンポーネントがダークテーマに対応している

#### TC-AS-003: アカウント削除
**概要**: アカウント削除機能が正常に動作することを確認する

**前提条件**:
- ユーザーが認証済み

**テスト手順**:
1. アカウント削除プロセスを開始する
2. 削除理由を入力し確認コードを送信する
3. 削除完了後の状態を確認する

**期待結果**:
- アカウントが完全に削除される
- ユーザーのすべてのデータが削除される
- ログイン状態が解除される
- 削除後のアクセスが適切に制限される

### 4.3 プライバシー設定テスト

#### TC-PS-001: 位置情報共有設定
**概要**: 位置情報共有設定が正常に動作することを確認する

**前提条件**:
- ユーザーが認証済み
- 位置情報へのアクセス権限がある

**テスト手順**:
1. 位置情報共有設定をオフからオンに変更する
2. アプリの位置情報利用を確認する

**期待結果**:
- 位置情報共有設定が保存される
- アプリが設定に従って位置情報を利用する
- プライバシーポリシーが遵守される

#### TC-PS-002: コンテンツ公開範囲設定
**概要**: コンテンツ公開範囲設定が正常に動作することを確認する

**前提条件**:
- ユーザーが認証済み

**テスト手順**:
1. コンテンツ公開範囲を「公開」から「家族のみ」に変更する
2. 投稿の表示範囲を確認する

**期待結果**:
- 公開範囲設定が保存される
- 新規投稿が設定した公開範囲で作成される
- 既存の投稿は影響を受けない

#### TC-PS-003: データ収集設定
**概要**: データ収集設定が正常に動作することを確認する

**前提条件**:
- ユーザーが認証済み

**テスト手順**:
1. データ収集設定をオンからオフに変更する
2. アプリのデータ収集動作を確認する

**期待結果**:
- データ収集設定が保存される
- 設定がオフの場合、分析データが収集されない
- GDPRなどの規制に準拠している

### 4.4 表示設定テスト

#### TC-DS-001: 文字サイズ設定
**概要**: 文字サイズ設定が正常に動作することを確認する

**前提条件**:
- ユーザーが認証済み

**テスト手順**:
1. 文字サイズを「中」から「大」に変更する
2. UIの表示を確認する

**期待結果**:
- 文字サイズ設定が保存される
- アプリ内のテキストが大きくなる
- レイアウトが適切に調整される

#### TC-DS-002: モーション効果の設定
**概要**: モーション効果の設定が正常に動作することを確認する

**前提条件**:
- ユーザーが認証済み

**テスト手順**:
1. モーション効果（アニメーション削減）を有効にする
2. アプリのアニメーション動作を確認する

**期待結果**:
- モーション効果設定が保存される
- アプリのアニメーションが削減または無効化される
- パフォーマンスへの影響が最小限である

#### TC-DS-003: 高コントラストモード
**概要**: 高コントラストモードが正常に動作することを確認する

**前提条件**:
- ユーザーが認証済み

**テスト手順**:
1. 高コントラストモードを有効にする
2. UIの表示を確認する

**期待結果**:
- 高コントラスト設定が保存される
- UIのコントラストが向上する
- すべてのコンポーネントが高コントラストモードに対応している

### 4.5 ブロックユーザー管理テスト

#### TC-BU-001: ブロックユーザー一覧取得
**概要**: ブロックユーザー一覧が正常に取得できることを確認する

**前提条件**:
- ユーザーが認証済み
- ブロックしているユーザーが存在する

**テスト手順**:
1. ブロックユーザー一覧取得APIを呼び出す
2. レスポンスを検証する

**期待結果**:
- ステータスコード200が返却される
- ブロックユーザー一覧が正しいフォーマットで返却される
- ページネーションが正常に機能する

#### TC-BU-002: ユーザーのブロック
**概要**: ユーザーブロック機能が正常に動作することを確認する

**前提条件**:
- ユーザーが認証済み
- ブロック対象のユーザーが存在する

**テスト手順**:
1. ユーザーブロックAPIを呼び出す
2. レスポンスを検証する
3. ブロックしたユーザーの投稿やメッセージが表示されないことを確認する

**期待結果**:
- ブロックが成功する
- ブロックしたユーザーの情報がDBに保存される
- ブロックしたユーザーからのコンテンツが表示されない

#### TC-BU-003: ブロック解除
**概要**: ブロック解除機能が正常に動作することを確認する

**前提条件**:
- ユーザーが認証済み
- ブロックしたユーザーが存在する

**テスト手順**:
1. ブロック解除APIを呼び出す
2. レスポンスを検証する
3. ブロック解除後にユーザーのコンテンツが表示されることを確認する

**期待結果**:
- ブロック解除が成功する
- ブロックリストからユーザーが削除される
- ブロック解除したユーザーのコンテンツが再び表示される

### 4.6 ヘルプ・サポートテスト

#### TC-HS-001: FAQの取得
**概要**: FAQが正常に取得できることを確認する

**前提条件**:
- ユーザーが認証済み

**テスト手順**:
1. FAQ取得APIを呼び出す
2. レスポンスを検証する

**期待結果**:
- ステータスコード200が返却される
- FAQカテゴリとQ&Aが正しいフォーマットで返却される
- 検索フィルタが正常に機能する

#### TC-HS-002: お問い合わせ送信
**概要**: お問い合わせ機能が正常に動作することを確認する

**前提条件**:
- ユーザーが認証済み

**テスト手順**:
1. お問い合わせフォームに情報を入力する
2. 送信ボタンをクリックする
3. レスポンスを検証する

**期待結果**:
- お問い合わせが正常に送信される
- 問い合わせIDとステータスが返却される
- 確認メッセージが表示される

#### TC-HS-003: 利用規約の表示
**概要**: 利用規約が正常に表示されることを確認する

**前提条件**:
- ユーザーがアプリにアクセスしている

**テスト手順**:
1. 利用規約取得APIを呼び出す
2. レスポンスを検証する
3. 利用規約の表示を確認する

**期待結果**:
- 利用規約が正常に取得される
- フォーマットが適切に表示される
- バージョンと更新日時が表示される

## 5. エッジケースとバリデーションテスト

### 5.1 入力バリデーション

#### TC-VAL-001: 不正なQuiet Hours時間フォーマット
**概要**: 不正な時間フォーマットが適切に検証されることを確認する

**前提条件**:
- ユーザーが認証済み

**テスト手順**:
1. 静かな時間の開始/終了時間に不正な値（「25:00」など）を設定する
2. 設定保存を試みる

**期待結果**:
- エラーメッセージが表示される
- 不正な値が保存されない
- 適切なフォーマットの説明が表示される

#### TC-VAL-002: 言語設定の未サポート値
**概要**: サポートされていない言語コードのハンドリングを確認する

**前提条件**:
- ユーザーが認証済み

**テスト手順**:
1. サポートされていない言語コードを設定しようとする
2. レスポンスを検証する

**期待結果**:
- エラーメッセージが表示される
- デフォルト言語が適用される
- サポートされている言語の選択肢が提示される

### 5.2 エラーハンドリング

#### TC-ERR-001: オフライン時の設定変更
**概要**: オフライン時の設定変更動作を確認する

**前提条件**:
- ユーザーが認証済み
- デバイスがオフライン状態

**テスト手順**:
1. オフライン状態で設定変更を試みる
2. アプリの動作を確認する
3. オンライン復帰後の同期を確認する

**期待結果**:
- 設定変更がローカルに保存される
- オフライン状態を示す表示がされる
- オンライン復帰時に変更がサーバーと同期される

#### TC-ERR-002: サーバーエラー時の動作
**概要**: サーバーエラー発生時のエラーハンドリングを確認する

**前提条件**:
- ユーザーが認証済み
- サーバーがエラーを返す状況

**テスト手順**:
1. サーバーエラーを発生させる条件で設定変更を試みる
2. エラーレスポンスを検証する
3. アプリの動作を確認する

**期待結果**:
- 適切なエラーメッセージが表示される
- 元の設定状態が保持される
- リトライ機能が提供される

### 5.3 権限とセキュリティ

#### TC-SEC-001: 未認証時のアクセス制御
**概要**: 未認証ユーザーの設定アクセス制御を確認する

**前提条件**:
- ユーザーが未認証状態

**テスト手順**:
1. 未認証状態で設定APIにアクセスする
2. レスポンスを検証する

**期待結果**:
- 401 Unauthorizedエラーが返却される
- 適切なエラーメッセージが表示される
- ログイン画面へのリダイレクトが行われる

#### TC-SEC-002: 他ユーザー設定へのアクセス制御
**概要**: 他ユーザーの設定へのアクセス制御を確認する

**前提条件**:
- ユーザーが認証済み

**テスト手順**:
1. 他ユーザーのIDを使用して設定APIにアクセスする
2. レスポンスを検証する

**期待結果**:
- 403 Forbiddenエラーが返却される
- アクセス拒否メッセージが表示される
- セキュリティログに記録される

## 6. パフォーマンステスト

### 6.1 応答時間

#### TC-PERF-001: 設定画面の読み込み時間
**概要**: 設定画面の読み込み時間が許容範囲内であることを確認する

**前提条件**:
- ユーザーが認証済み

**テスト手順**:
1. 設定画面へのナビゲーション時間を計測する
2. 設定データの読み込み時間を計測する

**期待結果**:
- 設定画面が1秒以内に表示される
- すべての設定データが2秒以内に読み込まれる

#### TC-PERF-002: 設定変更の反映時間
**概要**: 設定変更が迅速に反映されることを確認する

**前提条件**:
- ユーザーが認証済み

**テスト手順**:
1. 設定変更後の反映時間を計測する
2. UI更新のスムーズさを評価する

**期待結果**:
- 設定変更が2秒以内に反映される
- UI更新がスムーズで遅延なく行われる

### 6.2 リソース使用効率

#### TC-PERF-003: メモリ使用量
**概要**: 設定画面のメモリ使用量を評価する

**前提条件**:
- アプリが起動している

**テスト手順**:
1. 設定画面遷移前後のメモリ使用量を計測する
2. 長時間の設定操作中のメモリリークを確認する

**期待結果**:
- メモリ使用量が許容範囲内である
- メモリリークが発生しない

## 7. アクセシビリティテスト

#### TC-ACC-001: スクリーンリーダー対応
**概要**: 設定画面がスクリーンリーダーで適切に操作できることを確認する

**前提条件**:
- スクリーンリーダーが有効になっている

**テスト手順**:
1. スクリーンリーダーを使用して設定画面をナビゲートする
2. 各設定項目が正しく読み上げられることを確認する
3. 操作が適切に行えることを確認する

**期待結果**:
- すべての設定項目が正しく読み上げられる
- すべての操作がスクリーンリーダーで実行できる

#### TC-ACC-002: 高コントラストモードの有効性
**概要**: 高コントラストモードが適切に機能することを確認する

**前提条件**:
- 高コントラストモードが有効

**テスト手順**:
1. 高コントラストモードでの表示を確認する
2. テキストと背景のコントラスト比をチェックする

**期待結果**:
- すべてのUIが高コントラストで表示される
- WCAGガイドラインに準拠したコントラスト比が確保されている

## 8. 互換性テスト

#### TC-COMP-001: 異なるOS・デバイスでの動作
**概要**: 異なるOS・デバイスで設定機能が正常に動作することを確認する

**前提条件**:
- 複数のOS(iOS/Android)と端末サイズの環境がある

**テスト手順**:
1. 各環境で設定画面を表示する
2. 設定変更を行い動作を確認する

**期待結果**:
- すべての環境で設定画面が適切に表示される
- 設定変更が正常に機能する
- デバイス固有の設定（通知許可など）と適切に連携する

#### TC-COMP-002: 異なるアプリバージョン間の設定互換性
**概要**: アップデート前後で設定が保持されることを確認する

**前提条件**:
- 旧バージョンのアプリがインストールされている

**テスト手順**:
1. 旧バージョンで設定を行う
2. 新バージョンにアップデートする
3. 設定が維持されていることを確認する

**期待結果**:
- すべての設定が新バージョンに引き継がれる
- 新しい設定項目にはデフォルト値が適用される
- 互換性のない設定は適切に変換または通知される

## 9. 多言語・国際化テスト

#### TC-I18N-001: 多言語表示
**概要**: 異なる言語設定での表示が適切であることを確認する

**前提条件**:
- アプリが複数言語をサポートしている

**テスト手順**:
1. 言語設定を変更する（日本語→英語）
2. 設定画面の表示を確認する

**期待結果**:
- すべてのテキストが選択した言語で表示される
- 文字化けやレイアウト崩れが発生しない
- 言語特有の長い文字列でもUIが破綻しない

#### TC-I18N-002: 地域固有の設定
**概要**: 地域に応じた設定オプションが提供されることを確認する

**前提条件**:
- 地域設定が行われている

**テスト手順**:
1. 異なる地域設定で設定画面を表示する
2. 地域固有の設定オプションを確認する

**期待結果**:
- 地域に関連する設定オプションが適切に表示される
- 日付/時刻フォーマットが地域に応じて調整される
- プライバシー関連設定が地域の法規制に準拠している

## 10. データ整合性テスト

#### TC-DATA-001: 設定の永続化
**概要**: アプリ再起動後も設定が保持されることを確認する

**前提条件**:
- 設定変更が完了している

**テスト手順**:
1. 設定を変更する
2. アプリを完全に終了し再起動する
3. 設定が保持されていることを確認する

**期待結果**:
- すべての設定がアプリ再起動後も維持される
- ローカルストレージとサーバー間で一貫性がある

#### TC-DATA-002: マルチデバイス同期
**概要**: 複数デバイス間で設定が同期されることを確認する

**前提条件**:
- 同一アカウントで複数デバイスにログインしている

**テスト手順**:
1. デバイスAで設定を変更する
2. デバイスBで同期後の設定を確認する

**期待結果**:
- デバイスB上の設定がデバイスAの変更内容で更新される
- 同期タイミングが適切である
- 競合が発生した場合は適切に解決される