# システムアーキテクチャドキュメント

## 1. システム概要

### 1.1 サービス名
**目醒め人のためのSNS**

### 1.2 コンセプト
音声を主軸とした深い共感・学び合い・自己表現を促すコミュニティSNS。Instagram/Threadsの気軽さとSpotify的「発見して聴く」体験を融合し、スピリチュアル領域のクリエイター経済を支援する。

### 1.3 対応プラットフォーム
- **モバイル**: iOS, Android (React Native)
- **デスクトップ**: Chrome, Safari (Web版)
- **Deep-Link**: 
  - モバイル: `kanushi://<path>`
  - Universal Link: `https://app.kanushi.tld/<path>`

## 2. アーキテクチャの原則

### 2.1 設計原則
1. **モバイルファースト**: モバイルアプリを主要プラットフォームとして設計
2. **音声中心**: 音声コンテンツの録音、再生、配信を最適化
3. **オフライン対応**: 重要機能のオフライン利用をサポート
4. **リアルタイム性**: ライブルームやチャット機能でのリアルタイム通信
5. **スケーラビリティ**: ユーザー増加に対応可能な設計
6. **セキュリティ**: E2E暗号化、WebAuthn対応

### 2.2 アーキテクチャパターン
- **クライアント-サーバー型**: モバイル/Webクライアントとバックエンドサービス
- **マイクロサービス志向**: Edge Functionsによる機能分離
- **イベントドリブン**: WebSocket/WebRTCによるリアルタイム通信
- **CDN活用**: 静的コンテンツの高速配信

## 3. 技術スタック

### 3.1 フロントエンド
- **モバイル**: React Native (iOS/Android)
- **Web**: React + TypeScript
- **状態管理**: Context API / Zustand
- **UI/UX**: カスタムコンポーネント + shadcn/ui
- **オフライン**: 暗号化キャッシュ (最大500MB)

### 3.2 バックエンド
- **BaaS**: Supabase
  - PostgreSQL (データベース)
  - Edge Functions (Deno)
  - Realtime (WebSocket)
  - Auth (認証)
  - Storage (ファイルストレージ)
- **AI/ML**: Gemini-2.5-Pro API

### 3.3 開発環境
- **開発サーバー**: npm run dev (Vite)
- **テストランナー**: Vitest
- **認証バイパス**: 開発効率化のための自動ログイン機能
  - 有効条件: ローカル環境 & 認証テスト以外
  - テストユーザー: testuser@kanushi.love
  - セキュリティ: 本番環境では無効化
### 3.4 インフラストラクチャ
- **CDN**: Cloudflare
- **オブジェクトストレージ**: Backblaze B2
- **TURN Server**: Cloudflare TURN
- **監視**: Prometheus + Loki + OpenTelemetry
- **CI/CD**: GitHub Actions

## 4. システムアーキテクチャ

### 4.1 全体構成図

```
┌─────────────────────────────────────────────────────────────┐
│                        Client Layer                          │
├─────────────────┬─────────────────┬─────────────────────────┤
│  iOS App (RN)   │ Android App (RN) │     Web App (React)     │
└────────┬────────┴────────┬────────┴──────────┬──────────────┘
         │                 │                   │
         └─────────────────┴───────────────────┘
                           │
                    ┌──────┴──────┐
                    │   API Gateway│
                    │  (Supabase)  │
                    └──────┬──────┘
                           │
    ┌──────────────────────┼──────────────────────┐
    │                      │                      │
┌───┴────┐         ┌───────┴───────┐      ┌──────┴──────┐
│Auth    │         │Edge Functions │      │ Realtime    │
│Service │         │   (Deno)      │      │ (WebSocket) │
└────────┘         └───────────────┘      └─────────────┘
    │                      │                      │
    └──────────────────────┼──────────────────────┘
                           │
                  ┌────────┴────────┐
                  │   PostgreSQL    │
                  │   (Supabase)    │
                  └────────┬────────┘
                           │
         ┌─────────────────┼─────────────────┐
         │                 │                 │
    ┌────┴────┐     ┌──────┴──────┐   ┌─────┴─────┐
    │Storage  │     │ LiveKit     │   │  Stripe   │
    │(B2+CF)  │     │  (WebRTC)   │   │ (Payment) │
    └─────────┘     └─────────────┘   └───────────┘
```

### 4.2 データフロー
1. **認証フロー**: Client → Auth Service → PostgreSQL
2. **コンテンツ投稿**: Client → Edge Functions → Storage → PostgreSQL
3. **音声ストリーミング**: Client → LiveKit → Client
4. **リアルタイム通信**: Client ↔ WebSocket ↔ Client
5. **決済フロー**: Client → Stripe → Webhook → Edge Functions

## 5. 主要コンポーネント

### 5.1 認証・ユーザー管理
- **認証方式**: Google OAuth, Apple Sign-In, Email + Passkey
- **セッション管理**: JWT (Supabase Auth)
- **複数アカウント**: 最大5アカウントの切り替えサポート

### 5.2 コンテンツ管理
- **投稿タイプ**: 音声、画像、テキスト
- **ストレージ**: 
  - メタデータ: PostgreSQL
  - メディアファイル: B2 + Cloudflare CDN
- **音声処理**: 
  - 録音: クライアントサイド
  - 音質向上: Edge Function (Deno)
  - 波形生成: Edge Function

### 5.3 リアルタイム機能
- **ライブルーム**: LiveKit (WebRTC)
  - 同時登壇: 最大10名
  - リスナー: 無制限
  - 録音: 自動アーカイブ対応
- **チャット**: Supabase Realtime
  - E2E暗号化
  - 既読機能

### 5.4 AI機能
- **AIチャット**: Gemini-2.5-Pro
- **パーソナルAIキュレーター**: 
  - CRON実行 (毎朝5:00 JST)
  - プレイリスト生成 (5-10件)
- **AI生成機能**: 
  - 商品説明文
  - MyRadio コンテンツ

### 5.5 EC機能
- **商品タイプ**: 物理商品、オンラインセッション、音声コンテンツ
- **決済**: Stripe Integration
- **手数料**: 
  - 通常商品: 7%
  - 光ギフト: 8% (クリエイター92%)

## 6. データアーキテクチャ

### 6.1 データベース設計
- **RDBMS**: PostgreSQL (Supabase)
- **主要テーブル**:
  - users (ユーザー情報)
  - posts (投稿)
  - audio_content (音声コンテンツ)
  - events (イベント)
  - products (商品)
  - transactions (取引)
  - messages (メッセージ)
  - live_rooms (ライブルーム)

### 6.2 データ保存ポリシー
- **ログ**: 90日間 (Loki)
- **AIチャットログ**: 10年間
- **オフラインキャッシュ**: 
  - 暗号化保存
  - 最大100件または500MB

### 6.3 検索インデックス
- **全文検索**: PostgreSQL Full-Text Search
- **対象**: ユーザー、投稿、ハッシュタグ

## 7. インフラアーキテクチャ

### 7.1 デプロイメント
- **環境**: 
  - Production
  - Staging
  - Development
- **デプロイ方式**: GitHub Actions → Supabase Edge Functions

### 7.2 スケーリング戦略
- **水平スケーリング**: Edge Functions の自動スケール
- **CDN**: 静的コンテンツのグローバル配信
- **データベース**: Supabase の自動スケーリング

### 7.3 バックアップ・災害復旧
- **RPO**: 5分以内
- **RTO**: 30分以内
- **バックアップ**: Supabase 自動バックアップ

## 8. セキュリティアーキテクチャ

### 8.1 通信セキュリティ
- **TLS**: v1.3
- **暗号化**: AES-256
- **E2E暗号化**: ダイレクトメッセージ

### 8.2 認証・認可
- **認証**: WebAuthn対応
- **認可**: Row Level Security (RLS)
- **APIキー管理**: 環境変数による管理

### 8.3 データ保護
- **個人情報**: 暗号化保存
- **オフラインデータ**: デバイス上で暗号化
- **決済情報**: Stripe による PCI DSS 準拠

## 9. パフォーマンスとスケーラビリティ

### 9.1 パフォーマンス目標
- **同時接続数**: 1,000以上
- **タイムライン応答時間 (p95)**: 2秒以内
- **音声ストリーミング遅延**: 100ms以下

### 9.2 最適化戦略
- **キャッシング**: 
  - CDN (静的コンテンツ)
  - クライアントサイドキャッシュ
- **遅延読み込み**: 
  - 画像の lazy loading
  - 無限スクロール
- **音声最適化**: 
  - プログレッシブダウンロード
  - 適応的ビットレート

## 10. 開発・運用アーキテクチャ

### 10.1 開発フロー
- **ブランチ戦略**: GitFlow
- **コード品質**: 
  - テストカバレッジ: 80%以上
  - Vitest によるユニットテスト
  - Storybook によるUIテスト
- **開発環境の認証**:
  - 自動ログイン: ローカル開発時に有効
  - テストユーザー: testuser@kanushi.love
  - 認証テスト時: 通常の認証フロー使用
  - 環境判定: NODE_ENV & TEST_FILE による制御

### 10.2 監視・観測性
- **ログ**: Loki (90日保存)
- **メトリクス**: Prometheus
- **トレーシング**: OpenTelemetry
- **アラート**: 主要メトリクスの閾値監視

### 10.3 運用
- **SLA**: 99.9% (月間)
- **メンテナンス**: 計画的メンテナンス時の事前通知
- **インシデント対応**: オンコール体制

## 11. 将来の拡張性

### 11.1 計画中の機能
- 動画投稿サポート
- AI画像生成
- 日程調整アシスト
- サブスクリプション (スタンプ)
- クラウドファンディング
- イマジネーション機能

### 11.2 アーキテクチャの拡張ポイント
- マイクロサービス化の推進
- グローバル展開に向けたマルチリージョン対応
- 機械学習パイプラインの構築
- ブロックチェーン統合の可能性

---

更新日: 2025-05-25