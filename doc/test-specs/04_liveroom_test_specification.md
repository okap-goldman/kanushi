# ライブルーム機能テスト仕様書

## 概要
本ドキュメントは、ライブルーム機能のTDD実装のための詳細なテスト仕様書です。
API・UI・結合・E2Eの4つのテストレベルで包括的なテストケースを定義します。

## テスト環境

### 使用フレームワーク
- `jest-expo@~53.0.0`
- `@testing-library/react-native@^13`
- `@testing-library/jest-native@^6`
- `react-native-reanimated/mock`

### テスト原則
- 可能な限りモックを使用しない実装
- リアルなデータフローでのテスト
- LiveKit SDK は統合テスト用のテストサーバーを使用

## 1. APIユニットテスト

### 1.1 ライブルーム作成API

**テストケース**: 正常なルーム作成
- **入力**: タイトル、最大登壇者数、録音設定
- **期待結果**: ルームID、ホストユーザー情報、タイトル、状態（preparing）、LiveKit連携情報を含むレスポンス

**テストケース**: 必須フィールド不足でエラー
- **入力**: タイトルなしのデータ
- **期待結果**: バリデーションエラー「タイトルは必須です」

**テストケース**: タイトルが空文字でエラー
- **入力**: 空文字のタイトル
- **期待結果**: バリデーションエラー「タイトルは必須です」

**テストケース**: 最大登壇者数が範囲外でエラー
- **入力**: 範囲外の登壇者数（上限10を超過）
- **期待結果**: 「最大登壇者数は1-10の範囲で入力してください」エラー

**テストケース**: 認証されていない場合はエラー
- **入力**: 未認証状態でのルーム作成
- **期待結果**: 「認証が必要です」エラー

### 1.2 ライブ開始・終了API

**テストケース**: 正常なライブ開始
- **入力**: 準備中のルームID
- **期待結果**: ステータスが「live」に変更、startedAtが設定されたルーム情報

**テストケース**: ホスト以外が開始しようとしてエラー
- **入力**: 別のユーザーからのルーム開始リクエスト
- **期待結果**: 「ホストのみがライブを開始できます」エラー

**テストケース**: 存在しないルームでエラー
- **入力**: 存在しないルームID
- **期待結果**: 「ルームが見つかりません」エラー

**テストケース**: 録音なしでライブ終了
- **入力**: ライブ中のルームID、投稿作成オプション=false
- **期待結果**: ステータスが「ended」に変更、endedAtが設定されたレスポンス、投稿は作成されない

**テストケース**: 録音ありでライブ終了
- **入力**: 録音中のルームID、投稿作成オプション=true
- **期待結果**: ステータスが「ended」に変更、endedAtが設定、作成された投稿IDが含まれたレスポンス

### 1.3 ルーム参加・退出API

**テストケース**: リスナーとして正常参加
- **入力**: アクティブなルームID、ユーザーID、ロール='listener'
- **期待結果**: LiveKitトークンとURLを含むレスポンス、リスナー権限のトークン生成、参加者テーブルに記録

**テストケース**: 終了済みルームに参加しようとしてエラー
- **入力**: 終了済みルームID
- **期待結果**: 「このルームは終了しています」エラー

**テストケース**: 存在しないルームへの参加エラー
- **入力**: 存在しないルームID
- **期待結果**: 「ルームが見つかりません」エラー

**テストケース**: 正常な退出
- **入力**: 参加中のルームID、ユーザーID
- **期待結果**: 参加者記録が更新され、退出時間が記録される

### 1.4 登壇リクエスト・承認API

**テストケース**: 正常な登壇リクエスト
- **入力**: アクティブなルームID、リスナーユーザーID
- **期待結果**: リクエストがデータベースに記録され、ホストに通知が送信される

**テストケース**: 既にリクエスト済みでエラー
- **入力**: 既にリクエスト済みのルームに対する登壇リクエスト
- **期待結果**: 「既に登壇リクエストを送信済みです」エラー

**テストケース**: 登壇リクエスト承認
- **入力**: リクエストID、承認=true
- **期待結果**: リクエストが承認済みとしてマークされ、ユーザーのロールが「speaker」に更新される

**テストケース**: 登壇リクエスト拒否
- **入力**: リクエストID、承認=false
- **期待結果**: リクエストが拒否としてマークされ、ユーザーに通知が送信される

**テストケース**: ホスト以外による承認操作でエラー
- **入力**: 非ホストユーザーによるリクエスト承認
- **期待結果**: 「ホストのみがリクエストを承認できます」エラー

### 1.5 ルームチャットAPI

**テストケース**: 正常なチャットメッセージ送信
- **入力**: ルームID、メッセージ内容
- **期待結果**: メッセージID、内容、送信者情報、タイムスタンプが含まれるレスポンス、WebSocketでのブロードキャスト

**テストケース**: URL共有付きメッセージ
- **入力**: ルームID、メッセージ内容、共有URL
- **期待結果**: メッセージとURLが正しく保存され、プレビュー情報が添付される

**テストケース**: 空のメッセージでエラー
- **入力**: ルームID、空の内容のメッセージ
- **期待結果**: 「メッセージ内容は必須です」エラー

**テストケース**: レート制限エラー
- **入力**: 短時間での多数のメッセージ送信（10件以上）
- **期待結果**: 「メッセージ送信レートが制限を超えています」エラー

**テストケース**: メッセージ履歴取得
- **入力**: ルームID、件数制限=20
- **期待結果**: 最新の20件のメッセージが時系列順で返される

### 1.6 ギフト送信API

**テストケース**: 正常なギフト送信
- **入力**: ルームID、ギフトタイプ、数量、受信者ID
- **期待結果**: ギフト送信記録が作成され、WebSocketでルーム全体に通知、受信者に通知

**テストケース**: ポイント不足エラー
- **入力**: 所持ポイントを超える高額ギフト
- **期待結果**: 「ポイントが不足しています」エラー

**テストケース**: 自分自身へのギフト送信エラー
- **入力**: 送信者と受信者が同じユーザーID
- **期待結果**: 「自分自身にギフトを送ることはできません」エラー

**テストケース**: ルーム参加者以外へのギフト送信エラー
- **入力**: ルームに参加していないユーザーへのギフト送信
- **期待結果**: 「指定されたユーザーはルームに参加していません」エラー

## 2. UIユニットテスト

### 2.1 ライブルーム作成ダイアログ

**テストケース**: ダイアログの表示
- **入力**: visible=true
- **期待結果**: タイトル、最大登壇者数設定、録音スイッチ、作成ボタン（初期状態は無効）が表示される

**テストケース**: 入力に応じたボタンの有効化
- **入力**: タイトル入力
- **期待結果**: 作成ボタンが有効化される

**テストケース**: 登壇者数の変更
- **入力**: 増加/減少ボタンのタップ
- **期待結果**: 登壇者数の値が適切に増減する

**テストケース**: 録音スイッチの切り替え
- **入力**: 録音スイッチのタップ
- **期待結果**: スイッチの状態が切り替わる

**テストケース**: ルーム作成の実行
- **入力**: 全フィールドを入力して作成ボタンをタップ
- **期待結果**: ルーム作成APIが呼ばれ、成功時にonSuccessコールバックが呼ばれる

**テストケース**: エラーハンドリング
- **入力**: API側でエラーが発生する状況
- **期待結果**: エラーメッセージが表示され、作成ボタンが再度有効になる

### 2.2 ライブルーム画面メイン

**テストケース**: ルーム情報の表示
- **入力**: roomId, userId, role='listener'
- **期待結果**: ルームタイトル、ホスト名、参加者数などのルーム情報が表示される

**テストケース**: リスナーとしての参加
- **入力**: roomId, userId, role='listener'
- **期待結果**: リスナーUIが表示され、登壇リクエストボタンが利用可能

**テストケース**: スピーカーとしての参加
- **入力**: roomId, userId, role='speaker'
- **期待結果**: スピーカーUIが表示され、マイクのミュートボタンが利用可能

**テストケース**: マイクのミュート切り替え
- **入力**: マイクボタンのタップ
- **期待結果**: マイク状態が切り替わり、アイコンが変化する

**テストケース**: ホストによるルーム終了
- **入力**: ホストユーザーでのルームメニュー操作
- **期待結果**: ルーム終了確認ダイアログが表示され、確定時にendRoomが呼ばれる

**テストケース**: 参加者によるルーム退出
- **入力**: 退出ボタンのタップ
- **期待結果**: 退出確認ダイアログが表示され、確定時にleaveRoomが呼ばれる

### 2.3 チャットコンポーネント

**テストケース**: チャットの表示
- **入力**: roomId, userId, userName
- **期待結果**: チャットメッセージリストと入力フィールドが表示される

**テストケース**: メッセージの送信
- **入力**: メッセージを入力して送信ボタンをタップ
- **期待結果**: sendChatMessageが呼ばれ、入力フィールドがクリアされる

**テストケース**: 空メッセージの送信防止
- **入力**: 空の入力フィールドで送信ボタンをタップ
- **期待結果**: メッセージが送信されない

**テストケース**: 長いメッセージの切り詰め
- **入力**: 300文字を超えるメッセージ
- **期待結果**: 300文字に切り詰められて送信される

**テストケース**: チャットのスクロール動作
- **入力**: 新しいメッセージの受信、手動スクロール
- **期待結果**: ユーザーが最下部にいる場合は自動スクロール、手動スクロール位置では自動スクロールなし

### 2.4 参加者リストコンポーネント

**テストケース**: 参加者リストの表示
- **入力**: roomId, hostId, isHost=false
- **期待結果**: ホスト、スピーカー、リスナーがそれぞれ適切に分類表示される

**テストケース**: ホストによる参加者アクション
- **入力**: isHost=true、リスナーの長押し
- **期待結果**: アクションメニューが表示され、「登壇者に昇格」などのオプションが選択可能

**テストケース**: スピーカーのミュート管理
- **入力**: isHost=true、スピーカーの長押し
- **期待結果**: ミュート/ミュート解除オプションが選択可能

**テストケース**: 登壇リクエストのUI
- **入力**: pendingRequests配列を含むprops
- **期待結果**: 登壇リクエスト中のユーザーが表示され、承認/拒否ボタンが利用可能

**テストケース**: ホストによる登壇リクエスト承認
- **入力**: 承認ボタンのタップ
- **期待結果**: onActionRequestコールバックが適切なパラメータで呼ばれる

**テストケース**: 接続品質インジケータ
- **入力**: 様々な接続品質を持つ参加者
- **期待結果**: 各参加者の接続品質に応じたインジケータが表示される

## 3. 結合テスト

### 3.1 WebRTC通信フロー

**テストケース**: ルーム作成から入室、WebRTC接続までの全体フロー
- **手順**:
  1. ルーム作成ダイアログを開き、ルーム情報を入力
  2. LiveKitルームが作成され、トークンが取得される
  3. LiveRoomScreenコンポーネントがレンダリングされる
  4. LiveKit SDKのRoom.connectが呼ばれる
  5. マイク権限リクエストが表示される
  6. 許可を与えると、マイクが有効化される
  7. ルーム画面が完全に表示される
- **期待結果**: 一連のフローが正常に動作し、WebRTC接続が確立される

**テストケース**: 参加者の入退室イベント処理
- **手順**:
  1. 複数のユーザーがルームに入室/退室
  2. LiveKit SDKの参加者イベントが発火
  3. 参加者リストが更新される
- **期待結果**: UI上の参加者リストがリアルタイムで更新される

### 3.2 リアルタイムチャット

**テストケース**: チャットメッセージの送受信と過去メッセージの読み込み
- **手順**:
  1. ルームに入室し、過去メッセージを読み込む
  2. WebSocketに接続する
  3. リアルタイムメッセージを受信
  4. メッセージを送信
- **期待結果**: 過去メッセージが表示され、新しいメッセージがリアルタイムで追加される

**テストケース**: メッセージ受信時の自動スクロール動作
- **手順**:
  1. チャットリストを表示
  2. ユーザーが手動でスクロール位置を変更
  3. 新しいメッセージを受信
- **期待結果**: ユーザーがスクロール位置を変更した場合は自動スクロールされない

## 4. E2Eテスト

### 4.1 ライブルームの完全なユーザーフロー

**テストケース**: ライブルームの完全なユーザーフロー
- **手順**:
  1. ホストとしてログイン
  2. ルーム作成ボタンをタップ
  3. ルーム情報を入力して作成
  4. マイク権限を許可
  5. ルーム画面でマイクをミュート/アンミュート
  6. 参加者タブとチャットタブを切り替え
  7. チャットメッセージを送信
  8. リスナーが参加（シミュレート）
  9. 登壇リクエストを承認
  10. ルームを終了
- **期待結果**: 全体フローが問題なく動作し、録音が保存される

**テストケース**: 接続の問題と回復フロー
- **手順**:
  1. ルームに参加
  2. ネットワーク接続を切断
  3. 接続警告が表示される
  4. ネットワーク接続を復元
  5. 接続が回復し、チャットを再開
- **期待結果**: ネットワーク問題から適切に回復し、機能が復帰する

**テストケース**: 同時複数ユーザーのインタラクション
- **手順**:
  1. ホストがルームを作成
  2. 複数のリスナーが参加
  3. 一斉メッセージを送信
  4. 一部のリスナーを登壇者に昇格
  5. 複数人が同時に発言
- **期待結果**: 複数ユーザーの同時利用が正常に機能する