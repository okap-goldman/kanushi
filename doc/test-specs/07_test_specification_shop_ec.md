# ショップ・EC機能 テスト仕様書

## 概要
本ドキュメントは、ショップ・EC機能のTDD（Test-Driven Development）実装のためのテスト仕様書です。
APIユニットテスト、UIユニットテスト、結合テスト、E2Eテストの4種類のテストケースを定義します。

## 1. APIユニットテスト

### 1.1 商品管理API

**テストケース**: GET /api/products - 商品一覧を正常に取得できること
- **入力**: API呼び出し
- **期待結果**: ステータス200、products配列、total件数を含むレスポンス

**テストケース**: GET /api/products?category=digital - カテゴリでフィルタリングできること
- **入力**: カテゴリパラメータ付きAPI呼び出し
- **期待結果**: 指定カテゴリに属する商品のみ返される

**テストケース**: GET /api/products?search=目醒め - 検索キーワードで商品を検索できること
- **入力**: 検索キーワードパラメータ付きAPI呼び出し
- **期待結果**: 検索キーワードに関連する商品のみ返される

**テストケース**: GET /api/products/[id] - 商品詳細を取得できること
- **入力**: 有効な商品ID
- **期待結果**: ステータス200、商品の詳細情報を含むレスポンス

**テストケース**: GET /api/products/[id] - 存在しないIDの場合404を返すこと
- **入力**: 存在しない商品ID
- **期待結果**: ステータス404、エラーメッセージ

### 1.2 カート操作API

**テストケース**: POST /api/cart/items - 商品をカートに追加できること
- **入力**: 商品ID、数量
- **期待結果**: ステータス200、更新されたカート情報

**テストケース**: PUT /api/cart/items/[id] - カート内商品の数量を更新できること
- **入力**: カートアイテムID、新しい数量
- **期待結果**: ステータス200、更新されたカート情報

**テストケース**: DELETE /api/cart/items/[id] - カートから商品を削除できること
- **入力**: カートアイテムID
- **期待結果**: ステータス200、更新されたカート情報

**テストケース**: GET /api/cart - カート情報を取得できること
- **入力**: API呼び出し
- **期待結果**: ステータス200、カート内商品リスト、合計金額情報

### 1.3 注文処理API

**テストケース**: POST /api/orders - 注文を作成できること
- **入力**: 配送先情報、支払い方法
- **期待結果**: ステータス201、注文番号、注文詳細を含むレスポンス

**テストケース**: POST /api/orders/payment - 支払い処理を実行できること
- **入力**: 注文ID、支払い情報
- **期待結果**: ステータス200、支払い処理結果

**テストケース**: GET /api/orders - 注文履歴を取得できること
- **入力**: API呼び出し
- **期待結果**: ステータス200、ユーザーの注文リスト

**テストケース**: GET /api/orders/[id] - 注文詳細を取得できること
- **入力**: 注文ID
- **期待結果**: ステータス200、注文の詳細情報

### 1.4 デジタルコンテンツ配信API

**テストケース**: GET /api/contents/[id] - 購入済みコンテンツへアクセスできること
- **入力**: 購入済みコンテンツID
- **期待結果**: ステータス200、コンテンツURL情報

**テストケース**: GET /api/contents/[id] - 未購入コンテンツはアクセス拒否されること
- **入力**: 未購入のコンテンツID
- **期待結果**: ステータス403、アクセス拒否メッセージ

**テストケース**: POST /api/contents/[id]/download - ダウンロードログが記録されること
- **入力**: コンテンツID
- **期待結果**: ステータス200、ダウンロード情報

## 2. UIユニットテスト

### 2.1 商品一覧コンポーネント

**テストケース**: 商品一覧が正しくレンダリングされること
- **入力**: 商品データ配列
- **期待結果**: 各商品カードが表示され、商品名、価格、画像が表示される

**テストケース**: カテゴリフィルターが機能すること
- **入力**: カテゴリ選択
- **期待結果**: 選択したカテゴリの商品のみ表示される

**テストケース**: 商品検索が機能すること
- **入力**: 検索キーワード入力
- **期待結果**: 検索条件に合致する商品のみ表示される

**テストケース**: 商品が0件の場合の表示
- **入力**: 空の商品配列
- **期待結果**: 「商品が見つかりません」メッセージが表示される

**テストケース**: 商品カードクリックで詳細画面に遷移すること
- **入力**: 商品カードクリック
- **期待結果**: onProductSelect関数が正しい商品IDで呼び出される

### 2.2 商品詳細コンポーネント

**テストケース**: 商品詳細が正しくレンダリングされること
- **入力**: 商品詳細データ
- **期待結果**: 商品名、詳細説明、価格、画像が表示される

**テストケース**: 数量選択UIが機能すること
- **入力**: 数量増減ボタンクリック
- **期待結果**: 表示数量が変化し、最小値（1）未満にはならない

**テストケース**: カートに追加ボタンが機能すること
- **入力**: 「カートに追加」ボタンクリック
- **期待結果**: onAddToCart関数が商品ID、選択数量で呼び出される

**テストケース**: バリエーション選択が機能すること
- **入力**: サイズ/カラー選択
- **期待結果**: 選択内容が更新され、価格や在庫状態が反映される

**テストケース**: 在庫切れ商品の表示と操作制限
- **入力**: 在庫切れ商品データ
- **期待結果**: 「在庫切れ」表示と購入ボタン無効化

### 2.3 カートコンポーネント

**テストケース**: カート内容が正しくレンダリングされること
- **入力**: カートアイテム配列
- **期待結果**: 各商品、数量、小計、合計金額が表示される

**テストケース**: 数量更新が機能すること
- **入力**: 数量変更
- **期待結果**: onUpdateQuantity関数が呼び出され、表示が更新される

**テストケース**: 商品削除が機能すること
- **入力**: 削除ボタンクリック
- **期待結果**: onRemoveItem関数が呼び出され、表示が更新される

**テストケース**: 空のカート表示
- **入力**: 空のカートデータ
- **期待結果**: 「カートは空です」メッセージとショップへのリンクが表示される

**テストケース**: レジに進むボタンが機能すること
- **入力**: 「レジに進む」ボタンクリック
- **期待結果**: onCheckout関数が呼び出される

### 2.4 注文フォームコンポーネント

**テストケース**: 配送先情報フォームが正しくレンダリングされること
- **入力**: 初期表示
- **期待結果**: 名前、住所、電話番号など必要な入力フィールドが表示される

**テストケース**: 必須フィールドのバリデーションが機能すること
- **入力**: 空のフォーム送信
- **期待結果**: エラーメッセージが表示され、送信がブロックされる

**テストケース**: 支払い方法選択が機能すること
- **入力**: 支払い方法選択
- **期待結果**: 選択に応じたUIが表示される（クレジットカード情報など）

**テストケース**: フォーム送信が機能すること
- **入力**: 有効なフォームデータ送信
- **期待結果**: onSubmit関数がフォームデータで呼び出される

## 3. 結合テスト

### 3.1 ショッピングフロー

**テストケース**: 商品検索から購入完了までの一連のフロー
- **手順**:
  1. 商品一覧表示
  2. 検索/フィルタリング
  3. 商品詳細表示
  4. カートに追加
  5. カート確認
  6. 注文情報入力
  7. 支払い処理
  8. 注文完了
- **期待結果**: エンドツーエンドで購入フローが完了する

**テストケース**: カート更新と注文金額の整合性
- **手順**:
  1. 複数商品をカートに追加
  2. 数量変更
  3. 一部商品を削除
  4. 合計金額確認
- **期待結果**: カート操作が反映され、金額計算が正確

### 3.2 決済処理

**テストケース**: クレジットカード決済フロー
- **手順**:
  1. カート確認
  2. 決済情報入力
  3. Stripeトークン化
  4. 決済実行
  5. 注文確定
- **期待結果**: Stripe連携が正しく機能し、注文が確定する

**テストケース**: 決済エラーハンドリング
- **手順**:
  1. 無効なカード情報入力
  2. エラー表示確認
  3. 正しい情報で再試行
- **期待結果**: エラーが適切に処理され、ユーザーが回復できる

### 3.3 デジタルコンテンツ配信

**テストケース**: デジタル商品購入と配信フロー
- **手順**:
  1. デジタル商品をカートに追加
  2. 購入処理完了
  3. 購入済みコンテンツアクセス
  4. ダウンロード実行
- **期待結果**: デジタルコンテンツが正しく配信される

## 4. E2Eテスト

### 4.1 フルショッピングジャーニー

**テストケース**: 新規ユーザーの商品購入フロー
- **手順**:
  1. ユーザー登録/ログイン
  2. 商品ブラウジング
  3. 商品詳細確認
  4. カートに追加
  5. 配送情報入力
  6. 支払い処理
  7. 注文確認メール受信
  8. マイページでの注文履歴確認
- **期待結果**: 完全なショッピングジャーニーが正常に完了する

### 4.2 エラーリカバリーシナリオ

**テストケース**: 在庫切れ発生時のユーザーフロー
- **手順**:
  1. 商品をカートに追加
  2. 購入処理中に在庫切れ発生
  3. 適切なエラーメッセージ表示
  4. 代替商品提案
- **期待結果**: ユーザーがエラーから回復できる経路が提供される

**テストケース**: 接続エラーからの回復
- **手順**:
  1. 購入プロセス中にネットワーク切断
  2. エラー表示
  3. 接続復旧後の処理再開
- **期待結果**: 処理状態が保持され、回復可能

## テスト実行計画

### CI/CD統合
- Pull Request時にAPIおよびUIユニットテスト自動実行
- リリース前に結合テストとE2Eテスト実行
- 本番デプロイ前の全テスト実行

### テストカバレッジ目標
- ユニットテスト: 90%以上
- 結合テスト: 主要フローの100%
- E2Eテスト: 主要ユーザーストーリーの100%