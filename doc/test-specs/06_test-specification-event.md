# イベント機能テスト仕様書

## 概要

本ドキュメントは「目醒め人のためのSNS」のイベント機能について、TDD（テスト駆動開発）で実装するための詳細なテスト仕様を定義します。

### 対象機能
- イベント作成（通常イベント・音声ワークショップ）
- イベント参加・決済（無料・有料）
- イベント投稿紐付け
- 音声ワークショップのライブルーム連携
- アーカイブ視聴（購入者限定）

### テスト環境
- **React Native**: Expo SDK 53
- **テストフレームワーク**: jest-expo@~53.0.0
- **テストライブラリ**: 
  - @testing-library/react-native@^13
  - @testing-library/jest-native@^6
  - react-native-reanimated/mock
- **モック方針**: 可能な限り不使用（実際のAPIとDBを使用）

## 1. APIユニットテスト

### 1.1 イベント作成API

#### 1.1.1 通常イベント作成

**テストケース**: 有効なデータでイベント作成成功
- **入力**: イベント名、説明、場所、開始・終了時間、料金情報
- **期待結果**: ステータス201、イベントID、作成者情報、イベント詳細を含むレスポンス

**テストケース**: 必須項目不足でエラー
- **入力**: 名前や開始時間のない不完全なイベントデータ
- **期待結果**: ステータス400、適切なバリデーションエラーメッセージ

**テストケース**: 過去の日時でエラー
- **入力**: 過去の開始日時を含むイベントデータ
- **期待結果**: ステータス400、「開始時間は現在以降である必要があります」エラーメッセージ

#### 1.1.2 音声ワークショップ作成

**テストケース**: 音声ワークショップ作成成功
- **入力**: 基本イベント情報、type='voice_workshop'、定員・録音設定
- **期待結果**: ステータス201、ワークショップ固有の設定を含むレスポンス

**テストケース**: 録音付きワークショップの作成
- **入力**: isRecorded=true、archive有効期限を含むデータ
- **期待結果**: 録音設定とアーカイブ情報を含むレスポンス

**テストケース**: 無効な定員設定でエラー
- **入力**: 最大定員が負数または1000人超
- **期待結果**: ステータス400、定員に関するエラーメッセージ

### 1.2 イベント参加API

**テストケース**: 無料イベント参加
- **入力**: イベントID
- **期待結果**: ステータス201、参加確認と参加者情報

**テストケース**: 有料イベント参加（決済処理）
- **入力**: イベントID、決済情報
- **期待結果**: ステータス201、決済確認と参加情報

**テストケース**: 定員超過エラー
- **入力**: 満員のイベントID
- **期待結果**: ステータス400、「定員に達しました」エラーメッセージ

**テストケース**: 二重参加防止
- **入力**: 既に参加済みのイベントID
- **期待結果**: ステータス400、「既に参加登録済みです」メッセージ

### 1.3 アクセス制御API

#### 1.3.1 音声ワークショップ入室制御

**テストケース**: 参加者の入室許可
- **入力**: ワークショップID、参加者トークン
- **期待結果**: ステータス200、LiveKitルーム接続情報

**テストケース**: 未参加者の入室拒否
- **入力**: 参加していないワークショップID
- **期待結果**: ステータス403、アクセス拒否エラー

#### 1.3.2 アーカイブ視聴制御

**テストケース**: 購入者のアーカイブアクセス許可
- **入力**: アーカイブID、購入者トークン
- **期待結果**: ステータス200、アーカイブコンテンツURL

**テストケース**: 未購入者のアーカイブ視聴拒否
- **入力**: 購入していないアーカイブID
- **期待結果**: ステータス403、「コンテンツへのアクセス権がありません」エラー

**テストケース**: アーカイブ期限切れエラー
- **入力**: 期限切れアーカイブID、有効な購入者トークン
- **期待結果**: ステータス410、「コンテンツの利用期限が切れています」エラー

## 2. UIユニットテスト

### 2.1 イベント作成フォーム

**テストケース**: 基本フォーム表示
- **入力**: 初期表示
- **期待結果**: 全必須フィールドと送信ボタンが表示される

**テストケース**: バリデーション表示
- **入力**: 空のフォーム送信
- **期待結果**: 適切なエラーメッセージが表示される

**テストケース**: イベントタイプ切り替え
- **入力**: タイプ選択変更
- **期待結果**: 選択に応じたフィールドセットが表示される

**テストケース**: 画像アップロード
- **入力**: イベント画像選択
- **期待結果**: プレビューが表示され、アップロード状態が反映される

**テストケース**: 送信状態とフィードバック
- **入力**: 有効なデータ送信
- **期待結果**: ローディング表示後、成功メッセージが表示される

### 2.2 イベント詳細画面

**テストケース**: イベント情報表示
- **入力**: イベントID
- **期待結果**: イベント名、説明、日時、場所などの情報が表示される

**テストケース**: 参加ボタン状態
- **入力**: 未参加の無料イベント
- **期待結果**: 参加ボタンが有効で表示される

**テストケース**: 参加済み表示
- **入力**: 既に参加登録済みのイベント
- **期待結果**: 「参加予定」表示と詳細情報が表示される

**テストケース**: 有料イベント表示
- **入力**: 料金設定のあるイベント
- **期待結果**: 料金情報と支払いオプションが表示される

**テストケース**: 定員表示
- **入力**: 定員設定のあるイベント
- **期待結果**: 残り枠数または「残りわずか」などの表示

### 2.3 イベント一覧・検索

**テストケース**: 一覧表示
- **入力**: 初期表示
- **期待結果**: イベントカードのリストが表示される

**テストケース**: フィルタリング
- **入力**: タイプ・日付フィルタ適用
- **期待結果**: フィルタ条件に合うイベントのみ表示

**テストケース**: 検索機能
- **入力**: キーワード検索
- **期待結果**: キーワードに関連するイベントが表示される

**テストケース**: カレンダー表示
- **入力**: カレンダービュー切替
- **期待結果**: 日付ごとにイベントが整理されて表示される

**テストケース**: 空の結果処理
- **入力**: 該当なし条件での検索
- **期待結果**: 「イベントが見つかりません」メッセージと推奨アクション

### 2.4 参加決済フロー

**テストケース**: 無料イベント参加フロー
- **入力**: 参加ボタンクリック（無料イベント）
- **期待結果**: 確認ダイアログ→成功メッセージ→参加状態更新

**テストケース**: 有料イベント決済フロー
- **入力**: 参加ボタンクリック（有料イベント）
- **期待結果**: 料金確認→決済画面→決済完了→参加状態更新

**テストケース**: 決済エラー処理
- **入力**: 無効なカード情報
- **期待結果**: エラーメッセージと再試行オプション

**テストケース**: キャンセルフロー
- **入力**: キャンセルボタンクリック
- **期待結果**: 確認ダイアログ→キャンセル処理→状態更新

## 3. 結合テスト

### 3.1 イベント作成から参加まで

**テストケース**: 通常イベント完全フロー
- **手順**:
  1. ユーザーログイン
  2. イベント作成フォーム入力
  3. イベント作成API呼び出し
  4. イベント詳細表示
  5. 別ユーザーでの参加処理
  6. 参加状態確認
- **期待結果**: 一連のフローが正常に完了

**テストケース**: 音声ワークショップ作成から入室まで
- **手順**:
  1. ワークショップ作成
  2. 参加者登録
  3. 開始時刻になったらライブルーム自動作成
  4. 参加者入室
  5. LiveKit連携確認
- **期待結果**: ワークショップが作成され、参加者が正常に入室できる

### 3.2 有料イベント決済フロー

**テストケース**: Stripe決済統合
- **手順**:
  1. 有料イベント表示
  2. 参加ボタンクリック
  3. Stripe Elements表示
  4. テスト用カード情報入力
  5. 決済処理
  6. 決済確認とイベント参加状態更新
- **期待結果**: Stripeとの連携が正常に機能し、決済が完了する

**テストケース**: 決済キャンセルと再試行
- **手順**:
  1. 決済画面表示
  2. キャンセル
  3. 再度参加ボタンクリック
  4. 決済完了
- **期待結果**: キャンセル後も再試行が可能

### 3.3 アーカイブ機能

**テストケース**: 録音からアーカイブ生成まで
- **手順**:
  1. 録音設定付きワークショップ作成
  2. ワークショップ実施
  3. 終了時の録音処理
  4. アーカイブ生成
  5. 購入者へのアクセス付与
- **期待結果**: 録音が正常に処理され、アーカイブとして利用可能になる

**テストケース**: アーカイブ視聴アクセス制御
- **手順**:
  1. 購入者ログイン→アクセス可能
  2. 非購入者ログイン→アクセス不可
  3. 期限切れアーカイブ→アクセス不可
- **期待結果**: 適切なアクセス制御が機能する

## 4. E2Eテスト

### 4.1 音声ワークショップの完全フロー

**テストケース**: ホストとしてのワークショップ実施
- **手順**:
  1. ユーザーがワークショップを作成
  2. 別ユーザーが参加登録
  3. 開始時刻になるとホストに通知
  4. ホストがルームを起動
  5. 参加者が入室
  6. 音声セッション実施
  7. 録音保存
- **期待結果**: ワークショップが問題なく実施され、録音が保存される

**テストケース**: 参加者としてのワークショップ体験
- **手順**:
  1. イベント検索
  2. ワークショップ詳細確認
  3. 参加登録（無料/有料）
  4. 開始通知受信
  5. 入室
  6. 音声セッション参加
  7. フィードバック送信
- **期待結果**: 参加者としての一連の体験が問題なく完了

### 4.2 決済エラーハンドリングE2E

**テストケース**: 決済エラーからのリカバリ
- **手順**:
  1. 有料イベント参加開始
  2. 無効なカード情報入力
  3. エラー表示
  4. 有効なカード情報で再試行
  5. 決済完了
- **期待結果**: エラーから回復して決済を完了できる

**テストケース**: ネットワークエラーからのリカバリ
- **手順**:
  1. 決済中にネットワーク切断
  2. エラー表示
  3. ネットワーク回復
  4. 再試行
  5. 決済完了
- **期待結果**: ネットワークエラーから回復して決済を完了できる

### 4.3 アクセス権限制御E2E

**テストケース**: 購入者専用コンテンツアクセス
- **手順**:
  1. 有料コンテンツの閲覧試行（未購入）→拒否
  2. 購入プロセス実施
  3. 購入後の閲覧試行→成功
- **期待結果**: 購入前後で適切なアクセス制御が機能する

**テストケース**: 複数デバイスでのアクセス検証
- **手順**:
  1. デバイスAで購入
  2. デバイスBで同じアカウントでログイン
  3. 購入コンテンツへのアクセス試行
- **期待結果**: 同一アカウントの複数デバイスでもアクセス可能

## 5. テストデータセットアップ

**テストユーザー**:
- イベント作成者（プレミアム会員）
- 一般参加者（無料会員）
- 有料参加者（クレジットカード登録済み）

**テストイベント**:
- 無料オフラインイベント
- 有料オフラインイベント
- 無料音声ワークショップ
- 有料音声ワークショップ（録音あり）

**テスト決済情報**:
- Stripeテストカード
- テスト用プロモーションコード

## 6. パフォーマンステスト

**テストケース**: 大規模イベント参加処理
- **入力**: 100人同時参加リクエスト
- **期待結果**: エラーなく処理され、参加者全員が登録される

**テストケース**: 音声ワークショップ同時接続
- **入力**: 最大定員での同時接続
- **期待結果**: 音声品質劣化なく全参加者が接続できる

## まとめ

### テスト種別
- **APIユニットテスト**: 個別エンドポイントの機能検証
- **UIユニットテスト**: コンポーネント単位の動作検証
- **結合テスト**: 複数サービス間の連携検証
- **E2Eテスト**: ユーザージャーニー全体の検証