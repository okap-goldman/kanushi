# ダイレクトメッセージ機能テスト仕様書

## 概要

本書はダイレクトメッセージ機能のTDD実装のためのテスト仕様書です。
APIユニットテスト、UIユニットテスト、結合テスト、E2Eテストの4種類のテストケースを定義します。

## 1. APIユニットテスト

### 1.1 DM会話開始API

**テストケース**: 新規DMスレッドを作成できる
- **入力**: 受信者ユーザーID
- **期待結果**: ステータスコード201、スレッドID、参加者情報、作成日時を含むレスポンス

**テストケース**: 既存スレッドが存在する場合は既存スレッドを返す
- **入力**: 既存スレッドがある受信者ユーザーID
- **期待結果**: 既存スレッドの情報を含むレスポンス

**テストケース**: 自分自身とのスレッド作成でエラー
- **入力**: 自分自身のユーザーID
- **期待結果**: 適切なエラーメッセージ「自分自身にDMを送ることはできません」

**テストケース**: 存在しないユーザーへのスレッド作成でエラー
- **入力**: 存在しないユーザーID
- **期待結果**: ユーザーが存在しないエラーメッセージ

### 1.2 メッセージ送信API

**テストケース**: テキストメッセージの送信
- **入力**: スレッドID、メッセージ内容
- **期待結果**: メッセージID、送信者情報、内容、タイムスタンプを含むレスポンス

**テストケース**: 画像添付メッセージの送信
- **入力**: スレッドID、メッセージ内容、画像ファイル
- **期待結果**: 画像URLを含むメッセージ情報

**テストケース**: E2E暗号化メッセージの送信
- **入力**: スレッドID、暗号化されたメッセージ内容
- **期待結果**: 暗号化されたメッセージが保存される

**テストケース**: 空のメッセージ送信でエラー
- **入力**: スレッドID、空の内容
- **期待結果**: バリデーションエラー「メッセージ内容は必須です」

### 1.3 メッセージ履歴取得API

**テストケース**: スレッドのメッセージ履歴取得
- **入力**: スレッドID、オプションのページネーションパラメータ
- **期待結果**: タイムスタンプ順のメッセージリスト

**テストケース**: ページネーションを使った履歴取得
- **入力**: スレッドID、ページサイズ=20、ページ番号=2
- **期待結果**: 指定ページのメッセージリスト、総件数情報

**テストケース**: 特定日付以降のメッセージのみ取得
- **入力**: スレッドID、開始日時
- **期待結果**: 指定日時以降のメッセージのみ

**テストケース**: 存在しないスレッドでエラー
- **入力**: 存在しないスレッドID
- **期待結果**: スレッドが見つからないエラー

### 1.4 既読状態管理API

**テストケース**: メッセージの既読状態更新
- **入力**: スレッドID
- **期待結果**: 未読メッセージが既読にマークされる

**テストケース**: 既読ステータスの一括更新
- **入力**: スレッドID
- **期待結果**: すべての未読メッセージが更新され、更新件数が返される

**テストケース**: 最終既読位置の更新
- **入力**: スレッドID、最終既読メッセージID
- **期待結果**: 最終既読位置が更新される

**テストケース**: 存在しないスレッドでエラー
- **入力**: 存在しないスレッドID
- **期待結果**: スレッドが見つからないエラー

## 2. UIユニットテスト

### 2.1 メッセージリストコンポーネント

**テストケース**: スレッド一覧の表示
- **入力**: onThreadSelect コールバック
- **期待結果**: スレッド一覧が表示され、各スレッドに最新メッセージと日時が表示される

**テストケース**: スレッド選択
- **入力**: スレッドアイテムのタップ
- **期待結果**: onThreadSelect コールバックが選択されたスレッド情報で呼ばれる

**テストケース**: スレッド検索
- **入力**: 検索キーワード入力
- **期待結果**: 検索結果に一致するスレッドのみ表示される

**テストケース**: 新規DM作成ボタン
- **入力**: 新規DMボタンタップ
- **期待結果**: onNewDM コールバックが呼ばれる

**テストケース**: スレッドのプルダウンリフレッシュ
- **入力**: プルダウン操作
- **期待結果**: スレッド一覧が再読み込みされる

**テストケース**: エラー状態の表示
- **入力**: API読み込みエラー
- **期待結果**: エラーメッセージと再試行ボタンが表示される

### 2.2 メッセージ詳細コンポーネント

**テストケース**: メッセージ履歴の表示
- **入力**: スレッド情報
- **期待結果**: 相手ユーザー情報とメッセージ履歴が表示される

**テストケース**: バックボタン処理
- **入力**: バックボタンタップ
- **期待結果**: onBackPress コールバックが呼ばれる

**テストケース**: メッセージの送信UI
- **入力**: メッセージ入力と送信ボタンタップ
- **期待結果**: onSendMessage コールバックが呼ばれ、入力フィールドがクリアされる

**テストケース**: 画像添付機能
- **入力**: 画像添付ボタンタップ、画像選択
- **期待結果**: 選択した画像がプレビュー表示され、送信時に画像情報が含まれる

**テストケース**: 日付セパレータ表示
- **入力**: 異なる日付のメッセージを含む履歴
- **期待結果**: 日付が変わる部分にセパレータが表示される

**テストケース**: エラー状態の表示と再試行
- **入力**: メッセージ読み込みエラー
- **期待結果**: エラーメッセージと再試行ボタンが表示される

### 2.3 メッセージ入力コンポーネント

**テストケース**: メッセージ入力と送信
- **入力**: テキスト入力と送信ボタンタップ
- **期待結果**: onSend コールバックが入力内容で呼ばれる

**テストケース**: 空のメッセージ送信防止
- **入力**: 空の状態で送信ボタンタップ
- **期待結果**: 送信処理が実行されない

**テストケース**: 無効状態の表示
- **入力**: disabled=true
- **期待結果**: 入力フィールドと送信ボタンが無効化される

**テストケース**: 画像選択と表示
- **入力**: 画像添付ボタンタップと画像選択
- **期待結果**: 選択した画像がプレビュー表示され、送信時に画像情報が含まれる

**テストケース**: 画像選択のキャンセル
- **入力**: 画像選択のキャンセル
- **期待結果**: 画像選択状態がリセットされる

**テストケース**: 選択済み画像のキャンセル
- **入力**: 画像選択後のキャンセルボタンタップ
- **期待結果**: 画像選択状態がリセットされる

**テストケース**: 送信中の状態表示
- **入力**: 送信処理中
- **期待結果**: ローディングインジケータが表示され、入力が無効化される

**テストケース**: テキスト入力サイズの自動調整
- **入力**: 複数行のテキスト入力
- **期待結果**: 入力フィールドの高さが自動調整される

## 3. 結合テスト

### 3.1 DMフロー

**テストケース**: DM全体フロー - スレッド作成から会話まで
- **手順**:
  1. DMリスト画面表示
  2. 新規DM作成
  3. ユーザー選択
  4. スレッド作成API呼び出し
  5. メッセージ詳細画面表示
  6. メッセージ送信
  7. リアルタイム更新
- **期待結果**: 一連のフローが正常に動作する

### 3.2 E2E暗号化

**テストケース**: エンドツーエンド暗号化のメッセージ送受信
- **手順**:
  1. 送信者がメッセージを作成
  2. 受信者の公開鍵で暗号化
  3. 暗号化されたメッセージをサーバーに送信
  4. 受信者がメッセージを取得
  5. 受信者の秘密鍵で復号
- **期待結果**: メッセージが正常に暗号化・復号される

**テストケース**: 暗号化・復号プロセスの完全性検証
- **手順**:
  1. 平文メッセージを作成
  2. 公開鍵で暗号化
  3. 暗号化メッセージを検証
  4. 秘密鍵で復号
  5. 復号されたメッセージが元の平文と一致するか確認
- **期待結果**: 復号されたメッセージが元の平文と完全に一致する

**テストケース**: 前方秘匿性を保証する鍵のローテーション
- **手順**:
  1. 初期鍵ペアを生成
  2. 初期鍵でメッセージを暗号化
  3. 新しい鍵ペアを生成
  4. 新しい鍵でメッセージを暗号化
  5. 両方のメッセージを復号
- **期待結果**: 鍵の更新後も以前のメッセージが復号可能

### 3.3 WebSocketリアルタイム

**テストケース**: WebSocketによるリアルタイムメッセージ受信
- **手順**:
  1. WebSocket接続を確立
  2. DMスレッドのチャンネルを購読
  3. 新しいメッセージをシミュレート
  4. メッセージリストの更新を確認
- **期待結果**: リアルタイムでメッセージが表示される

**テストケース**: WebSocketによるリアルタイム接続と購読
- **手順**:
  1. WebSocket接続を確立
  2. 接続状態の変化を確認
  3. チャンネル購読
  4. 切断処理
- **期待結果**: WebSocket接続のライフサイクルが正常に動作する

**テストケース**: 複数チャンネルの購読と解除
- **手順**:
  1. 複数のDMスレッドチャンネルを購読
  2. 各チャンネルにメッセージを受信
  3. 一部のチャンネルの購読を解除
  4. 購読状態を確認
- **期待結果**: チャンネルの購読と解除が正常に動作する

**テストケース**: WebSocket再接続の自動ハンドリング
- **手順**:
  1. 初期接続を確立
  2. 接続切断をシミュレート
  3. 自動再接続の動作を確認
  4. 再接続後のメッセージ受信を検証
- **期待結果**: 接続が切れた場合に自動的に再接続される

## 4. E2Eテスト

### 4.1 DMユーザーフロー

**テストケース**: DM基本フロー - スレッド作成からメッセージ送信まで
- **手順**:
  1. アプリにログイン
  2. DMタブに移動
  3. 新規メッセージボタンをタップ
  4. ユーザーを選択
  5. メッセージを入力して送信
  6. 送信したメッセージが表示されることを確認
  7. スレッド一覧に戻り、新しいスレッドが表示されることを確認
- **期待結果**: エンドツーエンドで基本的なDMフローが正常に動作する

**テストケース**: 画像送信と表示
- **手順**:
  1. 既存のDMスレッドを開く
  2. 画像添付ボタンをタップ
  3. 画像を選択
  4. キャプションを追加して送信
  5. 画像が表示されることを確認
  6. 画像をタップして拡大表示
- **期待結果**: 画像の送信、表示、拡大表示が正常に動作する

**テストケース**: 長時間の会話履歴とスクロール
- **手順**:
  1. 多数のメッセージがあるスレッドを開く
  2. 過去のメッセージを表示するためにスクロールアップ
  3. 「最新へ」ボタンをタップ
- **期待結果**: 長い会話履歴のナビゲーションが正常に動作する

**テストケース**: スレッド検索と管理
- **手順**:
  1. DMリスト画面で検索を実行
  2. スレッドをロングプレスしてアクションメニューを表示
  3. アーカイブ操作を実行
  4. アーカイブ済みスレッドの表示と復元
- **期待結果**: スレッドの検索、管理機能が正常に動作する

**テストケース**: 通知とリアルタイムメッセージ受信
- **手順**:
  1. 2台のデバイスでそれぞれ異なるユーザーとしてログイン
  2. デバイス2からデバイス1のユーザーにメッセージを送信
  3. デバイス1で通知を確認し、タップして会話を開く
  4. デバイス1から返信を送信
  5. デバイス2でリアルタイムにメッセージが表示されることを確認
- **期待結果**: 通知とリアルタイム更新が正常に動作する