# 認証・アカウント管理機能 テスト仕様書

## 1. 概要

### 1.1 目的
「目醒め人のためのSNS」の認証・アカウント管理機能のテスト駆動開発（TDD）のための詳細なテスト仕様書です。

### 1.2 対象機能
- Google OAuth認証
- Apple Sign-In認証  
- Email + Passkey認証
- 複数アカウント管理（最大5アカウント）
- プロフィール管理
- 通知設定管理

### 1.3 テスト種別
1. **APIユニットテスト**: システム内部の機能単体テスト（例: データベースへの保存、外部サービスとの連携など）
2. **UIユニットテスト**: 画面部品の単体テスト（例: ボタンの表示、入力フォームの動作など）
3. **結合テスト**: 複数の機能や画面が連携して正しく動作するかを確認するテスト
4. **E2Eテスト**: ユーザーがアプリを最初から最後まで利用するシナリオ全体をテスト

## 2. テスト環境・ツール

### 2.1 使用ライブラリ
（テスト実行に必要なライブラリが設定されています）

### 2.2 テスト設定
（テストの実行方法やカバレッジに関する設定がされています）

### 2.3 モック戦略
- **最小限のモック使用**: 可能な限り実際のシステムに近い環境でテストを行います。
- **外部サービスのみモック**: Google OAuth、Apple Sign-In、FCM（プッシュ通知サービス）など、外部のサービスとの連携部分のみ、テスト用に模擬的な動作をさせます。
- **ネットワークレスポンス**: ネットワーク通信の応答を模擬的に制御し、エラーや遅延などの状況を再現します。

## 2.4 開発環境での自動ログイン機能

### 概要
開発効率を向上させるため、ローカル環境では認証機能のテスト時を除いて、特定のテストユーザー（testuser@kanushi.love）で自動的にログインする機能を提供します。

### 動作条件
- **自動ログインが有効になる条件**:
  - ローカル環境での通常起動時（npm run dev）
  - 認証機能以外のテスト実行時（テストファイル名に'auth'が含まれない）
  - NODE_ENV = 'development' または 'local'
  
- **自動ログインが無効になる条件**:
  - 認証機能のテスト実行時（テストファイル名に'auth'が含まれる）
  - NODE_ENV = 'production'
  - 明示的に無効化フラグが設定されている場合

### テスト仕様
1. **ローカル開発時の自動ログイン**
   - ローカルでアプリを起動すると、testuser@kanushi.loveで自動ログインすること
   - テストユーザーが存在しない場合は自動的に作成されること
   - 通常のログイン画面をスキップしてホーム画面が表示されること

2. **認証機能テスト時の動作**
   - 認証関連のテスト（authService.test.ts、auth-flow.test.tsなど）実行時は自動ログインが無効化されること
   - 通常の認証フローが使用できること
   - 各種認証テストが正常に実行できること

3. **認証機能以外のテスト時の動作**
   - 投稿機能、フォロー機能などのテスト時は自動ログインが有効になること
   - テストの前提条件として認証済み状態から開始できること
   - テストの実行速度が向上すること

4. **環境切り替えテスト**
   - 実行コンテキストに応じて自動ログインの有効/無効が切り替わること
   - 本番環境では絶対に自動ログインが有効にならないこと

### 実装上の注意点
- 自動ログイン機能はauthServiceに実装し、以下の条件で制御する:
  ```typescript
  const isAuthTest = process.env.TEST_FILE?.includes('auth') || false;
  const isDevelopment = process.env.NODE_ENV === 'development' || process.env.NODE_ENV === 'local';
  const shouldAutoLogin = isDevelopment && !isAuthTest && !process.env.DISABLE_AUTO_LOGIN;
  ```
- テストユーザーのプロフィール情報は固定値を使用:
  - email: testuser@kanushi.love
  - displayName: 開発テストユーザー
  - profileText: これは開発用のテストアカウントです
- セキュリティのため、本番環境では絶対に有効化されないようにする
- テストランナー（vitest）の設定で、実行中のテストファイル名を環境変数に設定する

### 認証バイパス機能自体のテスト

認証バイパス機能の動作を保証するため、以下のテストケースを実装します：

1. **環境変数によるバイパス制御テスト**
   ```typescript
   // authBypass.test.ts
   describe('認証バイパス機能', () => {
     it('開発環境で認証バイパスが有効になること', async () => {
       process.env.NODE_ENV = 'development';
       process.env.TEST_FILE = 'post.test.ts';
       const result = await authService.checkAutoLogin();
       expect(result.shouldAutoLogin).toBe(true);
     });

     it('本番環境では認証バイパスが無効になること', async () => {
       process.env.NODE_ENV = 'production';
       const result = await authService.checkAutoLogin();
       expect(result.shouldAutoLogin).toBe(false);
     });
   });
   ```

2. **テストファイル名による制御テスト**
   ```typescript
   it('認証テスト実行時はバイパスが無効になること', async () => {
     process.env.NODE_ENV = 'development';
     process.env.TEST_FILE = 'authService.test.ts';
     const result = await authService.checkAutoLogin();
     expect(result.shouldAutoLogin).toBe(false);
   });

   it('認証以外のテストではバイパスが有効になること', async () => {
     process.env.NODE_ENV = 'development';
     process.env.TEST_FILE = 'postService.test.ts';
     const result = await authService.checkAutoLogin();
     expect(result.shouldAutoLogin).toBe(true);
   });
   ```

3. **自動ログイン実行テスト**
   ```typescript
   it('自動ログインで正しいテストユーザーが設定されること', async () => {
     process.env.NODE_ENV = 'development';
     process.env.TEST_FILE = 'post.test.ts';
     const user = await authService.performAutoLogin();
     expect(user.email).toBe('testuser@kanushi.love');
     expect(user.displayName).toBe('開発テストユーザー');
   });
   ```

4. **バイパス無効化フラグのテスト**
   ```typescript
   it('DISABLE_AUTO_LOGINフラグでバイパスを無効化できること', async () => {
     process.env.NODE_ENV = 'development';
     process.env.TEST_FILE = 'post.test.ts';
     process.env.DISABLE_AUTO_LOGIN = 'true';
     const result = await authService.checkAutoLogin();
     expect(result.shouldAutoLogin).toBe(false);
   });
   ```

これらのテストにより、認証バイパス機能が意図通りに動作することを保証できます。

## 3. APIユニットテスト
（システム内部の各機能が単体で正しく動作するかを確認します）

### 3.1 認証API テスト

#### 3.1.1 Google OAuth 認証

*   新規ユーザーがGoogleアカウントで正常に登録・ログインできること
*   既存ユーザーがGoogleアカウントで正常にログインできること
*   無効なGoogle認証情報でログインを試みた際にエラーが発生すること
*   ネットワーク接続がない場合にGoogle認証でエラーが発生すること
*   有効なリフレッシュトークン（認証情報を自動更新するための情報）で新しいアクセストークン（ログイン状態を維持するための情報）が取得できること
*   無効なリフレッシュトークンで認証情報の更新時にエラーが発生すること

#### 3.1.2 Apple Sign-In 認証

*   Apple ID認証が正常に完了し、ログインできること
*   Apple認証がユーザーによってキャンセルされた場合に、適切な処理が行われること

#### 3.1.3 Passkey 認証

*   パスキー（生体認証など）を使った新規登録が正常に完了すること
*   既に登録済みのメールアドレスでパスキー登録を試みた際にエラーが発生すること
*   パスキーを使ったログインが正常に完了すること

### 3.2 ユーザー管理API テスト

#### 3.2.1 プロフィール取得・更新

*   ログイン中のユーザーのプロフィール情報が正しく取得できること
*   ログインしていない状態でプロフィール取得を試みた際にエラーが発生すること
*   プロフィール情報（表示名、自己紹介文、居住地など）が正常に更新できること
*   無効なプロフィール情報（例: 空の表示名、長すぎる自己紹介文）で更新を試みた際にエラーが発生すること
*   他のユーザーと重複する表示名で更新を試みた際にエラーが発生すること

#### 3.2.2 メディアアップロード

*   プロフィール画像が正常にアップロードされ、URLが取得できること
*   不正なファイル形式（画像ではないファイルなど）のプロフィール画像をアップロードしようとした際にエラーが発生すること
*   ファイルサイズ制限を超えるプロフィール画像をアップロードしようとした際にエラーが発生すること
*   自己紹介音声が正常にアップロードされ、URLと再生時間が取得できること
*   音声時間制限（例: 5分）を超える自己紹介音声をアップロードしようとした際にエラーが発生すること

### 3.3 アカウント管理API テスト

#### 3.3.1 複数アカウント管理

*   ユーザーが所有する全てのアカウント情報が正しく取得できること（アクティブなアカウントが正しく表示され、切り替え順序が適切であること）
*   別のアカウントへの切り替えが正常に完了し、新しいアカウントでログイン状態になること
*   存在しないアカウントIDで切り替えを試みた際にエラーが発生すること
*   他のユーザーのアカウントに切り替えようとした際にエラーが発生すること
*   アカウント数が5つ未満の場合、新しいアカウントが正常に追加できること
*   アカウント数が5つに達している場合、新しいアカウントの追加時にエラーが発生すること

### 3.4 通知設定API テスト

*   ユーザーのデフォルトの通知設定（コメント、ハイライト、フォロー、ギフトなど）が正しく取得できること
*   通知設定（プッシュ通知の有効/無効、各通知項目のオン/オフ）が正常に更新できること
*   FCM（プッシュ通知サービス）トークンが正常に更新できること
*   FCMトークンを削除（プッシュ通知を無効化）できること

## 4. UIユニットテスト
（アプリの各画面や部品が単体で正しく動作するかを確認します）

### 4.1 認証画面コンポーネント

#### 4.1.1 ログイン画面

*   ログイン画面が正しく表示されること（Google、Apple、Email + Passkeyの認証方法が表示されること）
*   Googleログインボタンをタップすると認証処理が開始されること
*   認証処理中は画面にローディング表示がされ、ボタンが操作できないこと
*   認証に失敗した場合、ユーザーにエラーメッセージが表示されること
*   ネットワークエラーが発生した場合、ユーザーに適切なエラーメッセージが表示されること

#### 4.1.2 オンボーディング画面
（新規ユーザーがプロフィールなどを設定する一連の画面）

*   **表示名入力画面**
    *   表示名入力画面が正しく表示されること
    *   表示名を入力すると「次へ」ボタンが有効になること
    *   表示名が空の場合、「次へ」ボタンが無効のままであること
    *   表示名が文字数制限（例: 50文字）を超えた場合、警告メッセージが表示されること
*   **自己紹介文入力画面**
    *   自己紹介文入力画面が正しく表示されること
    *   自己紹介文の文字数カウンターが正しく動作すること
*   **プロフィール画像設定画面**
    *   プロフィール画像設定画面が正しく表示されること（カメラ撮影、ギャラリー選択のボタンがあること）
    *   画像を選択した後、選択した画像のプレビューが正しく表示されること
*   **自己紹介音声録音画面**
    *   自己紹介音声録音画面が正しく表示されること
    *   録音開始・停止ボタンが正しく動作し、録音中は状態が表示されること
    *   録音停止後、録音した音声のプレビューが再生できること
    *   録音時間が制限（例: 5分）を超える場合、警告メッセージが表示されること

### 4.2 プロフィール画面コンポーネント

#### 4.2.1 プロフィール表示

*   自分のプロフィール画面で、表示名、自己紹介文、プロフィール画像、自己紹介音声が正しく表示されること
*   他人のプロフィール画面で、フォローボタンが正しく表示されること
*   自分のプロフィール画面で、プロフィール編集ボタンが正しく表示されること
*   自己紹介音声の再生ボタンをタップすると音声が再生されること

#### 4.2.2 プロフィール編集

*   プロフィール編集画面が、現在のプロフィール情報で正しく初期表示されること
*   入力フィールド（表示名、自己紹介文など）の変更が画面に正しく反映されること
*   「保存」ボタンをタップするとプロフィール更新処理が実行されること
*   入力内容に問題がある場合（バリデーションエラー）、適切なエラーメッセージが表示されること

### 4.3 共通コンポーネント

#### 4.3.1 複数アカウント切替

*   アカウント一覧が正しく表示されること（各アカウントの表示名など）
*   現在アクティブなアカウントにチェックマークなどの表示がされること
*   別のアカウントを選択すると、そのアカウントへの切り替え処理が実行されること
*   「アカウントを追加」ボタンをタップすると、新規アカウント作成フローが開始されること
*   アカウント数が5つに達している場合、「アカウントを追加」ボタンが無効になること

## 5. 結合テスト
（複数の機能や画面が連携して、一連のユーザー操作が正しく動作するかを確認します）

### 5.1 認証フロー結合テスト

*   新規ユーザーがログイン画面からGoogle認証を行い、オンボーディングの全ステップを完了してホーム画面に到達できること
*   既存ユーザーがログイン画面からGoogle認証を行い、オンボーディングをスキップして直接ホーム画面に到達できること
*   認証エラーが発生した場合、ユーザーにエラーが通知され、ログイン画面に留まること

### 5.2 プロフィール管理結合テスト

*   プロフィール画面から編集画面へ遷移し、表示名や自己紹介文などの情報を更新して保存できること。保存後、プロフィール画面に戻り、更新内容が正しく反映されていること
*   プロフィール編集画面でプロフィール画像をアップロードし、保存できること。保存後、プロフィール画像が正しく更新されていること

### 5.3 複数アカウント管理結合テスト

*   ログイン中のユーザーが、プロフィールアイコンの長押しからアカウント切替画面を開き、新しいアカウントを追加してオンボーディングを完了できること。その後、追加されたアカウントに切り替え、さらに元のアカウントに切り替える一連の操作が正常にできること
*   アカウント数が5つに達している場合、アカウント切替画面で「アカウントを追加」ボタンが無効になり、上限に達している旨のメッセージが表示されること

## 6. E2Eテスト
（実際のユーザーがアプリを操作するのと同じように、最初から最後までの一連のシナリオをテストします）

### 6.1 新規ユーザー登録E2Eテスト

*   新規ユーザーがアプリを起動し、Google認証で登録、オンボーディングの全ステップ（表示名、自己紹介文、プロフィール画像、自己紹介音声、外部リンク設定）を完了し、ホーム画面に到達できること。また、登録したプロフィール情報が正しく表示されること
*   オンボーディングの途中でアプリを中断しても、再開時に中断したステップから続行され、入力済みの情報が保持されていること

### 6.2 認証・ログインE2Eテスト

*   事前に登録された既存ユーザーが、アプリ起動後にGoogle認証で正常にログインし、直接ホーム画面に到達できること。また、ログイン後に自分のプロフィールが正しく表示されること
*   ネットワーク接続がない状態でログインを試みた際に、エラーメッセージが表示されること。その後、ネットワークが復旧した際に再試行することで正常にログインできること
*   Apple Sign-Inボタンをタップし、Apple認証（Touch ID/Face IDなど）を完了することで、オンボーディングまたはホーム画面に到達できること

### 6.3 プロフィール管理E2Eテスト

*   ログイン中のユーザーが、プロフィール画面から編集画面へ遷移し、表示名、自己紹介文、プロフィール画像、自己紹介音声、外部リンクを全て更新して保存できること。保存後、プロフィール画面に戻り、更新内容が正しく反映されていること
*   プロフィール編集画面で、表示名が空の場合や文字数制限を超えた場合など、入力内容に問題がある際にバリデーションエラーメッセージが正しく表示されること

### 6.4 複数アカウント管理E2Eテスト

*   ログイン中のユーザーが、プロフィールアイコンの長押しからアカウント切替画面を開き、新しいアカウントを追加してオンボーディングを完了できること。その後、追加されたアカウントに切り替え、さらに元のアカウントに切り替える一連の操作が正常にできること
*   アカウント数が5つに達している場合、アカウント切替画面で「アカウントを追加」ボタンが表示されず、「アカウント上限に達しています」というメッセージが表示されること

### 6.5 通知設定E2Eテスト

*   設定画面から通知設定画面へ遷移し、プッシュ通知の有効/無効や、コメント、フォローなどの個別通知設定を変更して保存できること。保存後、設定が正しく反映されていることを確認できること

## 9. 実装計画更新

このテスト仕様書の作成により、実装計画書の以下のセクションを更新します：

- [x] 認証・アカウント管理のテスト仕様書作成（2025-05-25）
- [ ] Phase 1実装時にこのテスト仕様書に基づいてTDD実装
- [ ] テストカバレッジ80%以上の達成
- [ ] E2Eテストの自動化CI/CD統合
