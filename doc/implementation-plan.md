# 実装計画書

## 概要
本ドキュメントは「目醒め人のためのSNS」の機能実装計画を定義します。
要件定義書に基づき、優先度と依存関係を考慮した段階的な実装アプローチを採用します。

更新日: 2025-05-25

## 実装フェーズ概要

| フェーズ | 期間 | 主要目標 |
|---------|------|----------|
| Phase 1 | 1-2ヶ月 | 基盤構築（認証、DB、インフラ） |
| Phase 2 | 2-3ヶ月 | コア機能（投稿、フォロー、TL） |
| Phase 3 | 1-2ヶ月 | ソーシャル機能（DM、通知、検索） |
| Phase 4 | 2-3ヶ月 | エコシステム（ショップ、イベント、決済） |
| Phase 5 | 1-2ヶ月 | 高度な機能（ライブルーム、グループ） |
| Phase 6 | 1-2ヶ月 | AI/拡張機能（AIチャット、レコメンド） |

## ドキュメント作成状況

### シーケンス図
- [x] 01_auth_account.md - 認証・アカウント管理
- [x] 02_timeline_post.md - タイムライン・投稿機能
- [x] 03_follow.md - フォロー機能（2025-05-25作成）
- [x] 04_liveroom.md - ライブルーム機能（2025-05-25作成）
- [x] 05_direct_message.md - ダイレクトメッセージ機能（2025-05-25作成）
- [x] 06_event.md - イベント機能（2025-05-25作成）
- [x] 07_shop_ec.md - ショップ・EC機能（2025-05-25作成）
- [x] 08_group.md - グループ機能（2025-05-25作成）
- [x] 09_ai_search.md - AIチャット・検索機能（2025-05-25作成）
- [x] 10_stories.md - ストーリーズ機能（2025-05-25作成）
- [x] 11_notification.md - 通知機能（2025-05-25作成）

### テスト仕様書
- [x] 01_auth-account-test-spec.md - 認証・アカウント管理機能テスト仕様（2025-05-25作成）
- [x] 02_timeline-post-test-spec.md - タイムライン・投稿機能テスト仕様（2025-05-25作成）
- [x] 03_follow-function-test-spec.md - フォロー機能テスト仕様（2025-05-25作成）
- [x] 04_liveroom_test_specification.md - ライブルーム機能テスト仕様（2025-05-25作成）
- [x] 05_test_specification_dm.md - ダイレクトメッセージ機能テスト仕様（2025-05-25作成）
- [x] 06_test-specification-event.md - イベント機能テスト仕様（2025-05-25作成）
- [x] 07_test_specification_shop_ec.md - ショップ・EC機能テスト仕様（2025-05-25作成）
- [x] 08_group_test_spec.md - グループ機能テスト仕様（2025-05-25作成）
- [x] 09_test_specification_ai_search.md - AIチャット・検索機能テスト仕様（2025-05-25作成）
- [x] 11_notification_test_spec.md - 通知機能テスト仕様（未作成）
- [x] 10_stories_test_spec.md - ストーリーズ機能テスト仕様（2025-05-25作成）

### テスト実装状況
- [x] テストディレクトリ構造の作成完了（test/ui, test/api, test/integration, test/e2e）
- [x] テストコードの整理完了
- [x] テスト仕様書の非エンジニア向け修正完了
- [x] 今後のテスト実装方針（TDD推奨、カバレッジ目標80%以上）
- [x] 注文処理APIテスト実装（test/api/orderService.test.ts - 21テスト全て成功）
- [x] Issue #80: UIコンポーネントテスト実装完了（2025-05-25完了）
  - [x] PostCard.test.tsx - 投稿カードコンポーネントテスト
  - [x] AudioPlayer.test.tsx - 音声プレーヤーテスト
  - [x] CreatePost.test.tsx - 投稿作成ダイアログテスト
  - [x] DeleteConfirmDialog.test.tsx - 削除確認ダイアログテスト
  - [x] Timeline.test.tsx - タイムライン画面テスト
- [x] Issue #81: 統合テスト実装完了（2025-05-25完了）
  - [x] post-flow.test.ts - 投稿フロー全体の統合テスト
  - [x] like-comment-flow.test.ts - いいね・コメント連携テスト
  - [x] offline-sync-flow.test.ts - オフライン同期テスト
  - [x] push-notification-flow.test.ts - プッシュ通知連携テスト
- [x] APIテスト実装状況（2025-05-25時点）
  - [x] 20個のAPIテストファイル実装済み
  - [x] 主要API（post, follow, timeline, order, aiChat等）全て成功
  - [ ] authService.test.ts - 認証関連テストの修正が必要
- [x] Issue #83, #85, #86: ライブルーム機能テスト実装完了（2025-05-25完了）
  - [x] liveRoomService.test.ts - ライブルームAPIテスト（26テスト）
  - [x] CreateLiveRoomDialog.test.tsx - ルーム作成ダイアログテスト
  - [x] LiveRoomScreen.test.tsx - ライブルーム画面テスト
  - [x] LiveRoomChat.test.tsx - チャット機能テスト
  - [x] LiveRoomParticipants.test.tsx - 参加者リストテスト
  - [x] liveroom-navigation.test.ts - ナビゲーション統合テスト
- [x] Issue #82, #84, #94: フォロー機能品質向上完了（2025-05-25完了）
  - [x] 型チェック・Lint修正（className→style変換、Button型拡張）
  - [x] フォロー機能結合テスト実装（follow-flow.test.tsx）
  - [x] フォロー機能E2Eテスト実装（follow-journey.e2e.ts）
  - [x] UIコンポーネントテスト修正とセットアップ改善

## Phase 1: 基盤構築（1-2ヶ月）

### 目標
- システムの基盤となるインフラとアーキテクチャの確立
- 認証・ユーザー管理システムの実装
- 開発環境の整備

### 実装項目

#### 1.1 インフラストラクチャ
- [x] Supabaseプロジェクトのセットアップ（完了）
- [x] PostgreSQLデータベース設計・構築（8つのマイグレーションファイル作成済み）
- [x] Backblaze B2 + Cloudflare CDN設定（Edge Function実装済み）
- [x] 環境変数管理（開発/ステージング/本番）（.env.example作成済み）
- [x] CI/CD パイプライン構築（GitHub Actions）（3つのワークフロー作成済み）

#### 1.2 認証・アカウント管理
- [x] Supabase Auth設定（基本設定完了）
- [ ] Google OAuth連携
- [ ] Apple Sign-In連携
- [ ] Email + Passkey認証
- [x] JWT管理・リフレッシュトークン処理（Supabaseクライアント実装済み）
- [ ] 複数アカウント切替機能（最大5アカウント）（DBスキーマは準備済み）

#### 1.3 ユーザープロフィール
- [x] プロフィールテーブル設計（完了）
- [ ] プロフィール登録・編集API
- [ ] プロフィール画像アップロード
- [ ] 自己紹介音声アップロード
- [ ] オンボーディングフロー実装

#### 1.4 基本UI/UXコンポーネント
- [x] React Nativeプロジェクト初期設定（Expo使用）
- [x] 共通UIコンポーネント作成（shadcn/ui ベース）（/src/components/ui配下に実装済み）
- [x] ナビゲーション構造実装（FooterNav.tsxなど実装済み）
- [ ] Deep-Link対応基盤

### 成果物
- 認証可能なモバイルアプリ（iOS/Android）
- ユーザー登録・ログイン機能
- 基本的なプロフィール管理

## Phase 2: コア機能（2-3ヶ月）

### 目標
- SNSの中核となる投稿・タイムライン機能の実装
- フォロー機能によるソーシャルグラフの構築

### 実装項目

#### 2.1 投稿機能
- [ ] 投稿データモデル設計
- [ ] 音声投稿（録音・アップロード）
- [ ] 画像投稿（カメラ撮影・ギャラリー選択）
- [ ] テキスト投稿（最大10,000文字）
- [ ] ハッシュタグ機能（最大5個/投稿）
- [ ] 投稿削除機能

#### 2.2 メディア処理
- [ ] 音声ファイル処理（Edge Function）
- [ ] 音質向上処理
- [ ] 波形生成機能
- [ ] 画像リサイズ・最適化
- [ ] プレビュー生成（音声20-30秒）

#### 2.3 フォロー機能
- [ ] ファミリーフォロー（理由入力必須）
- [ ] ウォッチフォロー（理由不要）
- [ ] フォロー/フォロワー一覧
- [ ] アンフォロー機能
- [ ] フォロー/フォロワー一覧API追加（OpenAPI仕様に未定義）

#### 2.4 タイムライン
- [ ] ファミリータイムライン
- [ ] ウォッチタイムライン
- [ ] 無限スクロール実装
- [ ] プルトゥリフレッシュ
- [ ] ミニオーディオプレーヤー

#### 2.5 エンゲージメント機能
- [ ] いいね機能
- [ ] コメント機能
- [ ] ハイライト機能（理由入力必須）
- [ ] ブックマーク機能
- [ ] シェアURL生成

### 成果物
- 完全な投稿・閲覧機能
- フォロー関係に基づくタイムライン
- 基本的なソーシャルインタラクション

## Phase 3: ソーシャル機能（1-2ヶ月）

### 目標
- ユーザー間のコミュニケーション機能の充実
- リアルタイム性の向上

### 実装項目

#### 3.1 ダイレクトメッセージ
- [ ] DMスレッド管理
- [ ] テキストメッセージ送信
- [ ] 画像メッセージ送信
- [ ] 音声メモ送信
- [ ] E2E暗号化実装
- [ ] 既読機能

#### 3.2 通知システム
- [ ] 通知テーブル設計
- [ ] プッシュ通知基盤（FCM）
- [ ] 通知種別（コメント、ハイライト、フォロー、ギフト）
- [ ] 通知設定画面
- [ ] アプリ内通知表示

#### 3.3 検索機能
- [ ] PostgreSQL全文検索設定
- [ ] ユーザー検索
- [ ] 投稿検索
- [ ] ハッシュタグ検索
- [ ] 検索履歴管理

#### 3.4 ストーリーズ
- [ ] ストーリー投稿（画像のみ）
- [ ] 画像編集機能（テキスト、スタンプ、位置情報）
- [ ] ストーリー再投稿
- [ ] 24時間自動削除

#### 3.5 オフライン機能
- [ ] 後で見る機能
- [ ] オフラインキャッシュ管理（最大100件/500MB）
- [ ] 暗号化ローカルストレージ
- [ ] 自動削除（1ヶ月後）

### 成果物
- 完全なメッセージング機能
- リアルタイム通知
- 高度な検索機能
- ストーリーズ機能

## Phase 4: エコシステム機能（2-3ヶ月）

### 目標
- クリエイターエコノミーの基盤構築
- 収益化機能の実装

### 実装項目

#### 4.1 ショップ機能
- [ ] 商品データモデル設計
- [ ] 商品出品機能（物理/オンライン/音声）
- [ ] 音声即時出品（投稿から出品ボタン）
- [ ] AI商品説明文生成
- [ ] カート機能
- [ ] 複数商品まとめ買い

#### 4.2 決済システム
- [ ] Stripe統合
- [ ] 決済フロー実装
- [ ] Webhookハンドリング
- [ ] 手数料計算（7%）

#### 4.3 注文管理
- [x] 注文処理API実装（2025-05-25実装）
  - [x] 注文作成（複数商品対応、在庫管理）
  - [x] 注文ステータス管理（状態遷移検証）
  - [x] 注文キャンセル（在庫復元）
  - [x] 決済処理連携
  - [x] 販売者向け統計情報
- [x] 購入者向け注文履歴
- [x] 出品者向け取引管理
- [ ] 配送情報管理
- [ ] 売上ダッシュボード

#### 4.4 イベント機能
- [ ] イベント作成・編集
- [ ] 参加登録機能
- [ ] 参加費決済（Stripe）
- [ ] イベント投稿紐付け
- [ ] 音声ワークショップ対応

#### 4.5 光ギフト
- [ ] ギフト送信機能（300/600/1200円）
- [ ] クリエイター収益（92%）
- [ ] ギフト履歴管理
- [ ] 収益ダッシュボード

### 成果物
- 完全なEC機能
- イベント管理システム
- クリエイター収益化ツール

## Phase 5: 高度な機能（1-2ヶ月）

### 目標
- リアルタイムコミュニケーションの実現
- コミュニティ機能の強化

### 実装項目

#### 5.1 ライブルーム【優先度: H】✅ **完了**
- [x] LiveKit統合（WebRTC）（2025-05-25完了 Issue #83, #85, #86）
  - [x] LiveKit統合とサービス実装（liveRoomService.ts - 16テスト全て成功）
  - [x] Edge Functions実装（livekit-token, manage-livekit-room, process-audio）
  - [x] UIコンポーネント実装（CreateLiveRoomDialog, LiveRoomScreen, LiveRoomChat, LiveRoomParticipants）
  - [x] ナビゲーション統合（Deep Link対応、LiveRooms一覧画面）
  - [x] APIテスト・UIテスト・統合テスト・E2Eテスト実装完了
- [x] ルーム作成・管理（2025-05-25完了 - バリデーション、権限チェック、LiveKitルーム連携）
- [x] 同時登壇機能（最大15名）（2025-05-25完了 - スピーカー権限管理、音声送受信）
- [x] リスナー参加（無制限）（2025-05-25完了 - 音声受信専用、チャット参加可能）
- [x] 登壇リクエスト・承認（2025-05-25完了 - リクエスト管理、ホスト承認システム）
- [x] ルームチャット（2025-05-25完了 - リアルタイム、URL共有、レート制限）
- [x] URL共有・ピン機能（2025-05-25完了 - Deep Link、QRコード、SNS共有）
- [x] 録音・アーカイブ機能（2025-05-25完了 - 自動投稿化、音声処理）
- [x] Deep-Link生成（2025-05-25完了 - kanushi://room/{id}、Universal Link対応）
- [x] ギフト送信機能（2025-05-25完了 - ポイント制、リアルタイム通知）
- [x] セキュリティ機能（2025-05-25完了 - JWT認証、権限管理、レート制限）

#### 5.2 グループ機能
- [ ] グループ作成・管理
- [ ] メンバー管理（最大100名）
- [ ] 無料/有料グループ対応
- [ ] 月額サブスク機能（Stripe）
- [ ] グループチャット
- [ ] グループ専用タイムライン

### 成果物
- ライブ音声配信機能
- グループコミュニティ機能

## Phase 6: AI/拡張機能（1-2ヶ月）

### 目標
- AI機能による体験向上
- パーソナライゼーションの実現

### 実装項目

#### 6.1 AIチャット
- [x] AIチャットサービス実装（2025-05-25完了）
  - [x] メッセージ送受信API
  - [x] チャットセッション管理
  - [x] 履歴管理・クリア機能
- [x] コンテンツ検索統合（2025-05-25完了）
  - [x] 投稿/イベント/商品検索
  - [x] 統合検索API
- [x] AI機能拡張（2025-05-25完了）
  - [x] レコメンデーションAPI
  - [x] 感情分析API
  - [x] 要約生成API
- [x] UIコンポーネント（2025-05-25完了）
  - [x] AI検索バー
  - [x] AIチャットモーダル
  - [x] 検索画面統合
- [ ] Gemini-2.5-Pro API統合（Edge Function実装待ち）
- [ ] 設定変更相談機能

#### 6.2 パーソナルAIキュレーター
- [ ] CRON実行設定（毎朝5:00 JST）
- [ ] プレイリスト生成（5-10件）
- [ ] MyRadio機能
- [ ] オフラインキャッシュ対応

#### 6.3 レコメンデーション
- [ ] ヒットチャート（総合Top50、急上昇Top20）
- [ ] AI音声要約生成
- [ ] 推奨視聴者タグ生成
- [ ] レコメンドアルゴリズム

#### 6.4 分析機能
- [ ] ユーザー分析ダッシュボード
- [ ] 目醒め度スコア
- [ ] 必要な気づき提示
- [ ] ネクストアクション提案

### 成果物
- AIアシスタント機能
- パーソナライズされたコンテンツ配信
- ユーザー分析ツール

## 将来の拡張機能【優先度: L】

以下の機能は初期リリース後に検討：

- **動画投稿サポート**：現在はfalse、将来的に対応
- **AI画像生成**：テキストから画像生成
- **日程調整アシスト**：イベント・セッション日程調整
- **サブスク（スタンプ）**：クリエイター支援
- **クラウドファンディング**：プロジェクト支援
- **イマジネーション機能**：創造的なコンテンツ生成

## リスク管理

### 技術的リスク
1. **WebRTC接続の安定性**
   - 対策：Cloudflare TURNサーバーの活用
   - フォールバック機能の実装

2. **スケーラビリティ**
   - 対策：Edge Functionsの活用
   - CDNによる負荷分散

3. **オフライン同期**
   - 対策：段階的な同期処理
   - コンフリクト解決ロジック

### ビジネスリスク
1. **決済手数料**
   - 対策：適切な手数料設定
   - 複数決済手段の検討

2. **コンテンツモデレーション**
   - 対策：AI + 人的レビューの組み合わせ
   - コミュニティガイドラインの策定

## KPI設定

### Phase 2完了時
- DAU: 100+
- 投稿数/日: 50+
- 平均セッション時間: 10分+

### Phase 4完了時
- DAU: 1,000+
- 取引総額/月: 100万円+
- クリエイター数: 50+

### Phase 6完了時
- DAU: 5,000+
- AIチャット利用率: 30%+
- 収益化クリエイター: 200+

## まとめ

本実装計画は、段階的なアプローチにより、リスクを最小化しながら価値を早期に提供することを目指しています。各フェーズで動作可能なプロダクトをリリースし、ユーザーフィードバックを取り入れながら改善を続けます。

特に重要なのは：
1. **Phase 1-2**で基本的なSNS機能を確立
2. **Phase 3-4**でエンゲージメントと収益化を実現
3. **Phase 5-6**で差別化要素を強化

この計画により、約10-12ヶ月で全機能を実装し、スピリチュアル領域に特化した革新的なSNSプラットフォームを構築します。