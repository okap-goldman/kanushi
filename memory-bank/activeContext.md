# アクティブコンテキスト

## 現在の開発フォーカス

「目醒め人のためのSNS」プロジェクトは現在ベータ版の開発段階にあり、以下の機能実装に重点を置いています：

### 1. 投稿機能の実装

現在、投稿機能は最優先事項です。特に以下の投稿タイプの実装が必要です：

- **動画投稿**：
  - YouTubeとの連携
  - ユーザーのGoogleアカウントとの連携
  - 公開/限定公開設定
  - アプリ審査の観点からの動作検証

- **画像投稿**：
  - 複数画像のアップロード
  - Boxとの連携
  - レイアウト設定（1/3/4/9タイル）

- **音声投稿**：
  - 録音機能
  - PodBeanとの連携
  - 再生プレーヤーの実装

- **テキスト投稿**：
  - リッチテキストエディタ
  - Markdown対応

### 2. プロフィールページの実装

プロフィールページは、ユーザーの自己表現の中心となる重要な機能です：

- **メディア表示**：
  - 画像/動画のタイル表示
  - カスタムレイアウト

- **音声表示**：
  - 音声プレーヤー
  - 再生リスト

- **テキスト表示**：
  - テキスト投稿のリスト表示

- **ハイライト表示**：
  - ユーザーがハイライトした投稿の表示

### 3. ショップ機能の実装

ユーザーのプロフィールページに統合されるショップ機能：

- **商品一覧**：
  - 商品カード表示
  - フィルタリング

- **商品詳細**：
  - 商品情報表示
  - 購入フロー

- **決済連携**：
  - Stripe連携
  - 取引管理

## 最近の変更点

### 実装済み機能

1. **認証機能**：
   - Google OAuth 2.0による認証
   - Firebase Authenticationを使用した実装
   - 認証状態管理（AuthContext）
   - 開発環境での自動ログイン機能
     - NODE_ENV=developmentの場合、テストユーザーでの自動ログイン
     - 利用規約への自動同意
     - ログインページスキップ

2. **プロフィール設定**：
   - プロフィール情報の編集
   - Firebase Firestoreを使用したデータ保存
   - プロフィール編集モーダル

3. **フォロー機能**：
   - ファミリー/ウォッチフォロー
   - フォロー理由入力UI
   - フォロワー/フォロー一覧表示

4. **UI実装**：
   - タイムラインレイアウト
   - いいね/コメント/ハイライトボタン
   - ストーリー表示UI
   - プロフィールページのタブ表示

5. **動画投稿機能**：
   - 動画投稿フォームの実装
   - YouTubeとの連携（プレースホルダー実装）
   - 投稿フォームでの動画プレビュー
   - CreatePostDialogへの動画投稿タブ追加
   - 動画録画機能とアップロード機能の実装

### 進行中の作業

1. **投稿機能の強化**：
   - 画像投稿の実装
   - 音声投稿の実装
   - タイムライン表示の最適化

2. **外部サービス連携の強化**：
   - YouTube API連携の完全実装
   - Box API連携
   - PodBean API連携

3. **プロフィールページ**：
   - メディア表示のカスタムレイアウト
   - 投稿タブの実装

## 直近の課題

### 1. YouTube連携の検証

- **課題**：ユーザーのGoogleアカウントと連携して動画をアップロードする機能の実装は部分的に完了。アプリ審査（特にiOS）で承認されるかどうかの検証が必要
- **重要度**：最優先
- **アプローチ**：
  - プレースホルダー実装から本番実装への移行
  - 代替手段の検討（アプリ内でYouTubeアカウント選択など）
  - 類似アプリの調査
  - 実装済みの動画投稿機能のテスト

### 2. メディア表示の最適化

- **課題**：プロフィールページでの動画/画像の表示方法の最適化
- **重要度**：高
- **アプローチ**：
  - カスタムレイアウトの実装
  - パフォーマンス最適化
  - レスポンシブデザイン

### 3. アプリ審査対応

- **課題**：5月20日〜6月20日のリリースに向けたアプリ審査対応
- **重要度**：高
- **アプローチ**：
  - 必要最低限の機能実装
  - ガイドライン準拠の確認
  - プライバシーポリシーの整備

### 4. React Native + Expoへの移行準備

- **課題**：現在のWebアプリからモバイルアプリへの移行
- **重要度**：中
- **アプローチ**：
  - コードベースの互換性確認
  - 段階的な移行計画
  - モバイル固有の機能対応

## 次のステップ

短期的な目標（1-2週間）：

1. **動画投稿機能の完成**：
   - YouTube API連携の実装
   - 動画アップロードフロー
   - 公開/限定公開設定

2. **画像投稿機能の完成**：
   - Box API連携の実装
   - 複数画像アップロード
   - レイアウト設定

3. **プロフィールページのメディア表示**：
   - カスタムタイルレイアウト
   - レスポンシブ対応

中期的な目標（3-4週間）：

1. **ショップ機能の実装**：
   - 商品一覧/詳細表示
   - Stripe決済連携
   - 取引管理

2. **イベント機能の実装**：
   - イベント作成/参加フロー
   - イベント検索/フィルタリング
   - イベント関連投稿

3. **AIチャット機能の実装**：
   - DeepSeek R1 API連携
   - チャットUI
   - 質問制限機能

長期的な目標（リリースまで）：

1. **React Native + Expoへの移行**：
   - コードベースの移行
   - モバイル固有機能の実装
   - パフォーマンス最適化

2. **発見機能の実装**：
   - ユーザー分析
   - 地域活動表示
   - おすすめ投稿

3. **管理者機能の実装**：
   - モデレーション機能
   - 違反報告管理
   - ユーザー管理

## 現在の意思決定

1. **アプリ審査を優先**：
   - 5月20日〜6月20日のリリースに向けて、アプリ審査に通過するための最低限の機能実装を優先
   - 特にYouTube連携の審査通過可否を早期に検証

2. **段階的な機能実装**：
   - コア機能（投稿、プロフィール、フォロー）を優先
   - 拡張機能（イベント、ショップ、AI）は段階的に実装

3. **技術的負債の管理**：
   - React Native + Expoへの移行を見据えたコード設計
   - 再利用可能なコンポーネントの作成
   - 適切な抽象化レベルの維持

## 現在のリスク

1. **YouTube連携の審査リスク**：
   - アプリ審査でYouTube連携が承認されない可能性
   - 対策：代替手段の検討、早期検証

2. **スケジュールリスク**：
   - 限られた開発リソース（開発者1名）での納期達成
   - 対策：優先順位の明確化、MVPの定義

3. **技術的リスク**：
   - React Native + Expoへの移行に伴う互換性問題
   - 対策：段階的な移行、互換性テスト

4. **外部サービス依存リスク**：
   - YouTube、Box、PodBeanなど外部サービスへの依存
   - 対策：フォールバックメカニズム、サービス変更への対応計画

## 現在のフィードバック

1. **ユーザーフィードバック**：
   - 現段階ではベータテスターからのフィードバックは限定的
   - 今後のベータテストで収集予定

2. **技術的フィードバック**：
   - パフォーマンス最適化の必要性
   - モバイル対応の重要性

3. **ビジネスフィードバック**：
   - コア機能の優先実装
   - アプリ審査対応の重要性

## フロントエンドとバックエンドの統合

- **状態**: 実装済み
- **詳細**:
  - Express サーバーによるAPIハンドリングの実装
  - Viteフロントエンドとの統合
  - 同一ポート(4488)での実行設定
  - 開発環境でのnpm run devコマンドによる統合サーバー起動

## npm run dev エラーの修正

- **状態**: 修正済み
- **詳細**:
  - TypeScriptファイル拡張子のESMモード対応（tsx使用）
  - process.envをimport.meta.envに置き換え（Vite互換）
  - Supabase環境変数の設定
  - APIエンドポイントの正常動作確認

## 技術的更新

### Playwright MCPの設定

このプロジェクトでは、他のプロジェクトとの競合を避けるためにプロジェクト固有のPlaywright MCPを設定しました：

#### 特徴

- カスタムポート: 4455を使用（デフォルトとの競合を回避）
- 専用プロファイルディレクトリ: `/tmp/kanushi-playwright-profile`
- 専用ブラウザディレクトリ: `/tmp/kanushi-playwright-browsers`

#### 設定ファイル

- `playwright.config.mcp.ts`: プロジェクト固有のPlaywright設定
- `mcp.config.json`: MCP固有の設定
- `start-mcp.sh`と`stop-mcp.sh`: 起動/停止用スクリプト
- `package.json`: `playwright:mcp`スクリプト追加

この設定により、他のMCPプロセスと競合せずに動作検証ができるようになり、開発効率が向上しました。

#### 使用方法

1. MCPを起動する:
```bash
# スクリプト方式
./start-mcp.sh

# npm方式
npm run playwright:mcp
```

2. MCPを停止する:
```bash
./stop-mcp.sh
```

3. 自動プロセス管理:
   - 既存プロセスの検出と停止
   - 専用のシングルトンロック管理
   - 環境変数の自動設定

#### トラブルシューティング

- ポート競合: `lsof -i:4455` で確認
- プロファイルロック: `rm /tmp/kanushi-playwright-profile/SingletonLock`
- プロセス競合: `ps aux | grep playwright` で確認
